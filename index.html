<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- DataLabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- Export libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-blue-600 text-white p-6 shadow">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">

    <!-- باقي المحتوى (KPIs, Charts, Tables) ... -->

    <!-- Vehicle Efficiency Analysis -->
    <div id="vehAnalysisBox" class="bg-white rounded-xl shadow overflow-hidden mt-6">
      <div class="p-4 border-b">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <label class="text-sm">بحث:</label>
          <input id="vaSearch" type="text" placeholder="ابحث..." class="border rounded-lg px-3 py-1">
          <label class="text-sm">من سنة تصنيع:</label>
          <input id="vaYear" type="number" placeholder="2000" class="w-24 border rounded-lg px-3 py-1">

          <!-- ✅ فلتر الترتيب الجديد -->
          <label class="text-sm">ترتيب حسب:</label>
          <select id="vaSort" class="border rounded-lg px-3 py-1">
            <option value="">بدون ترتيب</option>
            <option value="eff">نسبة الاستغلال (تنازلي)</option>
            <option value="year">سنة التصنيع (تنازلي)</option>
            <option value="capTon">السعة النظرية (تنازلي)</option>
          </select>
        </div>
        <h3 class="font-semibold">تحليل كفاءة المركبات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">رقم المركبة</th>
              <th class="px-4 py-2">سنة التصنيع</th>
              <th class="px-4 py-2">السعة (م³)</th>
              <th class="px-4 py-2">السعة النظرية (طن)</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">الوزن المنقول (طن)</th>
              <th class="px-4 py-2">نسبة الاستغلال %</th>
            </tr>
          </thead>
          <tbody id="vehAnalysisTable"></tbody>
        </table>
      </div>
    </div>

    <!-- باقي الجداول (سجل الرحلات وغيره) ... -->

  </main>

<script>
/* ===== إعدادات الأعمدة ===== */
const COL = {
  month: "الشهر",
  date: "تاريخ التوزين الثاني",
  driver: "السائق",
  weight: "صافي التحميل",
  vehicle: "رقم المركبة"
};

/* ===== روابط CSV ===== */
const CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";
const VEH_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2001178330&single=true&output=csv";

let ALL = [];
let VIEW = [];
let VEHICLES=[];

/* ===== تحليل كفاءة المركبات ===== */
function renderVehAnalysis(){
  const tb=document.getElementById("vehAnalysisTable");
  if(!tb) return;
  tb.innerHTML="";
  if(VEHICLES.length===0||VIEW.length===0) return;

  const byVehicleWeight={};
  const byVehicleTrips={};
  VIEW.forEach(r=>{
    const v=r[COL.vehicle]||"مجهولة";
    byVehicleWeight[v]=(byVehicleWeight[v]||0)+toNumber(r[COL.weight]);
    byVehicleTrips[v]=(byVehicleTrips[v]||0)+1;
  });

  const vaQuery=document.getElementById("vaSearch").value.toLowerCase();
  const vaYear=parseInt(document.getElementById("vaYear").value||"0");
  const vaSort=document.getElementById("vaSort").value;

  let rows=[];
  VEHICLES.forEach(vh=>{
    const vnum=vh["رقم المركبة"];
    if(vaQuery && !vnum.toLowerCase().includes(vaQuery)) return;

    const year=vh["سنة التصنيع"]||"";
    if(vaYear && parseInt(year||"0")<vaYear) return;

    const capM3=toNumber(vh["سعة المركبة بالمتر المكعب"]);
    const dens=toNumber(vh["كثافة التحميل"]);
    const capTon=capM3*dens;
    const trips=byVehicleTrips[vnum]||0;
    const wkg=byVehicleWeight[vnum]||0;
    const wton=wkg/1000;
    const eff=trips>0&&capTon>0?(wton/(trips*capTon))*100:0;

    rows.push({vnum,year,capM3,capTon,trips,wton,eff});
  });

  // ✅ الترتيب
  if(vaSort==="eff"){
    rows.sort((a,b)=>b.eff-a.eff);
  }else if(vaSort==="year"){
    rows.sort((a,b)=>parseInt(b.year||"0")-parseInt(a.year||"0"));
  }else if(vaSort==="capTon"){
    rows.sort((a,b)=>b.capTon-a.capTon);
  }

  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.className="border-b hover:bg-gray-50";
    tr.innerHTML=`
      <td class="px-4 py-2">${r.vnum}</td>
      <td class="px-4 py-2">${r.year}</td>
      <td class="px-4 py-2">${r.capM3.toFixed(1)}</td>
      <td class="px-4 py-2">${r.capTon.toFixed(2)}</td>
      <td class="px-4 py-2">${r.trips}</td>
      <td class="px-4 py-2">${r.wton.toFixed(2)}</td>
      <td class="px-4 py-2">${r.eff.toFixed(1)}%</td>
    `;
    tb.appendChild(tr);
  });
}

async function loadVehSheet(){
  try{
    const result=await new Promise((resolve,reject)=>{
      Papa.parse(VEH_URL,{download:true,header:true,skipEmptyLines:true,complete:resolve,error:reject});
    });
    VEHICLES=result.data;
    renderVehAnalysis();
  }catch(e){console.error("خطأ تحميل شيت المركبات:",e);}
}

/* ===== أدوات مساعدة ===== */
function toNumber(v) {
  if (v == null) return 0;
  let s = String(v).trim();
  const arabicMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
  s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
  s = s.replace(/[^\d.]/g, "");
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

/* ===== تحميل بيانات الرحلات ===== */
async function loadData() {
  try {
    const result = await new Promise((resolve, reject) => {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: resolve,
        error: reject
      });
    });
    ALL = result.data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => {
        const kk = (k || "").trim();
        obj[kk] = (row[k] == null ? "" : String(row[k]).trim());
      });
      return obj;
    });
    renderVehAnalysis();
  } catch (e) {
    console.error("خطأ في جلب/قراءة الشيت:", e);
    alert("تعذر تحميل البيانات من الشيت.");
  }
}

/* ===== Events ===== */
document.getElementById('vaSearch').addEventListener('input',renderVehAnalysis);
document.getElementById('vaYear').addEventListener('input',renderVehAnalysis);
document.getElementById('vaSort').addEventListener('change',renderVehAnalysis);

document.addEventListener("DOMContentLoaded", ()=>{loadData();loadVehSheet();});
</script>
</body>
</html>
