<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    /* تخصيص شريط تمرير بسيط */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    
    /* Collapsible sections styles */
    .collapsible-section {
      margin-bottom: 1.5rem;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    
    .collapsible-header {
      background-color: #f8fafc;
      padding: 1rem 1.5rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
      transition: background-color 0.2s;
    }
    
    .collapsible-header:hover {
      background-color: #e2e8f0;
    }
    
    .collapsible-header h3 {
      margin: 0;
      font-weight: 600;
      color: #1e293b;
    }
    
    .collapsible-icon {
      transition: transform 0.3s ease;
      font-size: 1.2rem;
      color: #64748b;
    }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background-color: white;
    }
    
    .collapsible-content.expanded {
      max-height: 5000px; /* Large enough to contain all content */
    }
    
    .collapsible-content-inner {
      padding: 1.5rem;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="toast-container" class="fixed top-24 right-4 z-50"></div>
  <div id="loadingOverlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="flex flex-col items-center gap-3">
      <div class="h-8 w-8 rounded-full border-4 border-blue-600 border-t-transparent animate-spin"></div>
      <div class="text-sm text-blue-700" id="loadingMessage"></div>
    </div>
  </div>

  <header class="bg-blue-600 text-white p-6 shadow fixed top-0 w-full z-40">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 pt-24">
    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-4">الفلاتر وعناصر التحكم</h2>
      <div class="grid grid-cols-1 lg:grid-cols-7 gap-4">
      <div class="lg:col-span-2">
        <label class="block text-sm mb-1">بحث عام</label>
        <input id="q" type="text" placeholder="ابحث بتاريخ أو سائق أو رقم مركبة..." class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">الشهور </label>
          <div class="flex gap-2 text-xs">
            <button id="monthSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>تحديد الكل</button>
            <button id="monthClearAll" class="px-2 py-1 rounded border hover:bg-gray-50 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>مسح</button>
          </div>
        </div>
        <div class="relative">
          <button id="monthDropdownBtn" class="w-full text-right border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">اختر الشهور... <span id="monthCount" class="text-blue-500 text-xs mr-2"></span></button>
          <div id="monthDropdownMenu" class="absolute hidden top-full left-0 z-10 w-full bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
            </div>
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">أرقام المركبات </label>
          <div class="flex gap-2 text-xs">
            <button id="vehSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>تحديد الكل</button>
            <button id="vehClearAll" class="px-2 py-1 rounded border hover:bg-gray-50 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>مسح</button>
          </div>
        </div>
        <div class="relative">
          <button id="vehicleDropdownBtn" class="w-full text-right border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">اختر المركبات... <span id="vehicleCount" class="text-blue-500 text-xs mr-2"></span></button>
          <div id="vehicleDropdownMenu" class="absolute hidden top-full left-0 z-10 w-full bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
            </div>
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">تاريخ محدد</label>
        <input id="dateExact" type="date" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div class="flex items-end lg:col-span-2">
        <div class="flex flex-wrap gap-2">
          <button id="resetBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">إعادة تعيين الفلاتر</button>
          <button id="refreshBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تحديث من المصدر</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الرحلات</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 id="k_trips" class="text-2xl font-bold text-blue-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الوزن</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3 .895-3 2 1.343 2 3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 0v3.003V12m0 0c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 id="k_weight" class="text-2xl font-bold text-green-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي كلفة الوقود</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m3 0V4a2 2 0 012-2h2a2 2 0 012 2v12m-3 0h6m-6 0h-2M9 20h6" /></svg><h3 id="k_totalFuelCost" class="text-2xl font-bold text-teal-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي كلفة الصيانة</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /></svg><h3 id="k_totalMaintenanceCost" class="text-2xl font-bold text-rose-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد المركبات</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><h3 id="k_vehicleCount" class="text-2xl font-bold text-yellow-600">0</h3></div></div>

      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">متوسط حمولة الرحلة</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3 .895-3 2 1.343 2 3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 0v3.003V12m0 0c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 id="k_avg" class="text-2xl font-bold text-purple-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد السائقين</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.165-1.294-.478-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.165-1.294.478-1.857m0 0a5.002 5.002 0 019.044 0H17M7 13a3 3 0 016 0v2m-3-2a3 3 0 00-3 3v2m-3-2a3 3 0 013-3m0 0a3 3 0 003 3v2" /></svg><h3 id="k_drivers" class="text-2xl font-bold text-orange-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (وزن)</p><h3 id="k_topVehicleWeight" class="text-xl font-bold text-red-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (رحلات)</p><h3 id="k_topVehicleTrips" class="text-xl font-bold text-indigo-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">اليوم الأعلى وزناً</p><h3 id="k_topDay" class="text-xl font-bold text-pink-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط يومي</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgDailyWeight" class="font-bold text-blue-600">0</span> طن/يوم</div>
          <div>الرحلات: <span id="k_avgDailyTrips" class="font-bold text-blue-600">0</span> رحلة/يوم</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط شهري</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgMonthlyWeight" class="font-bold text-blue-600">0</span> طن/شهر</div>
          <div>الرحلات: <span id="k_avgMonthlyTrips" class="font-bold text-blue-600">0</span> رحلة/شهر</div>
        </div>
      </div>
    </div>

    <!-- Time Series Section -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="timeSeriesContent">
        <h3>السلاسل الزمنية</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="timeSeriesContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <select id="tsAgg" class="border rounded-lg px-3 py-2">
              <option value="day">تجميع يومي</option>
              <option value="month">تجميع شهري</option>
            </select>
            <select id="tsMetric" class="border rounded-lg px-3 py-2">
              <option value="weight">الوزن (طن)</option>
              <option value="trips">الرحلات</option>
            </select>
          </div>
          <canvas id="timeSeriesChart" height="120"></canvas>
          <p class="text-xs text-gray-500 mt-2">* قد تُستثنى السجلات بلا تاريخ من الرسم اليومي.</p>
        </div>
      </div>
    </div>

    <!-- Vehicle Weight Section -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="vehicleWeightContent">
        <h3>وزن النقل حسب المركبة (بالطن)</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="vehicleWeightContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <label class="text-sm">بحث عن مركبة:</label>
            <input id="vwSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
            <label class="text-sm">Top N:</label>
            <input id="vwTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
          </div>
          <canvas id="vehicleWeightChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <!-- Trip Distribution Section -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="tripDistributionContent">
        <h3>نسبة عدد الرحلات لكل مركبة</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="tripDistributionContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <label class="text-sm">بحث عن مركبة:</label>
            <input id="vtSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
            <label class="text-sm">Top N:</label>
            <input id="vtTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
          </div>
          <canvas id="vehicleTripsChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <!-- Vehicle Efficiency Analysis Section -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="vehicleEfficiencyContent">
        <h3>تحليل كفاءة المركبات</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="vehicleEfficiencyContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <label class="text-sm">بحث:</label>
            <input id="vaSearch" type="text" placeholder="ابحث..." class="border rounded-lg px-3 py-1">
            <label class="text-sm">من سنة تصنيع:</label>
            <input id="vaYear" type="number" placeholder="2000" class="w-24 border rounded-lg px-3 py-1">
            <label class="text-sm">ترتيب تنازلي حسب:</label>
            <select id="vaSort" class="border rounded-lg px-3 py-1">
              <option value="eff">نسبة الاستغلال</option>
              <option value="fuelCost">كلفة الوقود</option>
              <option value="maintenanceCost">كلفة الصيانة</option>
              <option value="costPerTrip">كلفة الرحلة</option>
              <option value="costPerTon">كلفة الطن</option>
              <option value="capTon">السعة النظرية</option>
              <option value="trips">عدد الرحلات</option>
              <option value="wton">الوزن المنقول</option>
              <option value="year">سنة التصنيع</option>
            </select>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-right">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2">رقم المركبة</th>
                  <th class="px-4 py-2">السائق</th>
                  <th class="px-4 py-2">سنة التصنيع</th>
                  <th class="px-4 py-2">السعة (م³)</th>
                  <th class="px-4 py-2">السعة النظرية (طن)</th>
                  <th class="px-4 py-2">عدد الرحلات</th>
                  <th class="px-4 py-2">الوزن المنقول (طن)</th>
                  <th class="px-4 py-2">نسبة الاستغلال %</th>
                  <th class="px-4 py-2">كلفة الوقود</th>
                  <th class="px-4 py-2">كلفة الصيانة</th>
                  <th class="px-4 py-2">كلفة الرحلة</th>
                  <th class="px-4 py-2">كلفة الطن</th>
                </tr>
              </thead>
              <tbody id="vehAnalysisTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 mb-6">
      <button id="btnCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (الرحلات الحالية)</button>
      <button id="btnXLSX" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير Excel (رحلات + ملخص مركبات)</button>
      <button id="btnPDF" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">PDF (سجل الرحلات)</button>
      <button id="btnDriversCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (تحليل السائقين)</button>
    </div>

    <!-- Driver Analysis Section -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="driverAnalysisContent">
        <h3>تحليل السائقين</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="driverAnalysisContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <label class="text-sm">الترتيب</label>
            <select id="driverSort" class="border rounded-lg px-3 py-2">
              <option value="weight">حسب الوزن</option>
              <option value="trips">حسب الرحلات</option>
              <option value="avg">متوسط حمولة/رحلة</option>
            </select>
            <label class="text-sm">عدد السائقين (Top N)</label>
            <input id="driverTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-2">
            <label class="text-sm">بحث عن سائق</label>
            <input id="driverSearch" type="text" placeholder="اسم السائق" class="border rounded-lg px-3 py-2">
          </div>
          <canvas id="driverChart" height="120" class="mb-6"></canvas>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-right">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2">السائق</th>
                  <th class="px-4 py-2">عدد الرحلات</th>
                  <th class="px-4 py-2">الوزن (طن)</th>
                  <th class="px-4 py-2">متوسط/رحلة (طن)</th>
                  <th class="px-4 py-2">عدد المركبات</th>
                  <th class="px-4 py-2">المركبات</th>
                </tr>
              </thead>
              <tbody id="driverTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Trip Log Section -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="tripLogContent">
        <h3>سجل الرحلات</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="tripLogContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="p-4 flex flex-wrap items-center gap-3">
            <label class="text-sm">عدد الصفوف في الصفحة</label>
            <select id="pageSize" class="border rounded-lg px-2 py-1">
              <option>10</option>
              <option selected>25</option>
              <option>50</option>
              <option>100</option>
            </select>

            <div class="ms-auto flex items-center gap-2">
              <button id="prevPage" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
              <span class="text-sm">صفحة <span id="pageIdx">1</span> من <span id="pageTotal">1</span></span>
              <button id="nextPage" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-right">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2">الشهر</th>
                  <th class="px-4 py-2">تاريخ التوزين الثاني</th>
                  <th class="px-4 py-2">السائق</th>
                  <th class="px-4 py-2">صافي التحميل (طن)</th>
                  <th class="px-4 py-2">رقم المركبة</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="p-4 border-t flex items-center gap-2">
            <button id="prevPage2" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
            <span class="text-sm">صفحة <span id="pageIdx2">1</span> من <span id="pageTotal2">1</span></span>
            <button id="nextPage2" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
            <div class="ms-auto text-xs text-gray-500">* الترتيب الافتراضي حسب ترتيب المصدر.</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    /* ===== إعدادات الأعمدة ===== */
    const COL = {
      month: "الشهر",
      date: "تاريخ التوزين الثاني",
      driver: "السائق",
      weight: "صافي التحميل",
      vehicle: "رقم المركبة"
    };

    const VEH_COLS = {
      plate: "رقم المركبة",
      driver: "السائق",
      year: "سنة التصنيع",
      capacity: "السعة",
      capTon: "السعة النظرية"
    };

    const FUEL_COLS = {
      plate: "رقم المركبة",
      jan: "jan", feb: "feb", mar: "mar", apr: "apr", may: "may", jun: "jun",
      july: "july", aug: "aug", sep: "sep", oct: "oct", nov: "nov", dec: "dec"
    };

    const MAINT_COLS = {
      plate: "رقم المركبة",
      cost: "كلفة الصيانة"
    };

    /* ===== روابط الشيتات ===== */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";
    const VEH_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2001178330&single=true&output=csv";
    const FUEL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=1380959426&single=true&output=csv";
    const MAINTENANCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2095309457&single=true&output=csv";

    /* ===== متغيرات عامة ===== */
    let ALL = [];
    let VIEW = [];
    let VEHICLES = [];
    let FUEL = [];
    let MAINTENANCE = [];
    let vehicleWeightChart = null;
    let vehicleTripsChart  = null;
    let timeSeriesChart    = null;
    let driverChart        = null;
    /* تحميل/تعطيل */
    let dataLoaded = false, vehiclesLoaded = false, fuelLoaded = false, maintenanceLoaded = false;
    const controlsSelector = 'input, select, button';
    function setLoading(state) {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = state ? 'flex' : 'none';
      document.querySelectorAll(controlsSelector).forEach(el => {
        if (el.id === 'refreshBtn') return; // اسمح بالتحديث دائماً
        el.disabled = state;
      });
    }
    function maybeHideOverlay() {
      if (dataLoaded && vehiclesLoaded && fuelLoaded && maintenanceLoaded) setLoading(false);
    }

    /* أدوات مساعدة */
    function toNumber(v) {
      if (v == null) return 0;
      let s = String(v).trim();
      const arabicMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
      s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
      s = s.replace(/[^\d.]/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    function formatTonFromKg(kg) {
      const t = kg / 1000;
      return t.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function toYMD(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const d = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function toYM(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    }

    /* ===== فلترة ===== */
    function applyFilters() {
      const q = document.getElementById("q").value.trim().toLowerCase();
      const monthCheckboxes = document.querySelectorAll("#monthDropdownMenu input[type='checkbox']");
      const vehicleCheckboxes = document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']");
      const months = Array.from(monthCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
      const vehicles = Array.from(vehicleCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
      const d = document.getElementById("dateExact").value;
      VIEW = ALL.filter(r => {
        const recMonth = String(r[COL.month] || "").trim();
        const recVeh   = String(r[COL.vehicle] || "").trim();
        const byMonth   = months.length ? months.includes(recMonth) : true;
        const byVehicle = vehicles.length ? vehicles.includes(recVeh) : true;
        let byDate = true;
        if (d) {
          if (!r[COL.date]) byDate = false;
          else {
            const recordDate = new Date(r[COL.date]);
            const exactDate = new Date(d);
            byDate = recordDate.toDateString() === exactDate.toDateString();
          }
        }
        if (!byMonth || !byVehicle || !byDate) return false;
        if (!q) return true;
        const hay = [r[COL.month], r[COL.date], r[COL.driver], r[COL.weight], r[COL.vehicle]].map(x => (x==null?"":String(x))).join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    /* ===== ملخص المركبات ===== */
    function updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers) {
      const vehiclesSet = new Set([...Object.keys(byVehicleTrips), ...Object.keys(byVehicleWeight)]);
      let summary = Array.from(vehiclesSet).map(v => ({
        vehicle: v,
        drivers: Array.from(vehicleDrivers[v] || []),
        trips: byVehicleTrips[v] || 0,
        weightTon: (byVehicleWeight[v] || 0) / 1000
      }));
      const vsQuery=document.getElementById("vsSearch")?.value?.toLowerCase() || "";
      const vsSort=document.getElementById("vsSort")?.value || "weight";
      if(vsQuery){
        summary=summary.filter(r=>r.vehicle.toLowerCase().includes(vsQuery)||r.drivers.join(", ").toLowerCase().includes(vsQuery));
      }
      if(vsSort==="weight"){ summary.sort((a,b)=>b.weightTon-a.weightTon);
      }
      else if(vsSort==="trips"){ summary.sort((a,b)=>b.trips-a.trips); }

      const tbody = document.getElementById("vehicleSummary");
      if (!tbody) return;
      tbody.innerHTML = "";
      summary.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${row.vehicle}</td>
          <td class="px-4 py-2">${row.drivers.join(", ")}</td>
          <td class="px-4 py-2">${row.trips}</td>
          <td class="px-4 py-2">${row.weightTon.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    /* ===== تحليل كفاءة المركبات ===== */
    function renderVehAnalysis() {
      const byVehicleTrips = {};
      const byVehicleWeight = {};
      VIEW.forEach(r => {
        const v = String(r[COL.vehicle] || "").trim();
        const w = toNumber(r[COL.weight]);
        if (!byVehicleTrips[v]) byVehicleTrips[v] = 0;
        if (!byVehicleWeight[v]) byVehicleWeight[v] = 0;
        byVehicleTrips[v]++;
        byVehicleWeight[v] += w;
      });

      const allVehiclesMap = new Map();
      VEHICLES.forEach(v => allVehiclesMap.set(String(v[VEH_COLS.plate] || "").trim(), v));

      const vehicleData = Array.from(allVehiclesMap.keys())
        .filter(vPlate => Object.keys(byVehicleTrips).includes(vPlate))
        .map(vPlate => {
          const vData = allVehiclesMap.get(vPlate);
          const totalTrips = byVehicleTrips[vPlate] || 0;
          const totalWeight = byVehicleWeight[vPlate] || 0;
          const fuelData = FUEL.find(f => String(f[FUEL_COLS.plate] || "").trim() === vPlate);
          const maintData = MAINTENANCE.find(m => String(m[MAINT_COLS.plate] || "").trim() === vPlate);
          const totalFuelCost = Object.keys(FUEL_COLS).slice(1).reduce((sum, month) => sum + toNumber(fuelData?.[month]), 0);
          const totalMaintenanceCost = toNumber(maintData?.[MAINT_COLS.cost]);
          const capTon = toNumber(vData?.[VEH_COLS.capTon]);
          const costPerTrip = totalTrips > 0 ? (totalFuelCost + totalMaintenanceCost) / totalTrips : 0;
          const costPerTon = (totalWeight / 1000) > 0 ? (totalFuelCost + totalMaintenanceCost) / (totalWeight / 1000) : 0;
          const efficiency = (capTon > 0 && (totalWeight/1000) > 0) ? (totalWeight/1000)/capTon/totalTrips*100 : 0;
          
          return {
            plate: vPlate,
            driver: vData?.[VEH_COLS.driver],
            year: toNumber(vData?.[VEH_COLS.year]),
            capacity: toNumber(vData?.[VEH_COLS.capacity]),
            capTon: capTon,
            trips: totalTrips,
            wton: totalWeight / 1000,
            eff: efficiency,
            fuelCost: totalFuelCost,
            maintenanceCost: totalMaintenanceCost,
            costPerTrip: costPerTrip,
            costPerTon: costPerTon
          };
        });
      
      const vaSearch = document.getElementById("vaSearch").value.toLowerCase();
      const vaYear = toNumber(document.getElementById("vaYear").value);
      const vaSort = document.getElementById("vaSort").value;

      let filteredData = vehicleData.filter(d => 
        (d.plate.toLowerCase().includes(vaSearch) || d.driver?.toLowerCase().includes(vaSearch)) &&
        (vaYear === 0 || d.year >= vaYear)
      );

      filteredData.sort((a,b) => {
        if(vaSort === "eff") return b.eff - a.eff;
        if(vaSort === "fuelCost") return b.fuelCost - a.fuelCost;
        if(vaSort === "maintenanceCost") return b.maintenanceCost - a.maintenanceCost;
        if(vaSort === "costPerTrip") return b.costPerTrip - a.costPerTrip;
        if(vaSort === "costPerTon") return b.costPerTon - a.costPerTon;
        if(vaSort === "capTon") return b.capTon - a.capTon;
        if(vaSort === "trips") return b.trips - a.trips;
        if(vaSort === "wton") return b.wton - a.wton;
        if(vaSort === "year") return b.year - a.year;
        return 0;
      });

      const tbody = document.getElementById("vehAnalysisTable");
      tbody.innerHTML = "";
      filteredData.forEach(d => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${d.plate}</td>
          <td class="px-4 py-2">${d.driver || '-'}</td>
          <td class="px-4 py-2">${d.year || '-'}</td>
          <td class="px-4 py-2">${d.capacity.toFixed(1)}</td>
          <td class="px-4 py-2">${d.capTon.toFixed(2)}</td>
          <td class="px-4 py-2">${d.trips}</td>
          <td class="px-4 py-2">${d.wton.toFixed(2)}</td>
          <td class="px-4 py-2">${d.eff.toFixed(1)}%</td>
          <td class="px-4 py-2">${d.fuelCost.toLocaleString()}</td>
          <td class="px-4 py-2">${d.maintenanceCost.toLocaleString()}</td>
          <td class="px-4 py-2">${d.costPerTrip.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
          <td class="px-4 py-2">${d.costPerTon.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ===== تحليل السائقين ===== */
    function renderDriverAnalysis() {
      const byDriverTrips = {};
      const byDriverWeight = {};
      const driverVehicles = {};

      VIEW.forEach(r => {
        const driver = String(r[COL.driver] || "").trim();
        const v = String(r[COL.vehicle] || "").trim();
        const w = toNumber(r[COL.weight]);
        if (!byDriverTrips[driver]) byDriverTrips[driver] = 0;
        if (!byDriverWeight[driver]) byDriverWeight[driver] = 0;
        if (!driverVehicles[driver]) driverVehicles[driver] = new Set();
        byDriverTrips[driver]++;
        byDriverWeight[driver] += w;
        driverVehicles[driver].add(v);
      });

      const driverData = Object.keys(byDriverTrips).map(driver => ({
        driver,
        trips: byDriverTrips[driver],
        weight: byDriverWeight[driver] / 1000,
        avg: byDriverTrips[driver] > 0 ? (byDriverWeight[driver] / 1000) / byDriverTrips[driver] : 0,
        vehicles: Array.from(driverVehicles[driver] || []),
        vehicleCount: (driverVehicles[driver] || new Set()).size
      }));

      const driverSort = document.getElementById("driverSort").value;
      const driverTopN = toNumber(document.getElementById("driverTopN").value) || 10;
      const driverSearch = document.getElementById("driverSearch").value.toLowerCase();

      let filteredDrivers = driverData.filter(d => d.driver.toLowerCase().includes(driverSearch));
      
      if (driverSort === "weight") {
        filteredDrivers.sort((a,b) => b.weight - a.weight);
      } else if (driverSort === "trips") {
        filteredDrivers.sort((a,b) => b.trips - a.trips);
      } else if (driverSort === "avg") {
        filteredDrivers.sort((a,b) => b.avg - a.avg);
      }

      const topDrivers = filteredDrivers.slice(0, driverTopN);

      // رسم المخطط
      const ctx = document.getElementById("driverChart").getContext("2d");
      if (driverChart) driverChart.destroy();
      driverChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: topDrivers.map(d => d.driver),
          datasets: [
            {
              label: "الرحلات",
              data: topDrivers.map(d => d.trips),
              backgroundColor: "rgba(54, 162, 235, 0.7)",
              yAxisID: "y"
            },
            {
              label: "الوزن (طن)",
              data: topDrivers.map(d => d.weight),
              backgroundColor: "rgba(255, 99, 132, 0.7)",
              yAxisID: "y1"
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: "index", intersect: false },
          scales: {
            x: { display: true },
            y: { type: "linear", display: true, position: "left", title: { display: true, text: "الرحلات" } },
            y1: { type: "linear", display: true, position: "right", title: { display: true, text: "الوزن (طن)" }, grid: { drawOnChartArea: false } }
          }
        }
      });

      // جدول السائقين
      const tbody = document.getElementById("driverTable");
      tbody.innerHTML = "";
      filteredDrivers.forEach(d => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${d.driver}</td>
          <td class="px-4 py-2">${d.trips}</td>
          <td class="px-4 py-2">${d.weight.toFixed(2)}</td>
          <td class="px-4 py-2">${d.avg.toFixed(2)}</td>
          <td class="px-4 py-2">${d.vehicleCount}</td>
          <td class="px-4 py-2">${d.vehicles.join(", ")}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ===== سجل الرحلات ===== */
    let currentPage = 1;
    let pageSize = 25;

    function renderTripLog() {
      const startIdx = (currentPage - 1) * pageSize;
      const pageData = VIEW.slice(startIdx, startIdx + pageSize);
      const totalPages = Math.ceil(VIEW.length / pageSize);
      document.getElementById("pageIdx").textContent = currentPage;
      document.getElementById("pageTotal").textContent = totalPages;
      document.getElementById("pageIdx2").textContent = currentPage;
      document.getElementById("pageTotal2").textContent = totalPages;
      document.getElementById("prevPage").disabled = currentPage <= 1;
      document.getElementById("nextPage").disabled = currentPage >= totalPages;
      document.getElementById("prevPage2").disabled = currentPage <= 1;
      document.getElementById("nextPage2").disabled = currentPage >= totalPages;

      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      pageData.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${r[COL.month] || ""}</td>
          <td class="px-4 py-2">${r[COL.date] || ""}</td>
          <td class="px-4 py-2">${r[COL.driver] || ""}</td>
          <td class="px-4 py-2">${formatTonFromKg(toNumber(r[COL.weight]))}</td>
          <td class="px-4 py-2">${r[COL.vehicle] || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ===== المخططات ===== */
    function renderCharts() {
      renderTimeSeriesChart();
      renderVehicleWeightChart();
      renderVehicleTripsChart();
    }

    function renderTimeSeriesChart() {
      const agg = document.getElementById("tsAgg").value;
      const metric = document.getElementById("tsMetric").value;
      const byDate = {};
      VIEW.forEach(r => {
        if (!r[COL.date]) return;
        const dt = new Date(r[COL.date]);
        if (isNaN(dt.getTime())) return;
        const key = agg === "month" ? toYM(dt) : toYMD(dt);
        if (!byDate[key]) byDate[key] = { trips: 0, weight: 0 };
        byDate[key].trips++;
        byDate[key].weight += toNumber(r[COL.weight]);
      });
      const labels = Object.keys(byDate).sort();
      const data = labels.map(k => byDate[k][metric === "trips" ? "trips" : "weight"] / (metric === "weight" ? 1000 : 1));
      const ctx = document.getElementById("timeSeriesChart").getContext("2d");
      if (timeSeriesChart) timeSeriesChart.destroy();
      timeSeriesChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: metric === "trips" ? "الرحلات" : "الوزن (طن)",
            data: data,
            borderColor: "rgb(59, 130, 246)",
            backgroundColor: "rgba(59, 130, 246, 0.1)",
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { display: true, title: { display: true, text: "التاريخ" } },
            y: { display: true, title: { display: true, text: metric === "trips" ? "الرحلات" : "الوزن (طن)" } }
          }
        }
      });
    }

    function renderVehicleWeightChart() {
      const byVehicle = {};
      VIEW.forEach(r => {
        const v = String(r[COL.vehicle] || "").trim();
        const w = toNumber(r[COL.weight]);
        if (!byVehicle[v]) byVehicle[v] = 0;
        byVehicle[v] += w;
      });
      const vwSearch = document.getElementById("vwSearch").value.toLowerCase();
      const vwTopN = toNumber(document.getElementById("vwTopN").value) || 10;
      let vehicles = Object.keys(byVehicle)
        .filter(v => v.toLowerCase().includes(vwSearch))
        .sort((a,b) => byVehicle[b] - byVehicle[a])
        .slice(0, vwTopN);
      const labels = vehicles;
      const data = vehicles.map(v => byVehicle[v] / 1000);
      const ctx = document.getElementById("vehicleWeightChart").getContext("2d");
      if (vehicleWeightChart) vehicleWeightChart.destroy();
      vehicleWeightChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "الوزن (طن)",
            data: data,
            backgroundColor: "rgba(34, 197, 94, 0.7)"
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { display: true, title: { display: true, text: "رقم المركبة" } },
            y: { display: true, title: { display: true, text: "الوزن (طن)" } }
          }
        }
      });
    }

    function renderVehicleTripsChart() {
      const byVehicle = {};
      VIEW.forEach(r => {
        const v = String(r[COL.vehicle] || "").trim();
        if (!byVehicle[v]) byVehicle[v] = 0;
        byVehicle[v]++;
      });
      const vtSearch = document.getElementById("vtSearch").value.toLowerCase();
      const vtTopN = toNumber(document.getElementById("vtTopN").value) || 10;
      let vehicles = Object.keys(byVehicle)
        .filter(v => v.toLowerCase().includes(vtSearch))
        .sort((a,b) => byVehicle[b] - byVehicle[a])
        .slice(0, vtTopN);
      const labels = vehicles;
      const data = vehicles.map(v => byVehicle[v]);
      const ctx = document.getElementById("vehicleTripsChart").getContext("2d");
      if (vehicleTripsChart) vehicleTripsChart.destroy();
      vehicleTripsChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: labels,
          datasets: [{
            label: "الرحلات",
            data: data,
            backgroundColor: ["#3b82f6", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6", "#06b6d4", "#f97316", "#84cc16", "#ec4899", "#6366f1"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw} رحلة (${((ctx.raw/VIEW.length)*100).toFixed(1)}%)` } }
          }
        }
      });
    }

    /* ===== التحديث الرئيسي ===== */
    function updateAll() {
      applyFilters();
      const byVehicleTrips = {};
      const byVehicleWeight = {};
      const vehicleDrivers = {};
      const byDriverTrips = {};
      const byDriverWeight = {};
      const byMonthTrips = {};
      const byMonthWeight = {};
      const byDateTrips = {};
      const byDateWeight = {};
      const vehiclesSet = new Set();
      const driversSet = new Set();
      const monthsSet = new Set();
      let totalWeight = 0;
      let totalTrips = VIEW.length;
      let topDay = { date: null, weight: 0 };
      let topVehicleWeight = { vehicle: null, weight: 0 };
      let topVehicleTrips = { vehicle: null, trips: 0 };

      VIEW.forEach(r => {
        const v = String(r[COL.vehicle] || "").trim();
        const driver = String(r[COL.driver] || "").trim();
        const month = String(r[COL.month] || "").trim();
        const date = r[COL.date];
        const w = toNumber(r[COL.weight]);
        vehiclesSet.add(v);
        driversSet.add(driver);
        monthsSet.add(month);
        totalWeight += w;
        if (!byVehicleTrips[v]) byVehicleTrips[v] = 0;
        if (!byVehicleWeight[v]) byVehicleWeight[v] = 0;
        if (!byDriverTrips[driver]) byDriverTrips[driver] = 0;
        if (!byDriverWeight[driver]) byDriverWeight[driver] = 0;
        if (!byMonthTrips[month]) byMonthTrips[month] = 0;
        if (!byMonthWeight[month]) byMonthWeight[month] = 0;
        if (!vehicleDrivers[v]) vehicleDrivers[v] = new Set();
        byVehicleTrips[v]++;
        byVehicleWeight[v] += w;
        byDriverTrips[driver]++;
        byDriverWeight[driver] += w;
        byMonthTrips[month]++;
        byMonthWeight[month] += w;
        vehicleDrivers[v].add(driver);
        if (date) {
          if (!byDateTrips[date]) byDateTrips[date] = 0;
          if (!byDateWeight[date]) byDateWeight[date] = 0;
          byDateTrips[date]++;
          byDateWeight[date] += w;
          if (byDateWeight[date] > topDay.weight) {
            topDay = { date, weight: byDateWeight[date] };
          }
        }
        if (byVehicleWeight[v] > topVehicleWeight.weight) {
          topVehicleWeight = { vehicle: v, weight: byVehicleWeight[v] };
        }
        if (byVehicleTrips[v] > topVehicleTrips.trips) {
          topVehicleTrips = { vehicle: v, trips: byVehicleTrips[v] };
        }
      });

      // تحديث البطاقات
      document.getElementById("k_trips").textContent = totalTrips.toLocaleString();
      document.getElementById("k_weight").textContent = formatTonFromKg(totalWeight);
      document.getElementById("k_vehicleCount").textContent = vehiclesSet.size;
      document.getElementById("k_drivers").textContent = driversSet.size;
      document.getElementById("k_avg").textContent = totalTrips > 0 ? formatTonFromKg(totalWeight / totalTrips) : "0";
      document.getElementById("k_topVehicleWeight").textContent = topVehicleWeight.vehicle ? `${topVehicleWeight.vehicle} (${formatTonFromKg(topVehicleWeight.weight)})` : "-";
      document.getElementById("k_topVehicleTrips").textContent = topVehicleTrips.vehicle ? `${topVehicleTrips.vehicle} (${topVehicleTrips.trips})` : "-";
      document.getElementById("k_topDay").textContent = topDay.date ? `${topDay.date} (${formatTonFromKg(topDay.weight)})` : "-";

      // متوسط يومي وشهري
      const uniqueDays = new Set(Object.keys(byDateTrips)).size;
      const uniqueMonths = monthsSet.size;
      document.getElementById("k_avgDailyWeight").textContent = uniqueDays > 0 ? formatTonFromKg(totalWeight / uniqueDays) : "0";
      document.getElementById("k_avgDailyTrips").textContent = uniqueDays > 0 ? (totalTrips / uniqueDays).toFixed(1) : "0";
      document.getElementById("k_avgMonthlyWeight").textContent = uniqueMonths > 0 ? formatTonFromKg(totalWeight / uniqueMonths) : "0";
      document.getElementById("k_avgMonthlyTrips").textContent = uniqueMonths > 0 ? (totalTrips / uniqueMonths).toFixed(1) : "0";

      // إجمالي تكاليف الوقود والصيانة
      let totalFuelCost = 0;
      let totalMaintenanceCost = 0;
      Object.keys(byVehicleTrips).forEach(vPlate => {
        const fuelData = FUEL.find(f => String(f[FUEL_COLS.plate] || "").trim() === vPlate);
        const maintData = MAINTENANCE.find(m => String(m[MAINT_COLS.plate] || "").trim() === vPlate);
        totalFuelCost += Object.keys(FUEL_COLS).slice(1).reduce((sum, month) => sum + toNumber(fuelData?.[month]), 0);
        totalMaintenanceCost += toNumber(maintData?.[MAINT_COLS.cost]);
      });
      document.getElementById("k_totalFuelCost").textContent = totalFuelCost.toLocaleString();
      document.getElementById("k_totalMaintenanceCost").textContent = totalMaintenanceCost.toLocaleString();

      // تحديث المخططات والجداول
      renderCharts();
      renderVehAnalysis();
      renderDriverAnalysis();
      renderTripLog();
      showToast("تم تحديث البيانات بنجاح!");
    }

    /* ===== التصدير ===== */
    document.getElementById("btnCSV").addEventListener("click", () => {
      const csv = Papa.unparse(VIEW);
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "trips.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById("btnXLSX").addEventListener("click", () => {
      const wb = XLSX.utils.book_new();
      const wsTrips = XLSX.utils.json_to_sheet(VIEW);
      XLSX.utils.book_append_sheet(wb, wsTrips, "الرحلات");
      XLSX.writeFile(wb, "trips.xlsx");
    });

    document.getElementById("btnPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("سجل الرحلات", 20, 20);
      let y = 30;
      VIEW.forEach((r, i) => {
        if (y > 270) { doc.addPage(); y = 20; }
        doc.text(`${r[COL.date] || ""} - ${r[COL.driver] || ""} - ${formatTonFromKg(toNumber(r[COL.weight]))} - ${r[COL.vehicle] || ""}`, 20, y);
        y += 10;
      });
      doc.save("trips.pdf");
    });

    document.getElementById("btnDriversCSV").addEventListener("click", () => {
      const byDriverTrips = {};
      const byDriverWeight = {};
      const driverVehicles = {};
      VIEW.forEach(r => {
        const driver = String(r[COL.driver] || "").trim();
        const v = String(r[COL.vehicle] || "").trim();
        const w = toNumber(r[COL.weight]);
        if (!byDriverTrips[driver]) byDriverTrips[driver] = 0;
        if (!byDriverWeight[driver]) byDriverWeight[driver] = 0;
        if (!driverVehicles[driver]) driverVehicles[driver] = new Set();
        byDriverTrips[driver]++;
        byDriverWeight[driver] += w;
        driverVehicles[driver].add(v);
      });
      const driverData = Object.keys(byDriverTrips).map(driver => ({
        السائق: driver,
        الرحلات: byDriverTrips[driver],
        "الوزن (طن)": (byDriverWeight[driver] / 1000).toFixed(2),
        "متوسط/رحلة (طن)": (byDriverTrips[driver] > 0 ? (byDriverWeight[driver] / 1000) / byDriverTrips[driver] : 0).toFixed(2),
        "عدد المركبات": (driverVehicles[driver] || new Set()).size,
        المركبات: Array.from(driverVehicles[driver] || []).join(", ")
      }));
      const csv = Papa.unparse(driverData);
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "drivers.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    /* ===== Loading Overlay and Toast Notifications ===== */
    function setLoading(isLoading, message = "جاري التحميل...") {
      const overlay = document.getElementById("loadingOverlay");
      const msg = document.getElementById("loadingMessage");
      if (isLoading) {
        msg.textContent = message;
        overlay.classList.remove("hidden");
      } else {
        overlay.classList.add("hidden");
      }
    }

    function showToast(message, type = "success") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      const bgColor = type === "success" ? "bg-green-500" : "bg-red-500";
      toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg animate-pulse`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    /* ===== تحميل البيانات ===== */
    function loadData() {
      setLoading(true, "جاري تحميل بيانات الرحلات...");
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: res => {
          ALL = res.data;
          dataLoaded = true;
          updateAll();
          maybeHideOverlay();
        },
        error: err => {
          console.error("فشل تحميل بيانات الرحلات:", err);
          setLoading(false);
        }
      });
    }

    function loadVehicles() {
      setLoading(true, "جاري تحميل بيانات المركبات...");
      Papa.parse(VEH_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: res => {
          VEHICLES = res.data;
          vehiclesLoaded = true;
          updateAll();
          maybeHideOverlay();
        },
        error: err => {
          console.error("فشل تحميل بيانات المركبات:", err);
          setLoading(false);
        }
      });
    }

    function loadFuel() {
      setLoading(true, "جاري تحميل بيانات الوقود...");
      Papa.parse(FUEL_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: res => {
          FUEL = res.data;
          fuelLoaded = true;
          updateAll();
          maybeHideOverlay();
        },
        error: err => {
          console.error("فشل تحميل بيانات الوقود:", err);
          setLoading(false);
        }
      });
    }

    function loadMaintenance() {
      setLoading(true, "جاري تحميل بيانات الصيانة...");
      Papa.parse(MAINTENANCE_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: res => {
          MAINTENANCE = res.data;
          maintenanceLoaded = true;
          updateAll();
          maybeHideOverlay();
        },
        error: err => {
          console.error("فشل تحميل بيانات الصيانة:", err);
          setLoading(false);
        }
      });
    }

    /* ===== فلترة الشهور والمركبات ===== */
    function populateMonthFilter() {
      const monthsSet = new Set();
      ALL.forEach(r => {
        const m = String(r[COL.month] || "").trim();
        if (m) monthsSet.add(m);
      });
      const months = Array.from(monthsSet).sort((a,b) => {
        const am = new Date(a + "-01"), bm = new Date(b + "-01");
        return bm - am;
      });
      const menu = document.getElementById("monthDropdownMenu");
      menu.innerHTML = "";
      months.forEach(m => {
        const div = document.createElement("div");
        div.className = "px-3 py-2 hover:bg-gray-50 flex items-center gap-2";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = m;
        cb.checked = true;
        cb.className = "ml-2";
        cb.addEventListener("change", updateAll);
        const label = document.createElement("label");
        label.textContent = m;
        label.className = "flex-1 cursor-pointer";
        label.addEventListener("click", () => { cb.checked = !cb.checked; cb.dispatchEvent(new Event("change")); });
        div.appendChild(cb);
        div.appendChild(label);
        menu.appendChild(div);
      });
      document.getElementById("monthSelectAll").addEventListener("click", () => {
        menu.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = true);
        updateAll();
      });
      document.getElementById("monthClearAll").addEventListener("click", () => {
        menu.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
        updateAll();
      });
    }

    function populateVehicleFilter() {
      const vehiclesSet = new Set();
      ALL.forEach(r => {
        const v = String(r[COL.vehicle] || "").trim();
        if (v) vehiclesSet.add(v);
      });
      const vehicles = Array.from(vehiclesSet).sort();
      const menu = document.getElementById("vehicleDropdownMenu");
      menu.innerHTML = "";
      vehicles.forEach(v => {
        const div = document.createElement("div");
        div.className = "px-3 py-2 hover:bg-gray-50 flex items-center gap-2";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = v;
        cb.checked = true;
        cb.className = "ml-2";
        cb.addEventListener("change", updateAll);
        const label = document.createElement("label");
        label.textContent = v;
        label.className = "flex-1 cursor-pointer";
        label.addEventListener("click", () => { cb.checked = !cb.checked; cb.dispatchEvent(new Event("change")); });
        div.appendChild(cb);
        div.appendChild(label);
        menu.appendChild(div);
      });
      document.getElementById("vehSelectAll").addEventListener("click", () => {
        menu.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = true);
        updateAll();
      });
      document.getElementById("vehClearAll").addEventListener("click", () => {
        menu.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
        updateAll();
      });
    }

    /* ===== إعداد القوائم المنسدلة ===== */
    function setupDropdowns() {
      const monthBtn = document.getElementById("monthDropdownBtn");
      const monthMenu = document.getElementById("monthDropdownMenu");
      const vehicleBtn = document.getElementById("vehicleDropdownBtn");
      const vehicleMenu = document.getElementById("vehicleDropdownMenu");

      function toggleMenu(menu) {
        const isHidden = menu.classList.contains("hidden");
        document.querySelectorAll(".absolute").forEach(m => m.classList.add("hidden"));
        if (isHidden) menu.classList.remove("hidden");
      }

      monthBtn.addEventListener("click", () => toggleMenu(monthMenu));
      vehicleBtn.addEventListener("click", () => toggleMenu(vehicleMenu));

      document.addEventListener("click", e => {
        if (!monthBtn.contains(e.target) && !monthMenu.contains(e.target)) monthMenu.classList.add("hidden");
        if (!vehicleBtn.contains(e.target) && !vehicleMenu.contains(e.target)) vehicleMenu.classList.add("hidden");
      });
    }

    /* ===== إعدادات الصفحة ===== */
    document.getElementById("pageSize").addEventListener("change", e => {
      pageSize = parseInt(e.target.value);
      currentPage = 1;
      renderTripLog();
    });

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) { currentPage--; renderTripLog(); }
    });
    document.getElementById("nextPage").addEventListener("click", () => {
      if (currentPage < Math.ceil(VIEW.length / pageSize)) { currentPage++; renderTripLog(); }
    });
    document.getElementById("prevPage2").addEventListener("click", () => {
      if (currentPage > 1) { currentPage--; renderTripLog(); }
    });
    document.getElementById("nextPage2").addEventListener("click", () => {
      if (currentPage < Math.ceil(VIEW.length / pageSize)) { currentPage++; renderTripLog(); }
    });

    /* ===== مستمعي الأحداث ===== */
    document.getElementById("q").addEventListener("input", updateAll);
    document.getElementById("dateExact").addEventListener("change", updateAll);
    document.getElementById("tsAgg").addEventListener("change", renderTimeSeriesChart);
    document.getElementById("tsMetric").addEventListener("change", renderTimeSeriesChart);
    document.getElementById("vwSearch").addEventListener("input", renderVehicleWeightChart);
    document.getElementById("vwTopN").addEventListener("change", renderVehicleWeightChart);
    document.getElementById("vtSearch").addEventListener("input", renderVehicleTripsChart);
    document.getElementById("vtTopN").addEventListener("change", renderVehicleTripsChart);
    document.getElementById("vaSearch").addEventListener("input", renderVehAnalysis);
    document.getElementById("vaYear").addEventListener("input", renderVehAnalysis);
    document.getElementById("vaSort").addEventListener("change", renderVehAnalysis);
    document.getElementById("driverSort").addEventListener("change", renderDriverAnalysis);
    document.getElementById("driverTopN").addEventListener("change", renderDriverAnalysis);
    document.getElementById("driverSearch").addEventListener("input", renderDriverAnalysis);

    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("q").value = "";
      document.getElementById("dateExact").value = "";
      document.querySelectorAll("#monthDropdownMenu input[type='checkbox']").forEach(cb => cb.checked = true);
      document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']").forEach(cb => cb.checked = true);
      updateAll();
    });

    document.getElementById("refreshBtn").addEventListener("click", () => {
      dataLoaded = vehiclesLoaded = fuelLoaded = maintenanceLoaded = false;
      loadData();
      loadVehicles();
      loadFuel();
      loadMaintenance();
    });

    /* ===== Collapsible Sections Functionality ===== */
    function setupCollapsibleSections() {
      const headers = document.querySelectorAll('.collapsible-header');
      
      headers.forEach(header => {
        header.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const content = document.getElementById(targetId);
          const icon = this.querySelector('.collapsible-icon');
          
          // Toggle the expanded class
          content.classList.toggle('expanded');
          
          // Rotate the icon
          if (content.classList.contains('expanded')) {
            icon.textContent = '▲';
            icon.style.transform = 'rotate(0deg)';
          } else {
            icon.textContent = '▼';
            icon.style.transform = 'rotate(0deg)';
          }
        });
      });
    }

    /* ===== تهيئة التطبيق ===== */
    function init() {
      loadData();
      loadVehicles();
      loadFuel();
      loadMaintenance();
      setupDropdowns();
      setupCollapsibleSections();
    }

    // بدء التطبيق عند تحميل الصفحة
    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
