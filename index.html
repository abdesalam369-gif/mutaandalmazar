<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة التحكم | بلدية مؤتة والمزار</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:"Cairo",sans-serif;
  background:#f8fafc;
  margin:0;
  color:#1e293b;
}
header{
  background:linear-gradient(90deg,#2563eb,#0ea5e9);
  color:#fff;
  padding:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.filters{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
select,button{
  padding:8px 12px;
  border-radius:8px;
  border:none;
  font-family:"Cairo",sans-serif;
  cursor:pointer;
}
button{
  background:#10b981;
  color:#fff;
}
.reset-btn{background:#ef4444;}
.container{
  padding:20px;
  max-width:1300px;
  margin:auto;
}
.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 2px 10px rgba(0,0,0,0.06);
}
.value{
  font-size:24px;
  font-weight:700;
}
</style>
</head>

<body>

<div id="loader" style="position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;">
جاري التحميل...
</div>

<header>
  <h1>
    بيانات نقل النفايات<br>
    بلدية مؤتة والمزار<br>
    <span id="yearTitle"></span>
  </h1>

  <div class="filters">
    <select id="yearFilter"></select>
    <button class="reset-btn" onclick="resetFilters()">إعادة تعيين</button>
  </div>
</header>

<div class="container">
  <div class="kpis">
    <div class="card"><div class="value" id="k_tons">—</div>إجمالي الأطنان</div>
    <div class="card"><div class="value" id="k_trips">—</div>عدد الرحلات</div>
    <div class="card"><div class="value" id="k_fuel">—</div>كلفة الوقود</div>
    <div class="card"><div class="value" id="k_maint">—</div>كلفة الصيانة</div>
  </div>
</div>
<script>
const CONFIG = {
  trips:   "PUT_TRIPS_CSV_URL_HERE",
  fuel:    "PUT_FUEL_CSV_URL_HERE",
  maint:   "PUT_MAINT_CSV_URL_HERE"
};

let tripsData=[], fuelData=[], maintData=[];
let activeYear=null;

async function fetchCSV(url){
  const r = await fetch(url);
  const t = await r.text();
  const rows = t.trim().split(/\r?\n/);
  const head = rows.shift().split(",");
  return rows.map(r=>{
    const c=r.split(",");
    let o={};
    head.forEach((h,i)=>o[h.trim()]=(c[i]||"").trim());
    return o;
  });
}

async function loadData(){
  tripsData = await fetchCSV(CONFIG.trips);
  fuelData  = await fetchCSV(CONFIG.fuel);
  maintData = await fetchCSV(CONFIG.maint);

  buildYearFilter();
  renderAll();

  document.getElementById("loader").style.display="none";
}

function buildYearFilter(){
  const sel=document.getElementById("yearFilter");
  sel.innerHTML="";

  const years=[...new Set(tripsData.map(r=>r["السنة"]).filter(Boolean))]
    .map(Number)
    .sort((a,b)=>b-a);

  years.forEach((y,i)=>{
    const o=document.createElement("option");
    o.value=y;
    o.textContent=y;
    if(i===0){
      o.selected=true;
      activeYear=y;
    }
    sel.appendChild(o);
  });

  sel.onchange=()=>{
    activeYear=sel.value;
    renderAll();
  };
}

function resetFilters(){
  renderAll();
}
<script>
function renderAll(){
  if(!activeYear) return;

  document.getElementById("yearTitle").textContent = activeYear;

  const data = tripsData.filter(r=>String(r["السنة"])===String(activeYear));

  const totalTrips = data.length;
  const totalTons = data.reduce((s,x)=>s+((+x["صافي التحميل"]||0)/1000),0);

  document.getElementById("k_trips").textContent = totalTrips.toLocaleString();
  document.getElementById("k_tons").textContent  = Math.round(totalTons).toLocaleString();

  let fuel=0;
  fuelData.filter(r=>String(r["السنة"])===String(activeYear))
    .forEach(r=>{
      Object.keys(r).forEach(k=>{
        if(k!=="رقم المركبة" && k!=="السنة")
          fuel+= (+r[k]||0);
      });
    });

  let maint=0;
  maintData.filter(r=>String(r["السنة"])===String(activeYear))
    .forEach(r=> maint+=(+r["كلفة الصيانة"]||0));

  document.getElementById("k_fuel").textContent  = Math.round(fuel).toLocaleString();
  document.getElementById("k_maint").textContent = Math.round(maint).toLocaleString();
}

loadData();
</script>

</body>
</html>
