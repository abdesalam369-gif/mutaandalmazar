<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- DataLabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-blue-600 text-white p-6 shadow">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <!-- Filters -->
    <div class="bg-white rounded-xl shadow p-4 mb-6 grid grid-cols-1 md:grid-cols-6 gap-4">
      <div>
        <label class="block text-sm mb-1">بحث عام</label>
        <input id="q" type="text" placeholder="ابحث بتاريخ أو سائق أو رقم مركبة..."
               class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>
      <div>
        <label class="block text-sm mb-1">الشهر</label>
        <select id="monthSelect" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <option value="">الكل</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">رقم المركبة</label>
        <select id="vehicleSelect" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <option value="">الكل</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">التاريخ</label>
        <input id="dateExact" type="date"
               class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>
      <div>
        <label class="block text-sm mb-1">ترتيب المركبات</label>
        <select id="sortSelect" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <option value="">بدون ترتيب</option>
          <option value="weight">حسب الوزن (تنازلي)</option>
          <option value="trips">حسب الرحلات (تنازلي)</option>
        </select>
      </div>
      <div class="flex items-end">
        <button id="resetBtn" class="w-full md:w-auto bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">
          إعادة تعيين الفلاتر
        </button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-7 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">إجمالي الرحلات</p>
        <h3 id="k_trips" class="text-2xl font-bold text-blue-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">إجمالي الوزن</p>
        <h3 id="k_weight" class="text-2xl font-bold text-green-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط حمولة الرحلة</p>
        <h3 id="k_avg" class="text-2xl font-bold text-purple-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">عدد السائقين</p>
        <h3 id="k_drivers" class="text-2xl font-bold text-orange-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">أكثر مركبة (وزن)</p>
        <h3 id="k_topVehicleWeight" class="text-xl font-bold text-red-600">-</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">أكثر مركبة (رحلات)</p>
        <h3 id="k_topVehicleTrips" class="text-xl font-bold text-indigo-600">-</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">اليوم الأعلى وزناً</p>
        <h3 id="k_topDay" class="text-xl font-bold text-pink-600">-</h3>
      </div>
    </div>

    <!-- Chart: الوزن -->
    <div id="chartWeightBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <h3 class="mb-4 font-semibold">وزن النقل حسب المركبة (بالطن)</h3>
      <canvas id="vehicleWeightChart" height="120"></canvas>
    </div>

    <!-- Chart: الرحلات -->
    <div id="chartTripsBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <h3 class="mb-4 font-semibold">نسبة عدد الرحلات لكل مركبة</h3>
      <canvas id="vehicleTripsChart" height="120"></canvas>
    </div>

    <!-- Vehicle Summary Table -->
    <div class="bg-white rounded-xl shadow overflow-hidden mt-6">
      <div class="p-4 border-b">
        <h3 class="font-semibold">ملخص المركبات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">رقم المركبة</th>
              <th class="px-4 py-2">السائقين</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">إجمالي الوزن (طن)</th>
            </tr>
          </thead>
          <tbody id="vehicleSummary"></tbody>
        </table>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-xl shadow overflow-hidden mt-6">
      <div class="p-4 border-b">
        <h3 class="font-semibold">سجل الرحلات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">الشهر</th>
              <th class="px-4 py-2">تاريخ التوزين الثاني</th>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">صافي التحميل (طن)</th>
              <th class="px-4 py-2">رقم المركبة</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="emptyState" class="p-6 text-center text-gray-500 hidden">لا توجد بيانات مطابقة.</div>
    </div>
  </main>

<script>
const COL = {
  month: "الشهر",
  date: "تاريخ التوزين الثاني",
  driver: "السائق",
  weight: "صافي التحميل",
  vehicle: "رقم المركبة"
};

const CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";

let ALL = [];
let VIEW = [];
let vehicleWeightChart = null;
let vehicleTripsChart = null;

function toNumber(v) {
  if (v == null) return 0;
  let s = String(v).trim();
  const arabicMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
  s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
  s = s.replace(/[^\d.]/g, "");
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

function applyFilters() {
  const q = document.getElementById("q").value.trim();
  const m = document.getElementById("monthSelect").value;
  const v = document.getElementById("vehicleSelect").value;
  const d = document.getElementById("dateExact").value;

  VIEW = ALL.filter(r => {
    const byMonth   = m ? (String(r[COL.month] || "").trim() === m) : true;
    const byVehicle = v ? (String(r[COL.vehicle] || "").trim() === v) : true;

    let byDate = true;
    if (d) {
      if (!r[COL.date]) {
        byDate = false;
      } else {
        const recordDate = new Date(r[COL.date]);
        const exactDate  = new Date(d);
        byDate = recordDate.toDateString() === exactDate.toDateString();
      }
    }

    if (!byMonth || !byVehicle || !byDate) return false;

    if (!q) return true;
    const hay = [r[COL.month], r[COL.date], r[COL.driver], r[COL.weight], r[COL.vehicle]]
      .map(x => (x==null?"":String(x))).join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  });
}

function updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers) {
  const sortBy = document.getElementById("sortSelect").value;

  let summary = Object.keys(byVehicleTrips).map(v => {
    return {
      vehicle: v,
      drivers: Array.from(vehicleDrivers[v] || []),
      trips: byVehicleTrips[v] || 0,
      weight: (byVehicleWeight[v] || 0) / 1000
    };
  });

  if (sortBy === "weight") {
    summary.sort((a,b)=> b.weight - a.weight);
  } else if (sortBy === "trips") {
    summary.sort((a,b)=> b.trips - a.trips);
  }

  const tbody = document.getElementById("vehicleSummary");
  tbody.innerHTML = "";
  summary.forEach(row => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-4 py-2">${row.vehicle}</td>
      <td class="px-4 py-2">${row.drivers.join(", ")}</td>
      <td class="px-4 py-2">${row.trips}</td>
      <td class="px-4 py-2">${row.weight.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function updateKPIs() {
  const trips = VIEW.length;
  const totalW = VIEW.reduce((s,r)=> s + toNumber(r[COL.weight]), 0);
  const avgW = trips ? Math.round(totalW / trips) : 0;
  const drivers = new Set(VIEW.map(r => r[COL.driver]).filter(Boolean));

  document.getElementById("k_trips").textContent  = trips.toLocaleString();
  document.getElementById("k_weight").textContent = (totalW/1000).toFixed(2).toLocaleString() + " طن";
  document.getElementById("k_avg").textContent    = (avgW/1000).toFixed(2).toLocaleString() + " طن";
  document.getElementById("k_drivers").textContent= drivers.size.toLocaleString();

  const byVehicleWeight = {};
  const byVehicleTrips = {};
  const vehicleDrivers = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle] || "مجهولة";
    const d = r[COL.driver] || "بدون سائق";

    byVehicleWeight[v] = (byVehicleWeight[v] || 0) + toNumber(r[COL.weight]);
    byVehicleTrips[v] = (byVehicleTrips[v] || 0) + 1;

    if (!vehicleDrivers[v]) vehicleDrivers[v] = new Set();
    vehicleDrivers[v].add(d);
  });

  updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers);

  let topVehicleWeight = "-";
  if (Object.keys(byVehicleWeight).length > 0) {
    topVehicleWeight = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topVehicleWeight").textContent = topVehicleWeight;

  let topVehicleTrips = "-";
  if (Object.keys(byVehicleTrips).length > 0) {
    topVehicleTrips = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topVehicleTrips").textContent = topVehicleTrips;

  const byDate = {};
  VIEW.forEach(r => {
    const d = r[COL.date];
    if (!d) return;
    byDate[d] = (byDate[d] || 0) + toNumber(r[COL.weight]);
  });

  let topDay = "-";
  if (Object.keys(byDate).length > 0) {
    topDay = Object.entries(byDate).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topDay").textContent = topDay;

  const sortBy = document.getElementById("sortSelect").value;

  let weightEntries = Object.entries(byVehicleWeight);
  let tripEntries = Object.entries(byVehicleTrips);

  if (sortBy === "weight") {
    weightEntries.sort((a,b)=> b[1]-a[1]);
    tripEntries.sort((a,b)=> b[1]-a[1]);
  } else if (sortBy === "trips") {
    tripEntries.sort((a,b)=> b[1]-a[1]);
    weightEntries.sort((a,b)=> b[1]-a[1]);
  }

  const labelsWeight = weightEntries.map(e=>e[0]);
  const dataWeight = weightEntries.map(e=>(e[1]/1000).toFixed(2));

  const labelsTrips = tripEntries.map(e=>{
    const v = e[0];
    const drivers = Array.from(vehicleDrivers[v]||[]).join(", ");
    return v + " – " + drivers;
  });
  const dataTrips = tripEntries.map(e=>e[1]);

  document.getElementById("chartWeightBox").style.display = labelsWeight.length > 1 ? "block" : "none";
  document.getElementById("chartTripsBox").style.display = labelsTrips.length > 1 ? "block" : "none";

  if (labelsWeight.length > 1) {
    if (vehicleWeightChart) vehicleWeightChart.destroy();
    const ctx1 = document.getElementById("vehicleWeightChart").getContext("2d");
    vehicleWeightChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: labelsWeight,
        datasets: [{
          label: "الوزن الكلي (طن)",
          data: dataWeight,
          backgroundColor: "rgba(59,130,246,0.7)"
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { title: { display: true, text: "المركبة" } },
          y: { title: { display: true, text: "الوزن (طن)" } }
        }
      }
    });
  }

  if (labelsTrips.length > 1) {
    if (vehicleTripsChart) vehicleTripsChart.destroy();
    const ctx2 = document.getElementById("vehicleTripsChart").getContext("2d");
    vehicleTripsChart = new Chart(ctx2, {
      type: 'pie',
      data: {
        labels: labelsTrips,
        datasets: [{
          label: "عدد الرحلات",
          data: dataTrips,
          backgroundColor: [
            "#3b82f6","#10b981","#f59e0b","#ef4444",
            "#8b5cf6","#06b6d4","#84cc16","#d946ef"
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'right' },
          datalabels: {
            color: '#fff',
            formatter: (value, ctx) => {
              let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              let percentage = (value * 100 / sum).toFixed(1)
