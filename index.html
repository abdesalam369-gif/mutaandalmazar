<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 4px;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="spinner"></div>
  </div>

  <header class="bg-blue-600 text-white p-6 shadow">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <!-- Filters Section -->
    <div class="bg-white rounded-xl shadow p-4 mb-6 grid grid-cols-1 md:grid-cols-6 gap-4">
      <div>
        <label class="block text-sm mb-1">بحث عام</label>
        <input id="q" type="text" placeholder="ابحث بتاريخ أو سائق أو رقم مركبة..."
               class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>
      <div>
        <label class="block text-sm mb-1">الشهر</label>
        <select id="monthSelect" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <option value="">الكل</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">رقم المركبة</label>
        <select id="vehicleSelect" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <option value="">الكل</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">التاريخ</label>
        <input id="dateExact" type="date"
               class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>
      <div>
        <label class="block text-sm mb-1">السائق</label>
        <select id="driverSelect" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <option value="">الكل</option>
        </select>
      </div>
      <div class="flex items-end">
        <button id="resetBtn" class="w-full md:w-auto bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">
          إعادة تعيين الفلاتر
        </button>
      </div>
    </div>

    <!-- KPIs Section -->
    <div class="grid grid-cols-1 md:grid-cols-9 gap-6 mb-6">
      <!-- KPI Cards (Skeleton Loading) -->
      <div class="bg-white rounded-xl shadow p-6">
        <div class="skeleton h-4 w-1/2 mb-2"></div>
        <div class="skeleton h-8 w-3/4"></div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <div class="skeleton h-4 w-1/2 mb-2"></div>
        <div class="skeleton h-8 w-3/4"></div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <div class="skeleton h-4 w-1/2 mb-2"></div>
        <div class="skeleton h-8 w-3/4"></div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <div class="skeleton h-4 w-1/2 mb-2"></div>
        <div class="skeleton h-8 w-3/4"></div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <div class="skeleton h-4 w-1/2 mb-2"></div>
        <div class="skeleton h-6 w-full"></div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <div class="skeleton h-4 w-1/2 mb-2"></div>
        <div class="skeleton h-6 w-full"></div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <div class="skeleton h-4 w-1/2 mb-2"></div>
        <div class="skeleton h-6 w-full"></div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <div class="skeleton h-4 w-1/2 mb-2"></div>
        <div class="space-y-1">
          <div class="skeleton h-3 w-full"></div>
          <div class="skeleton h-3 w-full"></div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <div class="skeleton h-4 w-1/2 mb-2"></div>
        <div class="space-y-1">
          <div class="skeleton h-3 w-full"></div>
          <div class="skeleton h-3 w-full"></div>
        </div>
      </div>
    </div>

    <!-- Charts Sections -->
    <div id="timeSeriesBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <h3 class="font-semibold">السلاسل الزمنية</h3>
        <select id="tsAgg" class="border rounded-lg px-3 py-2">
          <option value="day">تجميع يومي</option>
          <option value="month">تجميع شهري</option>
        </select>
        <select id="tsMetric" class="border rounded-lg px-3 py-2">
          <option value="weight">الوزن (طن)</option>
          <option value="trips">الرحلات</option>
        </select>
      </div>
      <canvas id="timeSeriesChart" height="120"></canvas>
    </div>

    <!-- Driver Analysis Section -->
    <div id="chartDriversBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <h3 class="font-semibold">أداء السائقين</h3>
        <label class="text-sm">الترتيب</label>
        <select id="driverSort" class="border rounded-lg px-3 py-2">
          <option value="weight">حسب الوزن</option>
          <option value="trips">حسب الرحلات</option>
        </select>
        <label class="text-sm">عدد السائقين (Top N)</label>
        <input id="driverTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-2">
      </div>
      <canvas id="driverChart" height="120"></canvas>
    </div>

    <!-- Driver Summary Table -->
    <div id="driverSummaryBox" class="bg-white rounded-xl shadow overflow-hidden mt-6">
      <div class="p-4 border-b">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <label class="text-sm">بحث:</label>
          <input id="dsSearch" type="text" placeholder="ابحث..." class="border rounded-lg px-3 py-1">
          <label class="text-sm">ترتيب:</label>
          <select id="dsSort" class="border rounded-lg px-3 py-1">
            <option value="weight">حسب الوزن</option>
            <option value="trips">حسب الرحلات</option>
            <option value="efficiency">حسب الكفاءة</option>
          </select>
        </div>
        <h3 class="font-semibold">ملخص السائقين</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">اسم السائق</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">إجمالي الوزن (طن)</th>
              <th class="px-4 py-2">متوسط الحمولة (طن)</th>
              <th class="px-4 py-2">كفاءة السائق %</th>
            </tr>
          </thead>
          <tbody id="driverSummary"></tbody>
        </table>
      </div>
    </div>

    <!-- Export Buttons -->
    <div class="flex flex-wrap gap-2 mb-4 mt-6">
      <button id="btnCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (الرحلات الحالية)</button>
      <button id="btnXLSX" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير Excel (رحلات + ملخص)</button>
      <button id="btnPDF" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">PDF (سجل الرحلات)</button>
    </div>

    <!-- Trips Table with Pagination -->
    <div id="rawTripsBox" class="bg-white rounded-xl shadow overflow-hidden">
      <div class="p-4 border-b">
        <h3 class="font-semibold">سجل الرحلات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 cursor-pointer" onclick="sortTable('month')">
                الشهر ↗
              </th>
              <th class="px-4 py-2 cursor-pointer" onclick="sortTable('date')">
                تاريخ التوزين الثاني ↗
              </th>
              <th class="px-4 py-2 cursor-pointer" onclick="sortTable('driver')">
                السائق ↗
              </th>
              <th class="px-4 py-2 cursor-pointer" onclick="sortTable('weight')">
                صافي التحميل (طن) ↗
              </th>
              <th class="px-4 py-2 cursor-pointer" onclick="sortTable('vehicle')">
                رقم المركبة ↗
              </th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="emptyState" class="p-6 text-center text-gray-500 hidden">لا توجد بيانات مطابقة.</div>
      
      <!-- Pagination Controls -->
      <div class="p-4 border-t flex flex-wrap items-center justify-between">
        <div class="text-sm text-gray-600">
          عرض <span id="currentStart">0</span> إلى <span id="currentEnd">0</span> من <span id="totalRecords">0</span> رحلة
        </div>
        <div class="flex gap-2 mt-2 md:mt-0">
          <button id="firstPage" class="px-3 py-1 border rounded disabled:opacity-50">الأول</button>
          <button id="prevPage" class="px-3 py-1 border rounded disabled:opacity-50">السابق</button>
          <span class="px-3 py-1">
            الصفحة <input id="currentPage" type="number" min="1" value="1" class="w-12 text-center border rounded"> من <span id="totalPages">1</span>
          </span>
          <button id="nextPage" class="px-3 py-1 border rounded disabled:opacity-50">التالي</button>
          <button id="lastPage" class="px-3 py-1 border rounded disabled:opacity-50">الأخير</button>
        </div>
        <div class="mt-2 md:mt-0">
          <select id="pageSize" class="border rounded px-3 py-1">
            <option value="10">10 رحلات/صفحة</option>
            <option value="25">25 رحلة/صفحة</option>
            <option value="50">50 رحلة/صفحة</option>
            <option value="100">100 رحلة/صفحة</option>
          </select>
        </div>
      </div>
    </div>
  </main>

<script>
/* ===== إعدادات الأعمدة ===== */
const COL = {
  month: "الشهر",
  date: "تاريخ التوزين الثاني",
  driver: "السائق",
  weight: "صافي التحميل",
  vehicle: "رقم المركبة"
};

/* ===== رابط الشيت CSV ===== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";

/* ===== متغيرات عامة ===== */
let ALL = [];
let VIEW = [];
let vehicleWeightChart = null;
let vehicleTripsChart  = null;
let timeSeriesChart    = null;
let driverChart        = null;

/* ===== رابط شيت المركبات ===== */
const VEH_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2001178330&single=true&output=csv";
let VEHICLES = [];

/* ===== متغيرات الترقيم ===== */
let currentPage = 1;
let pageSize = 10;
let totalPages = 1;
let sortField = 'date';
let sortDirection = 'desc';

/* ===== Loading Functions ===== */
function showLoading() {
  document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.add('hidden');
}

function showSkeleton() {
  document.querySelectorAll('.skeleton').forEach(el => {
    el.classList.remove('hidden');
  });
}

function hideSkeleton() {
  document.querySelectorAll('.skeleton').forEach(el => {
    el.classList.add('hidden');
  });
}

/* ===== Pagination Functions ===== */
function updatePagination() {
  const totalRecords = VIEW.length;
  totalPages = Math.ceil(totalRecords / pageSize);
  
  document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
  document.getElementById('totalPages').textContent = totalPages;
  document.getElementById('currentPage').value = currentPage;
  document.getElementById('pageSize').value = pageSize;
  
  const start = ((currentPage - 1) * pageSize) + 1;
  const end = Math.min(currentPage * pageSize, totalRecords);
  
  document.getElementById('currentStart').textContent = start.toLocaleString();
  document.getElementById('currentEnd').textContent = end.toLocaleString();
  
  // Enable/disable pagination buttons
  document.getElementById('firstPage').disabled = currentPage === 1;
  document.getElementById('prevPage').disabled = currentPage === 1;
  document.getElementById('nextPage').disabled = currentPage === totalPages;
  document.getElementById('lastPage').disabled = currentPage === totalPages;
}

function goToPage(page) {
  currentPage = Math.max(1, Math.min(page, totalPages));
  updatePagination();
  updateTable();
}

function changePageSize() {
  pageSize = parseInt(document.getElementById('pageSize').value);
  currentPage = 1;
  updatePagination();
  updateTable();
}

function sortTable(field) {
  if (sortField === field) {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    sortField = field;
    sortDirection = 'desc';
  }
  
  // Update table headers
  document.querySelectorAll('th').forEach(th => {
    th.innerHTML = th.innerHTML.replace('↗', '').replace('↘', '');
  });
  
  const currentHeader = document.querySelector(`th[onclick="sortTable('${field}')"]`);
  if (currentHeader) {
    currentHeader.innerHTML = currentHeader.innerHTML + (sortDirection === 'asc' ? ' ↗' : ' ↘');
  }
  
  applySorting();
  updateTable();
}

function applySorting() {
  VIEW.sort((a, b) => {
    let valueA = a[COL[sortField]] || '';
    let valueB = b[COL[sortField]] || '';
    
    if (sortField === 'weight') {
      valueA = toNumber(valueA);
      valueB = toNumber(valueB);
    } else if (sortField === 'date') {
      valueA = new Date(valueA);
      valueB = new Date(valueB);
    }
    
    if (sortDirection === 'asc') {
      return valueA > valueB ? 1 : -1;
    } else {
      return valueA < valueB ? 1 : -1;
    }
  });
}

/* ===== Driver Analysis Functions ===== */
function updateDriverAnalysis() {
  const driverWeight = {};
  const driverTrips = {};
  const driverVehicles = {};
  
  VIEW.forEach(r => {
    const driver = r[COL.driver] || 'بدون سائق';
    const weight = toNumber(r[COL.weight]);
    const vehicle = r[COL.vehicle] || '';
    
    driverWeight[driver] = (driverWeight[driver] || 0) + weight;
    driverTrips[driver] = (driverTrips[driver] || 0) + 1;
    
    if (!driverVehicles[driver]) driverVehicles[driver] = new Set();
    if (vehicle) driverVehicles[driver].add(vehicle);
  });
  
  // Apply local filters
  const dsQuery = document.getElementById('dsSearch').value.toLowerCase();
  const dsSort = document.getElementById('dsSort').value;
  
  let driverData = Object.keys(driverTrips).map(driver => ({
    driver,
    trips: driverTrips[driver] || 0,
    weight: (driverWeight[driver] || 0) / 1000,
    avgWeight: driverTrips[driver] ? (driverWeight[driver] / 1000) / driverTrips[driver] : 0,
    efficiency: driverTrips[driver] ? ((driverWeight[driver] / 1000) / driverTrips[driver]) * 100 : 0,
    vehicles: Array.from(driverVehicles[driver] || []).join(', ')
  }));
  
  // Apply search filter
  if (dsQuery) {
    driverData = driverData.filter(d => 
      d.driver.toLowerCase().includes(dsQuery) || 
      d.vehicles.toLowerCase().includes(dsQuery)
    );
  }
  
  // Apply sorting
  driverData.sort((a, b) => {
    if (dsSort === 'weight') return b.weight - a.weight;
    if (dsSort === 'trips') return b.trips - a.trips;
    if (dsSort === 'efficiency') return b.efficiency - a.efficiency;
    return 0;
  });
  
  // Update driver summary table
  const tbody = document.getElementById('driverSummary');
  tbody.innerHTML = '';
  
  driverData.forEach(row => {
    const tr = document.createElement('tr');
    tr.className = 'border-b hover:bg-gray-50';
    tr.innerHTML = `
      <td class="px-4 py-2">${row.driver}</td>
      <td class="px-4 py-2">${row.trips}</td>
      <td class="px-4 py-2">${row.weight.toFixed(2)}</td>
      <td class="px-4 py-2">${row.avgWeight.toFixed(2)}</td>
      <td class="px-4 py-2">${row.efficiency.toFixed(1)}%</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===== KPIs + Charts ===== */
function updateKPIs() {
  const trips = VIEW.length;
  const totalWkg = VIEW.reduce((s, r) => s + toNumber(r[COL.weight]), 0);
  const avgWkg = trips ? (totalWkg / trips) : 0;
  const drivers = new Set(VIEW.map(r => r[COL.driver]).filter(Boolean));

  document.getElementById("k_trips").textContent = trips.toLocaleString();
  document.getElementById("k_weight").textContent = formatTonFromKg(totalWkg) + " طن";
  document.getElementById("k_avg").textContent = formatTonFromKg(avgWkg) + " طن";
  document.getElementById("k_drivers").textContent = drivers.size.toLocaleString();

  // متوسطات يومية/شهرية
  const uniqueDays = new Set(VIEW.map(r => r[COL.date]).filter(Boolean));
  const daysCount = uniqueDays.size;
  const avgDailyWeight = daysCount ? (totalWkg / 1000) / daysCount : 0;
  const avgDailyTrips = daysCount ? trips / daysCount : 0;

  const monthKeys = new Set();
  VIEW.forEach(r => {
    let key = null;
    if (r[COL.date]) {
      const dt = new Date(r[COL.date]);
      if (!isNaN(dt)) key = toYM(dt);
    }
    if (!key && r[COL.month]) key = String(r[COL.month]).trim();
    if (key) monthKeys.add(key);
  });
  const monthsCount = monthKeys.size;
  const avgMonthlyWeight = monthsCount ? (totalWkg / 1000) / monthsCount : 0;
  const avgMonthlyTrips = monthsCount ? trips / monthsCount : 0;

  document.getElementById("k_avgDailyWeight").textContent = avgDailyWeight.toFixed(2);
  document.getElementById("k_avgDailyTrips").textContent = avgDailyTrips.toFixed(1);
  document.getElementById("k_avgMonthlyWeight").textContent = avgMonthlyWeight.toFixed(2);
  document.getElementById("k_avgMonthlyTrips").textContent = avgMonthlyTrips.toFixed(1);

  // تجميع حسب المركبة + حفظ السائقين
  const byVehicleWeight = {};
  const byVehicleTrips = {};
  const vehicleDrivers = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle] || "مجهولة";
    const d = r[COL.driver] || "بدون سائق";
    byVehicleWeight[v] = (byVehicleWeight[v] || 0) + toNumber(r[COL.weight]);
    byVehicleTrips[v] = (byVehicleTrips[v] || 0) + 1;
    if (!vehicleDrivers[v]) vehicleDrivers[v] = new Set();
    vehicleDrivers[v].add(d);
  });

  // كروت "الأكثر"
  let topVehicleWeight = "-";
  if (Object.keys(byVehicleWeight).length > 0) {
    topVehicleWeight = Object.entries(byVehicleWeight).sort((a, b) => b[1] - a[1])[0][0];
  }
  document.getElementById("k_topVehicleWeight").textContent = topVehicleWeight;

  let topVehicleTrips = "-";
  if (Object.keys(byVehicleTrips).length > 0) {
    topVehicleTrips = Object.entries(byVehicleTrips).sort((a, b) => b[1] - a[1])[0][0];
  }
  document.getElementById("k_topVehicleTrips").textContent = topVehicleTrips;

  // اليوم الأعلى وزناً
  const byDate = {};
  VIEW.forEach(r => {
    const d = r[COL.date];
    if (!d) return;
    byDate[d] = (byDate[d] || 0) + toNumber(r[COL.weight]);
  });
  let topDay = "-";
  if (Object.keys(byDate).length > 0) {
    topDay = Object.entries(byDate).sort((a, b) => b[1] - a[1])[0][0];
  }
  document.getElementById("k_topDay").textContent = topDay;
}

/* ===== أدوات مساعدة ===== */
function toNumber(v) {
  if (v == null) return 0;
  let s = String(v).trim();
  const arabicMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
  s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
  s = s.replace(/[^\d.]/g, "");
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

function formatTonFromKg(kg) {
  const t = kg / 1000;
  return t.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function toYMD(dt) {
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, '0');
  const d = String(dt.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function toYM(dt) {
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, '0');
  return `${y}-${m}`;
}

/* ===== فلترة ===== */
function applyFilters() {
  const q = document.getElementById("q").value.trim();
  const m = document.getElementById("monthSelect").value;
  const v = document.getElementById("vehicleSelect").value;
  const d = document.getElementById("driverSelect").value;
  const date = document.getElementById("dateExact").value;

  VIEW = ALL.filter(r => {
    const byMonth = m ? (String(r[COL.month] || "").trim() === m) : true;
    const byVehicle = v ? (String(r[COL.vehicle] || "").trim() === v) : true;
    const byDriver = d ? (String(r[COL.driver] || "").trim() === d) : true;

    let byDate = true;
    if (date) {
      if (!r[COL.date]) {
        byDate = false;
      } else {
        const recordDate = new Date(r[COL.date]);
        const exactDate = new Date(date);
        byDate = recordDate.toDateString() === exactDate.toDateString();
      }
    }

    if (!byMonth || !byVehicle || !byDriver || !byDate) return false;

    if (!q) return true;
    const hay = [r[COL.month], r[COL.date], r[COL.driver], r[COL.weight], r[COL.vehicle]]
      .map(x => (x == null ? "" : String(x))).join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  });
  
  applySorting();
  currentPage = 1;
  updatePagination();
}

/* ===== تعبئة القوائم ===== */
function fillSelects() {
  fillMonthSelect();
  fillVehicleSelect();
  fillDriverSelect();
}

function fillMonthSelect() {
  const sel = document.getElementById("monthSelect");
  sel.innerHTML = '<option value="">الكل</option>';
  const months = Array.from(new Set(ALL.map(r => r[COL.month]).filter(Boolean)));
  months.forEach(m => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = m;
    sel.appendChild(opt);
  });
}

function fillVehicleSelect() {
  const sel = document.getElementById("vehicleSelect");
  sel.innerHTML = '<option value="">الكل</option>';
  const vehicles = Array.from(new Set(ALL.map(r => r[COL.vehicle]).filter(Boolean)));
  vehicles.forEach(v => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = v;
    sel.appendChild(opt);
  });
}

function fillDriverSelect() {
  const sel = document.getElementById("driverSelect");
  sel.innerHTML = '<option value="">الكل</option>';
  const drivers = Array.from(new Set(ALL.map(r => r[COL.driver]).filter(Boolean)));
  drivers.forEach(d => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = d;
    sel.appendChild(opt);
  });
}

/* ===== جدول الرحلات ===== */
function updateTable() {
  showLoading();
  
  setTimeout(() => {
    const tb = document.getElementById("tbody");
    const empty = document.getElementById("emptyState");
    tb.innerHTML = "";
    
    if (VIEW.length === 0) {
      empty.classList.remove("hidden");
      hideLoading();
      return;
    }
    
    empty.classList.add("hidden");
    
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageData = VIEW.slice(start, end);
    
    pageData.forEach(r => {
      const tr = document.createElement("tr");
      tr.className = "border-b hover:bg-gray-50";
      tr.innerHTML = `
        <td class="px-4 py-2">${r[COL.month] || ""}</td>
        <td class="px-4 py-2">${r[COL.date] || ""}</td>
        <td class="px-4 py-2">${r[COL.driver] || ""}</td>
        <td class="px-4 py-2">${formatTonFromKg(toNumber(r[COL.weight]))}</td>
        <td class="px-4 py-2">${r[COL.vehicle] || ""}</td>
      `;
      tb.appendChild(tr);
    });
    
    hideLoading();
  }, 100);
}

/* ===== Render ===== */
function render() {
  showSkeleton();
  showLoading();
  
  setTimeout(() => {
    applyFilters();
    updateKPIs();
    updateTable();
    updateDriverAnalysis();
    hideSkeleton();
    hideLoading();
  }, 300);
}

/* ===== تحميل البيانات ===== */
async function loadData() {
  showLoading();
  
  try {
    const result = await new Promise((resolve, reject) => {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: resolve,
        error: reject
      });
    });
    
    ALL = result.data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => {
        const kk = (k || "").trim();
        obj[kk] = (row[k] == null ? "" : String(row[k]).trim());
      });
      return obj;
    });
    
    fillSelects();
    render();
    hideLoading();
    
  } catch (e) {
    console.error("خطأ في جلب/قراءة الشيت:", e);
    alert("تعذر تحميل البيانات من الشيت.");
    hideLoading();
  }
}

/* ===== Events ===== */
document.addEventListener("DOMContentLoaded", () => {
  loadData();
  
  // Pagination events
  document.getElementById('firstPage').addEventListener('click', () => goToPage(1));
  document.getElementById('prevPage').addEventListener('click', () => goToPage(currentPage - 1));
  document.getElementById('nextPage').addEventListener('click', () => goToPage(currentPage + 1));
  document.getElementById('lastPage').addEventListener('click', () => goToPage(totalPages));
  document.getElementById('currentPage').addEventListener('change', (e) => goToPage(parseInt(e.target.value)));
  document.getElementById('pageSize').addEventListener('change', changePageSize);
  
  // Filter events
  document.getElementById("q").addEventListener("input", render);
  document.getElementById("monthSelect").addEventListener("change", render);
  document.getElementById("vehicleSelect").addEventListener("change", render);
  document.getElementById("driverSelect").addEventListener("change", render);
  document.getElementById("dateExact").addEventListener("change", render);
  
  document.getElementById("resetBtn").addEventListener("click", () => {
    document.getElementById("q").value = "";
    document.getElementById("monthSelect").value = "";
    document.getElementById("vehicleSelect").value = "";
    document.getElementById("driverSelect").value = "";
    document.getElementById("dateExact").value = "";
    render();
  });
  
  // Driver analysis events
  document.getElementById('dsSearch').addEventListener('input', updateDriverAnalysis);
  document.getElementById('dsSort').addEventListener('change', updateDriverAnalysis);
});
</script>
</body>
</html>
