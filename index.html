<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-blue-600 text-white p-6 shadow">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <!-- Filters -->
    <div class="bg-white rounded-xl shadow p-4 mb-6 grid grid-cols-1 md:grid-cols-5 gap-4">
      <div>
        <label class="block text-sm mb-1">بحث عام</label>
        <input id="q" type="text" placeholder="ابحث بتاريخ أو سائق أو رقم مركبة..."
               class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>
      <div>
        <label class="block text-sm mb-1">الشهر</label>
        <select id="monthSelect" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <option value="">الكل</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">رقم المركبة</label>
        <select id="vehicleSelect" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <option value="">الكل</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">التاريخ</label>
        <input id="dateExact" type="date"
               class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>
      <div class="flex items-end">
        <button id="resetBtn" class="w-full md:w-auto bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">
          إعادة تعيين الفلاتر
        </button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-7 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">إجمالي الرحلات</p>
        <h3 id="k_trips" class="text-2xl font-bold text-blue-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">إجمالي الوزن</p>
        <h3 id="k_weight" class="text-2xl font-bold text-green-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط حمولة الرحلة</p>
        <h3 id="k_avg" class="text-2xl font-bold text-purple-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">عدد السائقين</p>
        <h3 id="k_drivers" class="text-2xl font-bold text-orange-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">أكثر مركبة (وزن)</p>
        <h3 id="k_topVehicleWeight" class="text-xl font-bold text-red-600">-</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">أكثر مركبة (رحلات)</p>
        <h3 id="k_topVehicleTrips" class="text-xl font-bold text-indigo-600">-</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">اليوم الأعلى وزناً</p>
        <h3 id="k_topDay" class="text-xl font-bold text-pink-600">-</h3>
      </div>
    </div>

    <!-- Chart -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
      <h3 class="mb-4 font-semibold">وزن النقل حسب المركبة (بالطن)</h3>
      <canvas id="vehicleWeightChart" height="120"></canvas>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-xl shadow overflow-hidden">
      <div class="p-4 border-b">
        <h3 class="font-semibold">سجل الرحلات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">الشهر</th>
              <th class="px-4 py-2">تاريخ التوزين الثاني</th>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">صافي التحميل (طن)</th>
              <th class="px-4 py-2">رقم المركبة</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="emptyState" class="p-6 text-center text-gray-500 hidden">لا توجد بيانات مطابقة.</div>
    </div>
  </main>

<script>
const COL = {
  month: "الشهر",
  date: "تاريخ التوزين الثاني",
  driver: "السائق",
  weight: "صافي التحميل",
  vehicle: "رقم المركبة"
};

const CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";

let ALL = [];
let VIEW = [];
let vehicleWeightChart = null;

function toNumber(v) {
  if (v == null) return 0;
  let s = String(v).trim();
  const arabicMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
  s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
  s = s.replace(/[^\d.]/g, "");
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

function applyFilters() {
  const q = document.getElementById("q").value.trim();
  const m = document.getElementById("monthSelect").value;
  const v = document.getElementById("vehicleSelect").value;
  const d = document.getElementById("dateExact").value;

  VIEW = ALL.filter(r => {
    const byMonth   = m ? (String(r[COL.month] || "").trim() === m) : true;
    const byVehicle = v ? (String(r[COL.vehicle] || "").trim() === v) : true;

    let byDate = true;
    if (d) {
      if (!r[COL.date]) {
        byDate = false;
      } else {
        const recordDate = new Date(r[COL.date]);
        const exactDate  = new Date(d);
        byDate = recordDate.toDateString() === exactDate.toDateString();
      }
    }

    if (!byMonth || !byVehicle || !byDate) return false;

    if (!q) return true;
    const hay = [r[COL.month], r[COL.date], r[COL.driver], r[COL.weight], r[COL.vehicle]]
      .map(x => (x==null?"":String(x))).join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  });
}

function updateKPIs() {
  const trips = VIEW.length;
  const totalW = VIEW.reduce((s,r)=> s + toNumber(r[COL.weight]), 0);
  const avgW = trips ? Math.round(totalW / trips) : 0;
  const drivers = new Set(VIEW.map(r => r[COL.driver]).filter(Boolean));

  document.getElementById("k_trips").textContent  = trips.toLocaleString();
  document.getElementById("k_weight").textContent = (totalW/1000).toFixed(2).toLocaleString() + " طن";
  document.getElementById("k_avg").textContent    = (avgW/1000).toFixed(2).toLocaleString() + " طن";
  document.getElementById("k_drivers").textContent= drivers.size.toLocaleString();

  // أكثر مركبة وزن
  const byVehicleWeight = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle];
    if (!v) return;
    byVehicleWeight[v] = (byVehicleWeight[v] || 0) + toNumber(r[COL.weight]);
  });
  let topVehicleWeight = "-";
  if (Object.keys(byVehicleWeight).length > 0) {
    topVehicleWeight = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topVehicleWeight").textContent = topVehicleWeight;

  // أكثر مركبة رحلات
  const byVehicleTrips = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle];
    if (!v) return;
    byVehicleTrips[v] = (byVehicleTrips[v] || 0) + 1;
  });
  let topVehicleTrips = "-";
  if (Object.keys(byVehicleTrips).length > 0) {
    topVehicleTrips = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topVehicleTrips").textContent = topVehicleTrips;

  // اليوم الأعلى وزناً
  const byDate = {};
  VIEW.forEach(r => {
    const d = r[COL.date];
    if (!d) return;
    byDate[d] = (byDate[d] || 0) + toNumber(r[COL.weight]);
  });
  let topDay = "-";
  if (Object.keys(byDate).length > 0) {
    topDay = Object.entries(byDate).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topDay").textContent = topDay;

  // تحديث الرسم البياني (وزن حسب المركبة)
  if (vehicleWeightChart) {
    vehicleWeightChart.destroy();
  }
  const labels = Object.keys(byVehicleWeight);
  const data = Object.values(byVehicleWeight).map(v => (v/1000).toFixed(2));
  const ctx = document.getElementById("vehicleWeightChart").getContext("2d");
  vehicleWeightChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: "الوزن الكلي (طن)",
        data: data,
        backgroundColor: "rgba(59,130,246,0.7)"
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: "المركبة" } },
        y: { title: { display: true, text: "الوزن (طن)" } }
      }
    }
  });
}

function updateTable() {
  const tb = document.getElementById("tbody");
  const empty = document.getElementById("emptyState");
  tb.innerHTML = "";
  if (VIEW.length === 0) {
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");
  VIEW.forEach(r => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-4 py-2">${r[COL.month] || ""}</td>
      <td class="px-4 py-2">${r[COL.date] || ""}</td>
      <td class="px-4 py-2">${r[COL.driver] || ""}</td>
      <td class="px-4 py-2">${(toNumber(r[COL.weight])/1000).toFixed(2)}</td>
      <td class="px-4 py-2">${r[COL.vehicle] || ""}</td>
    `;
    tb.appendChild(tr);
  });
}

function fillMonthSelect() {
  const sel = document.getElementById("monthSelect");
  const months = Array.from(new Set(ALL.map(r => r[COL.month]).filter(Boolean)));
  months.forEach(m => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = m;
    sel.appendChild(opt);
  });
}

function fillVehicleSelect() {
  const sel = document.getElementById("vehicleSelect");
  const vehicles = Array.from(new Set(ALL.map(r => r[COL.vehicle]).filter(Boolean)));
  vehicles.forEach(v => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = v;
    sel.appendChild(opt);
  });
}

function render() {
  applyFilters();
  updateKPIs();
  updateTable();
}

async function loadData() {
  try {
    const result = await new Promise((resolve, reject) => {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: resolve,
        error: reject
      });
    });
    ALL = result.data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => {
        const kk = (k || "").trim();
        obj[kk] = (row[k] == null ? "" : String(row[k]).trim());
      });
      return obj;
    });
    fillMonthSelect();
    fillVehicleSelect();
    render();
  } catch (e) {
    console.error("خطأ في جلب/قراءة الشيت:", e);
    alert("تعذر تحميل البيانات من الشيت.");
  }
}

document.getElementById("q").addEventListener("input", render);
document.getElementById("monthSelect").addEventListener("change", render);
document.getElementById("vehicleSelect").addEventListener("change", render);
document.getElementById("dateExact").addEventListener("change", render);
document.getElementById("resetBtn").addEventListener("click", () => {
  document.getElementById("q").value = "";
  document.getElementById("monthSelect").value = "";
  document.getElementById("vehicleSelect").value = "";
  document.getElementById("dateExact").value = "";
  render();
});

document.addEventListener("DOMContentLoaded", loadData);
</script>
</body>
</html>
