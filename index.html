<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    /* تخصيص شريط تمرير بسيط */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }

    .transition-max-height {
      transition: max-height 0.5s ease-in-out;
    }
    .rotate-180 {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-75 transition-opacity duration-300 ease-in-out hidden">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
      <p class="mt-4 text-lg text-blue-500">جاري تحميل البيانات...</p>
    </div>
  </div>

  <div class="container mx-auto p-4">
    <header class="bg-blue-600 text-white p-6 rounded-lg shadow-lg text-center">
      <h1 class="text-3xl font-bold mb-2">لوحة بيانات النقل</h1>
      <p class="text-xl">بلدية مؤتة والمزار</p>
    </header>

    <div class="bg-white p-4 my-6 rounded-lg shadow-md flex flex-wrap items-center justify-center gap-4">
      <input type="text" id="generalSearch" placeholder="بحث عام..." class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      
      <div class="relative inline-block text-right">
        <button id="dateFilterBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
          تصفية التاريخ
        </button>
        <div id="dateFilterMenu" class="absolute z-10 mt-2 w-56 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 hidden p-4" role="menu" aria-orientation="vertical">
          <div class="flex items-center space-x-2 space-x-reverse mb-2">
            <label for="startDate" class="text-sm">من:</label>
            <input type="date" id="startDate" class="p-1 border rounded w-full">
          </div>
          <div class="flex items-center space-x-2 space-x-reverse">
            <label for="endDate" class="text-sm">إلى:</label>
            <input type="date" id="endDate" class="p-1 border rounded w-full">
          </div>
          <div class="flex justify-between mt-4">
            <button id="applyDate" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">تطبيق</button>
            <button id="clearDate" class="bg-red-500 text-white px-3 py-1 rounded text-sm">مسح</button>
          </div>
        </div>
      </div>

      <div class="relative inline-block text-right">
        <button id="monthDropdownBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">الشهور</button>
        <div id="monthDropdownMenu" class="absolute z-10 mt-2 w-56 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 hidden p-2" role="menu" aria-orientation="vertical">
          <div class="flex justify-between mb-2">
            <button id="monthSelectAll" class="text-blue-500 text-sm hover:underline">تحديد الكل</button>
            <button id="monthClearAll" class="text-red-500 text-sm hover:underline">مسح الكل</button>
          </div>
          <div id="monthCheckboxes" class="max-h-60 overflow-y-auto"></div>
        </div>
      </div>

      <div class="relative inline-block text-right">
        <button id="vehicleDropdownBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">المركبات</button>
        <div id="vehicleDropdownMenu" class="absolute z-10 mt-2 w-56 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 hidden p-2" role="menu" aria-orientation="vertical">
          <div class="flex justify-between mb-2">
            <button id="vehSelectAll" class="text-blue-500 text-sm hover:underline">تحديد الكل</button>
            <button id="vehClearAll" class="text-red-500 text-sm hover:underline">مسح الكل</button>
          </div>
          <div id="vehicleCheckboxes" class="max-h-60 overflow-y-auto"></div>
        </div>
      </div>

      <button id="resetBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-700">إعادة تعيين</button>
      <button id="exportExcelBtn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-700">تصدير Excel</button>
      <button id="exportPdfBtn" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-700">تصدير PDF</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 my-6">
      <div class="bg-white p-4 rounded-lg shadow-md text-center">
        <p class="text-sm text-gray-500">إجمالي الرحلات</p>
        <p id="totalTrips" class="text-2xl font-bold text-blue-600">0</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-md text-center">
        <p class="text-sm text-gray-500">إجمالي الوزن المنقول (طن)</p>
        <p id="totalWeight" class="text-2xl font-bold text-green-600">0</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-md text-center">
        <p class="text-sm text-gray-500">كلفة الوقود (دينار)</p>
        <p id="totalFuelCost" class="text-2xl font-bold text-red-600">0</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-md text-center">
        <p class="text-sm text-gray-500">متوسط كلفة الصيانة (دينار)</p>
        <p id="avgMaintenanceCost" class="text-2xl font-bold text-yellow-600">0</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-md text-center">
        <p class="text-sm text-gray-500">عدد المركبات الفعالة</p>
        <p id="activeVehicles" class="text-2xl font-bold text-blue-600">0</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-md text-center">
        <p class="text-sm text-gray-500">عدد السائقين الفعالين</p>
        <p id="activeDrivers" class="text-2xl font-bold text-green-600">0</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-md text-center">
        <p class="text-sm text-gray-500">متوسط الوزن اليومي (طن)</p>
        <p id="avgDailyWeight" class="text-2xl font-bold text-red-600">0</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-md text-center">
        <p class="text-sm text-gray-500">متوسط الوزن الشهري (طن)</p>
        <p id="avgMonthlyWeight" class="text-2xl font-bold text-yellow-600">0</p>
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      
      <div class="p-4 bg-white rounded-lg shadow-md transition-all duration-300">
        <div class="flex items-center justify-between cursor-pointer" onclick="toggleSection('vehicleAnalysis')">
          <h2 class="text-xl font-bold">تحليل كفاءة المركبات</h2>
          <svg id="icon-vehicleAnalysis" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 transition-transform transform rotate-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div id="content-vehicleAnalysis" class="mt-4 transition-max-height duration-500 ease-in-out overflow-hidden" style="max-height: 0;">
          <div class="overflow-x-auto">
            <table id="vehicleAnalysisTable" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المركبة</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجمالي الرحلات</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجمالي الوزن (طن)</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">متوسط الوزن (طن/رحلة)</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">كلفة الوقود (دينار)</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">متوسط الصيانة (دينار/شهر)</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200" id="vehicleAnalysisBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="p-4 bg-white rounded-lg shadow-md transition-all duration-300">
        <div class="flex items-center justify-between cursor-pointer" onclick="toggleSection('driverAnalysis')">
          <h2 class="text-xl font-bold">تحليل أداء السائقين</h2>
          <svg id="icon-driverAnalysis" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 transition-transform transform rotate-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div id="content-driverAnalysis" class="mt-4 transition-max-height duration-500 ease-in-out overflow-hidden" style="max-height: 0;">
          <div class="overflow-x-auto">
            <table id="driverAnalysisTable" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">السائق</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجمالي الرحلات</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجمالي الوزن (طن)</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">متوسط الوزن (طن/رحلة)</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200" id="driverAnalysisBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="p-4 bg-white rounded-lg shadow-md transition-all duration-300">
        <div class="flex items-center justify-between cursor-pointer" onclick="toggleSection('vehicleDistribution')">
          <h2 class="text-xl font-bold">توزيع النقل على المركبات</h2>
          <svg id="icon-vehicleDistribution" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 transition-transform transform rotate-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div id="content-vehicleDistribution" class="mt-4 transition-max-height duration-500 ease-in-out overflow-hidden" style="max-height: 0;">
          <canvas id="vehicleWeightChart"></canvas>
        </div>
      </div>

      <div class="p-4 bg-white rounded-lg shadow-md transition-all duration-300">
        <div class="flex items-center justify-between cursor-pointer" onclick="toggleSection('monthlyWeight')">
          <h2 class="text-xl font-bold">الوزن حسب الشهور</h2>
          <svg id="icon-monthlyWeight" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 transition-transform transform rotate-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div id="content-monthlyWeight" class="mt-4 transition-max-height duration-500 ease-in-out overflow-hidden" style="max-height: 0;">
          <canvas id="monthlyWeightChart"></canvas>
        </div>
      </div>
      
      <div class="p-4 bg-white rounded-lg shadow-md transition-all duration-300">
        <div class="flex items-center justify-between cursor-pointer" onclick="toggleSection('monthlyTrips')">
          <h2 class="text-xl font-bold">عدد الرحلات حسب الشهور</h2>
          <svg id="icon-monthlyTrips" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 transition-transform transform rotate-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div id="content-monthlyTrips" class="mt-4 transition-max-height duration-500 ease-in-out overflow-hidden" style="max-height: 0;">
          <canvas id="monthlyTripsChart"></canvas>
        </div>
      </div>

      <div class="p-4 bg-white rounded-lg shadow-md transition-all duration-300">
        <div class="flex items-center justify-between cursor-pointer" onclick="toggleSection('tripDistribution')">
          <h2 class="text-xl font-bold">توزيع الرحلات على المركبات</h2>
          <svg id="icon-tripDistribution" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 transition-transform transform rotate-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div id="content-tripDistribution" class="mt-4 transition-max-height duration-500 ease-in-out overflow-hidden" style="max-height: 0;">
          <canvas id="tripDistributionChart"></canvas>
        </div>
      </div>

    </div>

    <div class="mt-8 p-4 bg-white rounded-lg shadow-md transition-all duration-300">
      <div class="flex items-center justify-between cursor-pointer" onclick="toggleSection('tripLog')">
        <h2 class="text-xl font-bold">سجل الرحلات</h2>
        <svg id="icon-tripLog" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 transition-transform transform rotate-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <div id="content-tripLog" class="mt-4 transition-max-height duration-500 ease-in-out overflow-hidden" style="max-height: 0;">
        <div class="overflow-x-auto">
          <table id="tripTable" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المركبة</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">السائق</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نوع الحمولة</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">جهة الوصول</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الوزن (طن)</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="tripTableBody"></tbody>
          </table>
          <div class="flex justify-between items-center mt-4">
            <div id="pagination-info" class="text-sm text-gray-700"></div>
            <div id="pagination-controls" class="flex space-x-2 space-x-reverse">
              <button id="prev-page" class="px-3 py-1 bg-gray-200 rounded-md text-sm">السابق</button>
              <button id="next-page" class="px-3 py-1 bg-gray-200 rounded-md text-sm">التالي</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== البيانات الأولية ===== */
    const DATA_URLS = {
      trips: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1gT0U0L8j4xXyE0s1G8Tz-z8-z-z-z-z-z/pub?output=csv",
      vehicles: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1gT0U0L8j4xXyE0s1G8Tz-z8-z-z-z-z-z/pub?output=csv",
      fuel: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1gT0U0L8j4xXyE0s1G8Tz-z8-z-z-z-z-z/pub?output=csv",
      maintenance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1gT0U0L8j4xXyE0s1G8Tz-z8-z-z-z-z-z/pub?output=csv"
    };

    let tripsData = [];
    let vehiclesData = [];
    let fuelData = [];
    let maintenanceData = [];
    let filteredTrips = [];
    const COLUMNS = {
      trips: {
        date: 'التاريخ', vehicle: 'المركبة', driver: 'السائق', cargo: 'نوع الحمولة', destination: 'جهة الوصول', weight: 'الوزن بالطن'
      },
      vehicles: { id: 'المركبة' },
      fuel: { vehicle: 'المركبة', cost: 'الكلفة', date: 'التاريخ' },
      maintenance: { vehicle: 'المركبة', cost: 'الكلفة', date: 'التاريخ' }
    };

    let currentPage = 1;
    const rowsPerPage = 10;

    /* ===== دوال مساعدة ===== */
    function setLoading(isLoading) {
      document.getElementById('loading-overlay').style.display = isLoading ? 'flex' : 'none';
    }

    function toArabicMonths(monthNum) {
      const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
      return months[monthNum - 1];
    }
    
    function formatNumber(num) {
      return new Intl.NumberFormat('ar-SA').format(num);
    }
    
    function parseArabicNumber(str) {
      if (typeof str !== 'string') return str;
      const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
      const latinNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
      return parseFloat(str.split('').map(c => {
        const index = arabicNumbers.indexOf(c);
        return index !== -1 ? latinNumbers[index] : c;
      }).join('').replace(',', ''));
    }

    /* ===== دمج البيانات ===== */
    function combineData() {
      if (tripsData.length === 0 || fuelData.length === 0 || maintenanceData.length === 0) {
        console.error("Data not fully loaded.");
        return;
      }
      tripsData.forEach(trip => {
        const tripDate = new Date(trip[COLUMNS.trips.date]);
        const tripMonth = tripDate.getMonth() + 1;
        const tripYear = tripDate.getFullYear();
        const tripVehicle = trip[COLUMNS.trips.vehicle];
        
        trip.fuelCost = fuelData
          .filter(f => f[COLUMNS.fuel.vehicle] === tripVehicle)
          .reduce((sum, f) => sum + (parseArabicNumber(f[COLUMNS.fuel.cost]) || 0), 0) / 12;

        trip.maintenanceCost = maintenanceData
          .filter(m => m[COLUMNS.maintenance.vehicle] === tripVehicle)
          .reduce((sum, m) => sum + (parseArabicNumber(m[COLUMNS.maintenance.cost]) || 0), 0) / 12;
      });
    }

    /* ===== تحميل البيانات ===== */
    async function fetchCSV(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (results) => resolve(results.data),
          error: (error) => reject(error)
        });
      });
    }

    async function loadAllData() {
      try {
        setLoading(true);
        const [trips, vehicles, fuel, maintenance] = await Promise.all([
          fetchCSV(DATA_URLS.trips),
          fetchCSV(DATA_URLS.vehicles),
          fetchCSV(DATA_URLS.fuel),
          fetchCSV(DATA_URLS.maintenance)
        ]);
        tripsData = trips;
        vehiclesData = vehicles;
        fuelData = fuel;
        maintenanceData = maintenance;
        combineData();
        setupFilters();
        render();
      } catch (error) {
        console.error("Failed to load data:", error);
        alert("فشل تحميل البيانات. يرجى التأكد من أن الروابط صحيحة.");
      } finally {
        setLoading(false);
      }
    }

    /* ===== إعداد الفلاتر ===== */
    function setupFilters() {
      const allVehicles = [...new Set(tripsData.map(d => d[COLUMNS.trips.vehicle]))].sort();
      const allMonths = [...new Set(tripsData.map(d => new Date(d[COLUMNS.trips.date]).getMonth() + 1))].sort((a,b) => a-b);
      
      const vehicleCheckboxes = document.getElementById('vehicleCheckboxes');
      vehicleCheckboxes.innerHTML = allVehicles.map(v => `
        <div class="flex items-center">
          <input type="checkbox" id="veh-${v}" value="${v}" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" onchange="render()">
          <label for="veh-${v}" class="ml-2 mr-2 text-sm text-gray-700">${v}</label>
        </div>
      `).join('');
      
      const monthCheckboxes = document.getElementById('monthCheckboxes');
      monthCheckboxes.innerHTML = allMonths.map(m => `
        <div class="flex items-center">
          <input type="checkbox" id="month-${m}" value="${m}" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" onchange="render()">
          <label for="month-${m}" class="ml-2 mr-2 text-sm text-gray-700">${toArabicMonths(m)}</label>
        </div>
      `).join('');
    }

    function updateDropdownButtonText(menuId, buttonId, defaultText) {
      const checkedBoxes = document.querySelectorAll(`#${menuId} input[type='checkbox']:checked`);
      const button = document.getElementById(buttonId);
      if (checkedBoxes.length === 0) {
        button.textContent = `لا يوجد`;
      } else if (checkedBoxes.length === document.querySelectorAll(`#${menuId} input[type='checkbox']`).length) {
        button.textContent = defaultText;
      } else {
        button.textContent = `${checkedBoxes.length} مختار`;
      }
    }

    /* ===== تطبيق الفلاتر ===== */
    function applyFilters() {
      const generalSearchText = document.getElementById('generalSearch').value.toLowerCase();
      const selectedMonths = Array.from(document.querySelectorAll("#monthCheckboxes input[type='checkbox']:checked")).map(cb => parseInt(cb.value));
      const selectedVehicles = Array.from(document.querySelectorAll("#vehicleCheckboxes input[type='checkbox']:checked")).map(cb => cb.value);
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      filteredTrips = tripsData.filter(trip => {
        const tripDate = new Date(trip[COLUMNS.trips.date]);
        const tripMonth = tripDate.getMonth() + 1;
        const tripVehicle = trip[COLUMNS.trips.vehicle];
        const tripDataString = Object.values(trip).join(' ').toLowerCase();
        
        const matchesSearch = generalSearchText === '' || tripDataString.includes(generalSearchText);
        const matchesMonth = selectedMonths.includes(tripMonth);
        const matchesVehicle = selectedVehicles.includes(tripVehicle);
        const matchesDateRange = (!startDate || tripDate >= new Date(startDate)) && (!endDate || tripDate <= new Date(endDate));
        
        return matchesSearch && matchesMonth && matchesVehicle && matchesDateRange;
      });
    }

    /* ===== تحديث المؤشرات الرئيسية (KPIs) ===== */
    function updateKPIs() {
      const totalTrips = filteredTrips.length;
      const totalWeight = filteredTrips.reduce((sum, trip) => sum + (parseArabicNumber(trip[COLUMNS.trips.weight]) || 0), 0);
      const totalFuelCost = filteredTrips.reduce((sum, trip) => sum + (trip.fuelCost || 0), 0);
      
      const uniqueVehicles = [...new Set(filteredTrips.map(trip => trip[COLUMNS.trips.vehicle]))];
      const uniqueDrivers = [...new Set(filteredTrips.map(trip => trip[COLUMNS.trips.driver]))];
      const uniqueMonths = [...new Set(filteredTrips.map(d => new Date(d[COLUMNS.trips.date]).getMonth()))];

      const avgDailyWeight = totalTrips > 0 ? totalWeight / (uniqueMonths.length * 30) : 0;
      const avgMonthlyWeight = totalTrips > 0 ? totalWeight / uniqueMonths.length : 0;
      
      document.getElementById('totalTrips').textContent = formatNumber(totalTrips);
      document.getElementById('totalWeight').textContent = formatNumber(totalWeight.toFixed(2));
      document.getElementById('totalFuelCost').textContent = formatNumber(totalFuelCost.toFixed(2));
      document.getElementById('activeVehicles').textContent = formatNumber(uniqueVehicles.length);
      document.getElementById('activeDrivers').textContent = formatNumber(uniqueDrivers.length);
      document.getElementById('avgDailyWeight').textContent = formatNumber(avgDailyWeight.toFixed(2));
      document.getElementById('avgMonthlyWeight').textContent = formatNumber(avgMonthlyWeight.toFixed(2));
      
      const totalMaintenanceCost = maintenanceData.reduce((sum, m) => sum + (parseArabicNumber(m[COLUMNS.maintenance.cost]) || 0), 0);
      const avgMaintenanceCost = uniqueVehicles.length > 0 ? totalMaintenanceCost / uniqueVehicles.length / 12 : 0;
      document.getElementById('avgMaintenanceCost').textContent = formatNumber(avgMaintenanceCost.toFixed(2));
    }
    
    /* ===== تحديث الجداول ===== */
    function updateTable() {
      renderTripTable(currentPage);
      renderVehicleAnalysis();
      renderDriverAnalysis();
    }
    
    function renderTripTable(page) {
      const tripTableBody = document.getElementById('tripTableBody');
      tripTableBody.innerHTML = '';
      
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const paginatedTrips = filteredTrips.slice(start, end);
      
      paginatedTrips.forEach(trip => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-100 transition-colors';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${trip[COLUMNS.trips.date]}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${trip[COLUMNS.trips.vehicle]}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${trip[COLUMNS.trips.driver]}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${trip[COLUMNS.trips.cargo]}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${trip[COLUMNS.trips.destination]}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(parseArabicNumber(trip[COLUMNS.trips.weight]) || 0)}</td>
        `;
        tripTableBody.appendChild(row);
      });
      
      const pageInfo = document.getElementById('pagination-info');
      const totalPages = Math.ceil(filteredTrips.length / rowsPerPage);
      pageInfo.textContent = `الصفحة ${formatNumber(currentPage)} من ${formatNumber(totalPages)} - إجمالي الرحلات: ${formatNumber(filteredTrips.length)}`;
      
      document.getElementById('prev-page').disabled = currentPage === 1;
      document.getElementById('next-page').disabled = currentPage === totalPages;
    }

    function renderVehicleAnalysis() {
      const vehicleAnalysisBody = document.getElementById('vehicleAnalysisBody');
      vehicleAnalysisBody.innerHTML = '';
      
      const vehicleStats = {};
      
      filteredTrips.forEach(trip => {
        const vehicle = trip[COLUMNS.trips.vehicle];
        const weight = parseArabicNumber(trip[COLUMNS.trips.weight]) || 0;
        const fuelCost = trip.fuelCost || 0;
        const maintenanceCost = trip.maintenanceCost || 0;
        
        if (!vehicleStats[vehicle]) {
          vehicleStats[vehicle] = { trips: 0, weight: 0, fuelCost: 0, maintenanceCost: 0 };
        }
        
        vehicleStats[vehicle].trips++;
        vehicleStats[vehicle].weight += weight;
        vehicleStats[vehicle].fuelCost += fuelCost;
        vehicleStats[vehicle].maintenanceCost += maintenanceCost;
      });
      
      Object.keys(vehicleStats).sort().forEach(vehicle => {
        const stats = vehicleStats[vehicle];
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-100 transition-colors';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${vehicle}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(stats.trips)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(stats.weight.toFixed(2))}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber((stats.weight / stats.trips).toFixed(2))}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(stats.fuelCost.toFixed(2))}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(stats.maintenanceCost.toFixed(2))}</td>
        `;
        vehicleAnalysisBody.appendChild(row);
      });
    }

    function renderDriverAnalysis() {
      const driverAnalysisBody = document.getElementById('driverAnalysisBody');
      driverAnalysisBody.innerHTML = '';
      
      const driverStats = {};
      
      filteredTrips.forEach(trip => {
        const driver = trip[COLUMNS.trips.driver];
        const weight = parseArabicNumber(trip[COLUMNS.trips.weight]) || 0;
        
        if (!driverStats[driver]) {
          driverStats[driver] = { trips: 0, weight: 0 };
        }
        
        driverStats[driver].trips++;
        driverStats[driver].weight += weight;
      });
      
      Object.keys(driverStats).sort().forEach(driver => {
        const stats = driverStats[driver];
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-100 transition-colors';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${driver}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(stats.trips)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(stats.weight.toFixed(2))}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber((stats.weight / stats.trips).toFixed(2))}</td>
        `;
        driverAnalysisBody.appendChild(row);
      });
    }

    /* ===== تحديث الرسوم البيانية ===== */
    let monthlyWeightChart, monthlyTripsChart, vehicleWeightChart, tripDistributionChart;

    function renderCharts() {
      renderMonthlyWeightChart();
      renderMonthlyTripsChart();
      renderVehicleWeightChart();
      renderTripDistributionChart();
    }

    function renderMonthlyWeightChart() {
      const monthlyData = filteredTrips.reduce((acc, trip) => {
        const month = new Date(trip[COLUMNS.trips.date]).getMonth();
        const weight = parseArabicNumber(trip[COLUMNS.trips.weight]) || 0;
        if (!acc[month]) acc[month] = 0;
        acc[month] += weight;
        return acc;
      }, {});
      const labels = Object.keys(monthlyData).sort((a, b) => a - b).map(m => toArabicMonths(parseInt(m) + 1));
      const data = Object.keys(monthlyData).sort((a, b) => a - b).map(m => monthlyData[m].toFixed(2));
      
      const chartData = {
        labels: labels,
        datasets: [{
          label: 'إجمالي الوزن (طن)',
          data: data,
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          tension: 0.1
        }]
      };
      
      if (monthlyWeightChart) monthlyWeightChart.destroy();
      monthlyWeightChart = new Chart(
        document.getElementById('monthlyWeightChart'),
        { type: 'line', data: chartData, options: { responsive: true, plugins: { legend: { display: true } } } }
      );
    }
    
    function renderMonthlyTripsChart() {
      const monthlyData = filteredTrips.reduce((acc, trip) => {
        const month = new Date(trip[COLUMNS.trips.date]).getMonth();
        if (!acc[month]) acc[month] = 0;
        acc[month]++;
        return acc;
      }, {});
      const labels = Object.keys(monthlyData).sort((a, b) => a - b).map(m => toArabicMonths(parseInt(m) + 1));
      const data = Object.keys(monthlyData).sort((a, b) => a - b).map(m => monthlyData[m]);
      
      const chartData = {
        labels: labels,
        datasets: [{
          label: 'عدد الرحلات',
          data: data,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.5)',
          tension: 0.1
        }]
      };
      
      if (monthlyTripsChart) monthlyTripsChart.destroy();
      monthlyTripsChart = new Chart(
        document.getElementById('monthlyTripsChart'),
        { type: 'bar', data: chartData, options: { responsive: true, plugins: { legend: { display: true } } } }
      );
    }

    function renderVehicleWeightChart() {
      const vehicleWeight = filteredTrips.reduce((acc, trip) => {
        const vehicle = trip[COLUMNS.trips.vehicle];
        const weight = parseArabicNumber(trip[COLUMNS.trips.weight]) || 0;
        if (!acc[vehicle]) acc[vehicle] = 0;
        acc[vehicle] += weight;
        return acc;
      }, {});
      const labels = Object.keys(vehicleWeight);
      const data = labels.map(label => vehicleWeight[label]);
      
      const chartData = {
        labels: labels,
        datasets: [{
          label: 'إجمالي الوزن (طن)',
          data: data,
          backgroundColor: ['#4299e1', '#667eea', '#9f7aea', '#d53f8c', '#ed8936', '#38b2ac', '#48bb78', '#68d391', '#4fd1c5', '#81e6d9'],
        }]
      };

      if (vehicleWeightChart) vehicleWeightChart.destroy();
      vehicleWeightChart = new Chart(
        document.getElementById('vehicleWeightChart'),
        { type: 'bar', data: chartData, options: { responsive: true, plugins: { legend: { display: false } } } }
      );
    }

    function renderTripDistributionChart() {
      const tripCounts = filteredTrips.reduce((acc, trip) => {
        const vehicle = trip[COLUMNS.trips.vehicle];
        acc[vehicle] = (acc[vehicle] || 0) + 1;
        return acc;
      }, {});
      
      const labels = Object.keys(tripCounts);
      const data = labels.map(label => tripCounts[label]);
      
      const chartData = {
        labels: labels,
        datasets: [{
          label: 'عدد الرحلات',
          data: data,
          backgroundColor: ['#4299e1', '#667eea', '#9f7aea', '#d53f8c', '#ed8936', '#38b2ac', '#48bb78', '#68d391', '#4fd1c5', '#81e6d9'],
        }]
      };

      if (tripDistributionChart) tripDistributionChart.destroy();
      tripDistributionChart = new Chart(
        document.getElementById('tripDistributionChart'),
        { type: 'doughnut', data: chartData, options: { responsive: true, plugins: { legend: { position: 'top' } } } }
      );
    }

    /* ===== وظائف التصدير ===== */
    async function exportToExcel() {
      const wb = XLSX.utils.book_new();
      
      // Trips Data
      const wsTrips = XLSX.utils.json_to_sheet(filteredTrips);
      XLSX.utils.book_append_sheet(wb, wsTrips, "سجل الرحلات");
      
      // Vehicle Analysis
      const vehicleAnalysisData = [];
      const vehicleRows = document.querySelectorAll('#vehicleAnalysisBody tr');
      vehicleRows.forEach(row => {
        const rowData = {};
        rowData['المركبة'] = row.cells[0].textContent;
        rowData['إجمالي الرحلات'] = parseArabicNumber(row.cells[1].textContent);
        rowData['إجمالي الوزن (طن)'] = parseArabicNumber(row.cells[2].textContent);
        rowData['متوسط الوزن (طن/رحلة)'] = parseArabicNumber(row.cells[3].textContent);
        rowData['كلفة الوقود (دينار)'] = parseArabicNumber(row.cells[4].textContent);
        rowData['متوسط الصيانة (دينار/شهر)'] = parseArabicNumber(row.cells[5].textContent);
        vehicleAnalysisData.push(rowData);
      });
      const wsVehAnalysis = XLSX.utils.json_to_sheet(vehicleAnalysisData);
      XLSX.utils.book_append_sheet(wb, wsVehAnalysis, "تحليل كفاءة المركبات");

      // Driver Analysis
      const driverAnalysisData = [];
      const driverRows = document.querySelectorAll('#driverAnalysisBody tr');
      driverRows.forEach(row => {
        const rowData = {};
        rowData['السائق'] = row.cells[0].textContent;
        rowData['إجمالي الرحلات'] = parseArabicNumber(row.cells[1].textContent);
        rowData['إجمالي الوزن (طن)'] = parseArabicNumber(row.cells[2].textContent);
        rowData['متوسط الوزن (طن/رحلة)'] = parseArabicNumber(row.cells[3].textContent);
        driverAnalysisData.push(rowData);
      });
      const wsDriverAnalysis = XLSX.utils.json_to_sheet(driverAnalysisData);
      XLSX.utils.book_append_sheet(wb, wsDriverAnalysis, "تحليل أداء السائقين");
      
      XLSX.writeFile(wb, "تقرير-بيانات-النقل.xlsx");
    }
    
    async function exportToPdf() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: "p",
        unit: "mm",
        format: "a4"
      });
      const margin = 10;
      let y = margin;
      
      const addPage = () => { if (y > 280) { doc.addPage(); y = margin; } };
      
      doc.setFont("DroidSansFallback");
      doc.addFont('https://fonts.gstatic.com/ea/arabic/v10/Amiri-Regular.ttf', 'Amiri', 'normal');
      doc.setFont('Amiri');
      doc.setR2L(true);

      const addHeader = () => {
        doc.setFontSize(20);
        doc.text("لوحة بيانات النقل - بلدية مؤتة والمزار", 105, y, { align: "center" });
        y += 10;
        doc.setFontSize(12);
        doc.text(`تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}`, 200, y, { align: "right" });
        y += 5;
        doc.line(10, y, 200, y);
        y += 5;
      };

      addHeader();

      const printTable = (tableId, title) => {
        const table = document.getElementById(tableId);
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
        const data = Array.from(table.querySelectorAll('tbody tr')).map(row => Array.from(row.cells).map(cell => cell.textContent));
        
        doc.setFontSize(14);
        doc.text(title, 200, y, { align: "right" });
        y += 5;

        doc.autoTable({
          startY: y,
          head: [headers],
          body: data,
          theme: 'grid',
          styles: { font: 'Amiri', halign: 'center', cellPadding: 2, fontSize: 8 },
          headStyles: { fillColor: '#e5e7eb', textColor: '#4b5563' },
          bodyStyles: { textColor: '#1f2937' },
          columnStyles: {
            0: { cellWidth: 'auto', halign: 'right' },
            1: { cellWidth: 'auto', halign: 'right' },
            2: { cellWidth: 'auto', halign: 'right' },
            3: { cellWidth: 'auto', halign: 'right' },
            4: { cellWidth: 'auto', halign: 'right' },
            5: { cellWidth: 'auto', halign: 'right' }
          },
          didDrawPage: (data) => {
            if (data.pageNumber > 1) {
                y = data.startY;
            }
          },
          tableWidth: 'wrap'
        });
        y = doc.autoTable.previous.finalY + 10;
      };
      
      const printChart = async (chartId, title) => {
        addPage();
        doc.setFontSize(14);
        doc.text(title, 200, y, { align: "right" });
        y += 5;
        
        const canvas = await html2canvas(document.getElementById(chartId), { scale: 2, backgroundColor: null });
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 180; 
        const pageHeight = doc.internal.pageSize.height;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        
        if (y + imgHeight > pageHeight - margin) {
          doc.addPage();
          y = margin;
        }

        doc.addImage(imgData, 'PNG', 10, y, imgWidth, imgHeight);
        y += imgHeight + 10;
      };

      await printChart('vehicleWeightChart', 'توزيع النقل على المركبات');
      await printChart('monthlyWeightChart', 'الوزن حسب الشهور');
      await printChart('monthlyTripsChart', 'عدد الرحلات حسب الشهور');
      await printChart('tripDistributionChart', 'توزيع الرحلات على المركبات');
      printTable('vehicleAnalysisTable', 'تحليل كفاءة المركبات');
      printTable('driverAnalysisTable', 'تحليل أداء السائقين');
      printTable('tripTable', 'سجل الرحلات');

      doc.save('تقرير-بيانات-النقل.pdf');
    }

    /* ===== Render شامل ===== */
    function render() {
      applyFilters();
      updateKPIs();
      updateTable();
      renderCharts();
    }
    
    function toggleSection(sectionId) {
      const content = document.getElementById(`content-${sectionId}`);
      const icon = document.getElementById(`icon-${sectionId}`);
      if (content.style.maxHeight !== "0px") {
        content.style.maxHeight = "0px";
        icon.classList.remove('rotate-180');
      } else {
        content.style.maxHeight = `${content.scrollHeight}px`;
        icon.classList.add('rotate-180');
      }
    }

    /* ===== Start ===== */
    document.addEventListener("DOMContentLoaded", () => {
      loadAllData();
      
      document.getElementById('dateFilterBtn').addEventListener('click', () => {
        document.getElementById('dateFilterMenu').classList.toggle('hidden');
      });
      
      document.getElementById('applyDate').addEventListener('click', () => {
        render();
        document.getElementById('dateFilterMenu').classList.add('hidden');
      });
      
      document.getElementById('clearDate').addEventListener('click', () => {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        render();
        document.getElementById('dateFilterMenu').classList.add('hidden');
      });

      document.getElementById('monthDropdownBtn').addEventListener('click', () => {
        document.getElementById('monthDropdownMenu').classList.toggle('hidden');
      });
      
      document.getElementById('vehicleDropdownBtn').addEventListener('click', () => {
        document.getElementById('vehicleDropdownMenu').classList.toggle('hidden');
      });
      
      document.getElementById('generalSearch').addEventListener('input', render);
      
      document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('generalSearch').value = '';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.querySelectorAll("#monthCheckboxes input[type='checkbox']").forEach(cb => cb.checked = true);
        document.querySelectorAll("#vehicleCheckboxes input[type='checkbox']").forEach(cb => cb.checked = true);
        render();
      });

      document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderTripTable(currentPage);
        }
      });

      document.getElementById('next-page').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredTrips.length / rowsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderTripTable(currentPage);
        }
      });

      document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
      document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
    });

    if (window.ChartDataLabels) { Chart.register(ChartDataLabels); }

  </script>
</body>
</html>
