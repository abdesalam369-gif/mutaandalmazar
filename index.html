<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- DataLabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- Export libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-blue-600 text-white p-6 shadow">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">

    <!-- Export buttons -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button id="btnCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (الرحلات الحالية)</button>
      <button id="btnXLSX" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير Excel (رحلات + ملخص مركبات)</button>
      <button id="btnPDF" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">PDF (سجل الرحلات)</button>
    </div>

    <!-- Vehicle Summary Table -->
    <div id="vehicleSummaryBox" class="bg-white rounded-xl shadow overflow-hidden mt-6">
      <div class="p-4 border-b">
        <h3 class="font-semibold">ملخص المركبات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">رقم المركبة</th>
              <th class="px-4 py-2">السائقين</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">إجمالي الوزن (طن)</th>
            </tr>
          </thead>
          <tbody id="vehicleSummary"></tbody>
        </table>
      </div>
    </div>

    <!-- Raw trips table -->
    <div id="rawTripsBox" class="bg-white rounded-xl shadow overflow-hidden mt-6">
      <div class="p-4 border-b">
        <h3 class="font-semibold">سجل الرحلات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">الشهر</th>
              <th class="px-4 py-2">تاريخ التوزين الثاني</th>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">صافي التحميل (طن)</th>
              <th class="px-4 py-2">رقم المركبة</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="emptyState" class="p-6 text-center text-gray-500 hidden">لا توجد بيانات مطابقة.</div>
    </div>

    <!-- NEW: Vehicle efficiency analysis -->
    <div id="vehAnalysisBox" class="bg-white rounded-xl shadow overflow-hidden mt-6">
      <div class="p-4 border-b">
        <h3 class="font-semibold">تحليل كفاءة المركبات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">رقم المركبة</th>
              <th class="px-4 py-2">سنة التصنيع</th>
              <th class="px-4 py-2">السعة (م³)</th>
              <th class="px-4 py-2">السعة النظرية (طن)</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">الوزن المنقول (طن)</th>
              <th class="px-4 py-2">نسبة الاستغلال %</th>
            </tr>
          </thead>
          <tbody id="vehAnalysis"></tbody>
        </table>
      </div>
    </div>

  </main>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";
const VEH_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2001178330&single=true&output=csv";

const COL = { month:"الشهر", date:"تاريخ التوزين الثاني", driver:"السائق", weight:"صافي التحميل", vehicle:"رقم المركبة"};

let ALL=[], VIEW=[];
let VEHICLES={}; // vehicle metadata

function toNumber(v){ if(v==null)return 0; let s=String(v).trim(); const map={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'}; s=s.replace(/[٠-٩]/g,d=>map[d]||d); s=s.replace(/[^\d.]/g,""); const n=parseFloat(s); return isNaN(n)?0:n; }

function formatTonFromKg(kg){ return (kg/1000).toFixed(2); }

async function loadData(){
  // load trips
  const result=await new Promise((res,rej)=>{Papa.parse(CSV_URL,{download:true,header:true,skipEmptyLines:true,complete:res,error:rej});});
  ALL=result.data.map(r=>{const o={};Object.keys(r).forEach(k=>o[k.trim()]=String(r[k]||"").trim());return o;});
  renderTrips();

  // load vehicles metadata
  const veh=await new Promise((res,rej)=>{Papa.parse(VEH_URL,{download:true,header:true,skipEmptyLines:true,complete:res,error:rej});});
  veh.data.forEach(r=>{
    const v=(r["رقم المركبة"]||"").trim();
    if(!v) return;
    VEHICLES[v]={
      capM3:toNumber(r["سعة المركبة بالمتر المكعب"]),
      year:r["سنة التصنيع"]||"",
      dens:toNumber(r["كثافة التحميل"])
    };
  });
  renderVehAnalysis();
}

function renderTrips(){
  VIEW=ALL;
  const tb=document.getElementById("tbody"); tb.innerHTML="";
  VIEW.forEach(r=>{
    const tr=document.createElement("tr");
    tr.className="border-b hover:bg-gray-50";
    tr.innerHTML=`
      <td class="px-4 py-2">${r[COL.month]||""}</td>
      <td class="px-4 py-2">${r[COL.date]||""}</td>
      <td class="px-4 py-2">${r[COL.driver]||""}</td>
      <td class="px-4 py-2">${formatTonFromKg(toNumber(r[COL.weight]))}</td>
      <td class="px-4 py-2">${r[COL.vehicle]||""}</td>`;
    tb.appendChild(tr);
  });
}

function renderVehAnalysis(){
  const byVehTrips={}, byVehWeight={};
  VIEW.forEach(r=>{
    const v=r[COL.vehicle]; if(!v) return;
    byVehTrips[v]=(byVehTrips[v]||0)+1;
    byVehWeight[v]=(byVehWeight[v]||0)+toNumber(r[COL.weight]);
  });

  const tb=document.getElementById("vehAnalysis"); tb.innerHTML="";
  Object.keys(VEHICLES).forEach(v=>{
    const meta=VEHICLES[v];
    const trips=byVehTrips[v]||0;
    const wkg=byVehWeight[v]||0;
    const wton=wkg/1000;
    const capTon=meta.capM3*meta.dens;
    const util=capTon>0? (wton/(capTon*trips))*100:0;
    const tr=document.createElement("tr");
    tr.className="border-b hover:bg-gray-50";
    tr.innerHTML=`
      <td class="px-4 py-2">${v}</td>
      <td class="px-4 py-2">${meta.year}</td>
      <td class="px-4 py-2">${meta.capM3.toFixed(2)}</td>
      <td class="px-4 py-2">${capTon.toFixed(2)}</td>
      <td class="px-4 py-2">${trips}</td>
      <td class="px-4 py-2">${wton.toFixed(2)}</td>
      <td class="px-4 py-2">${util.toFixed(1)}%</td>`;
    tb.appendChild(tr);
  });
}

document.addEventListener("DOMContentLoaded",loadData);
</script>
</body>
</html>
