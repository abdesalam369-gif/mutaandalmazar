<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    /* تخصيص شريط تمرير بسيط */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="loadingOverlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="flex flex-col items-center gap-3">
      <div class="h-8 w-8 rounded-full border-4 border-blue-600 border-t-transparent animate-spin"></div>
      <div class="text-sm text-blue-700">جاري التحميل...</div>
    </div>
  </div>

  <header class="bg-blue-600 text-white p-6 shadow">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow p-4 mb-6 grid grid-cols-1 lg:grid-cols-7 gap-4">
      <div class="lg:col-span-2">
        <label class="block text-sm mb-1">بحث عام</label>
        <input id="q" type="text" placeholder="ابحث بتاريخ أو سائق أو رقم مركبة..." class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">الشهور </label>
          <div class="flex gap-2 text-xs">
            <button id="monthSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50">تحديد الكل</button>
            <button id="monthClearAll" class="px-2 py-1 rounded border hover:bg-gray-50">مسح</button>
          </div>
        </div>
        <div class="relative">
          <button id="monthDropdownBtn" class="w-full text-right border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">اختر الشهور...</button>
          <div id="monthDropdownMenu" class="absolute hidden top-full left-0 z-10 w-full bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
            </div>
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">أرقام المركبات </label>
          <div class="flex gap-2 text-xs">
            <button id="vehSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50">تحديد الكل</button>
            <button id="vehClearAll" class="px-2 py-1 rounded border hover:bg-gray-50">مسح</button>
          </div>
        </div>
        <div class="relative">
          <button id="vehicleDropdownBtn" class="w-full text-right border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">اختر المركبات...</button>
          <div id="vehicleDropdownMenu" class="absolute hidden top-full left-0 z-10 w-full bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
            </div>
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">تاريخ محدد</label>
        <input id="dateExact" type="date" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div class="flex items-end lg:col-span-2">
        <div class="flex flex-wrap gap-2">
          <button id="resetBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">إعادة تعيين الفلاتر</button>
          <button id="refreshBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تحديث من المصدر</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الرحلات</p><h3 id="k_trips" class="text-2xl font-bold text-blue-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الوزن</p><h3 id="k_weight" class="text-2xl font-bold text-green-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي كلفة الوقود</p><h3 id="k_totalFuelCost" class="text-2xl font-bold text-teal-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي كلفة الصيانة</p><h3 id="k_totalMaintenanceCost" class="text-2xl font-bold text-rose-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد المركبات</p><h3 id="k_vehicleCount" class="text-2xl font-bold text-yellow-600">0</h3></div>

      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">متوسط حمولة الرحلة</p><h3 id="k_avg" class="text-2xl font-bold text-purple-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد السائقين</p><h3 id="k_drivers" class="text-2xl font-bold text-orange-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (وزن)</p><h3 id="k_topVehicleWeight" class="text-xl font-bold text-red-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (رحلات)</p><h3 id="k_topVehicleTrips" class="text-xl font-bold text-indigo-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">اليوم الأعلى وزناً</p><h3 id="k_topDay" class="text-xl font-bold text-pink-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط يومي</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgDailyWeight" class="font-bold text-blue-600">0</span> طن/يوم</div>
          <div>الرحلات: <span id="k_avgDailyTrips" class="font-bold text-blue-600">0</span> رحلة/يوم</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط شهري</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgMonthlyWeight" class="font-bold text-blue-600">0</span> طن/شهر</div>
          <div>الرحلات: <span id="k_avgMonthlyTrips" class="font-bold text-blue-600">0</span> رحلة/شهر</div>
        </div>
      </div>
    </div>

    <div id="timeSeriesBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <h3 class="font-semibold">السلاسل الزمنية</h3>
        <select id="tsAgg" class="border rounded-lg px-3 py-2">
          <option value="day">تجميع يومي</option>
          <option value="month">تجميع شهري</option>
        </select>
        <select id="tsMetric" class="border rounded-lg px-3 py-2">
          <option value="weight">الوزن (طن)</option>
          <option value="trips">الرحلات</option>
        </select>
      </div>
      <canvas id="timeSeriesChart" height="120"></canvas>
      <p class="text-xs text-gray-500 mt-2">* قد تُستثنى السجلات بلا تاريخ من الرسم اليومي.</p>
    </div>

    <div id="chartWeightBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <h3 class="mb-2 font-semibold">وزن النقل حسب المركبة (بالطن)</h3>
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <label class="text-sm">بحث عن مركبة:</label>
        <input id="vwSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
        <label class="text-sm">Top N:</label>
        <input id="vwTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
      </div>
      <canvas id="vehicleWeightChart" height="120"></canvas>
    </div>

    <div id="chartTripsBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <h3 class="mb-2 font-semibold">نسبة عدد الرحلات لكل مركبة</h3>
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <label class="text-sm">بحث عن مركبة:</label>
        <input id="vtSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
        <label class="text-sm">Top N:</label>
        <input id="vtTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
      </div>
      <canvas id="vehicleTripsChart" height="120"></canvas>
    </div>

    <div id="vehAnalysisBox" class="bg-white rounded-xl shadow overflow-hidden mt-6 mb-6">
      <div class="p-4 border-b">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <label class="text-sm">بحث:</label>
          <input id="vaSearch" type="text" placeholder="ابحث..." class="border rounded-lg px-3 py-1">
          <label class="text-sm">من سنة تصنيع:</label>
          <input id="vaYear" type="number" placeholder="2000" class="w-24 border rounded-lg px-3 py-1">
          <label class="text-sm">ترتيب تنازلي حسب:</label>
          <select id="vaSort" class="border rounded-lg px-3 py-1">
            <option value="eff">نسبة الاستغلال</option>
            <option value="fuelCost">كلفة الوقود</option>
            <option value="maintenanceCost">كلفة الصيانة</option>
            <option value="costPerTrip">كلفة الرحلة</option>
            <option value="costPerTon">كلفة الطن</option>
            <option value="capTon">السعة النظرية</option>
            <option value="trips">عدد الرحلات</option>
            <option value="wton">الوزن المنقول</option>
            <option value="year">سنة التصنيع</option>
          </select>
        </div>
        <h3 class="font-semibold">تحليل كفاءة المركبات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">رقم المركبة</th>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">سنة التصنيع</th>
              <th class="px-4 py-2">السعة (م³)</th>
              <th class="px-4 py-2">السعة النظرية (طن)</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">الوزن المنقول (طن)</th>
              <th class="px-4 py-2">نسبة الاستغلال %</th>
              <th class="px-4 py-2">كلفة الوقود</th>
              <th class="px-4 py-2">كلفة الصيانة</th>
              <th class="px-4 py-2">كلفة الرحلة</th>
              <th class="px-4 py-2">كلفة الطن</th>
            </tr>
          </thead>
          <tbody id="vehAnalysisTable"></tbody>
        </table>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 mb-6">
      <button id="btnCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (الرحلات الحالية)</button>
      <button id="btnXLSX" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير Excel (رحلات + ملخص مركبات)</button>
      <button id="btnPDF" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">PDF (سجل الرحلات)</button>
      <button id="btnDriversCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (تحليل السائقين)</button>
    </div>

    <div id="driversBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <h3 class="font-semibold">تحليل السائقين</h3>
        <label class="text-sm">الترتيب</label>
        <select id="driverSort" class="border rounded-lg px-3 py-2">
          <option value="weight">حسب الوزن</option>
          <option value="trips">حسب الرحلات</option>
          <option value="avg">متوسط حمولة/رحلة</option>
        </select>
        <label class="text-sm">عدد السائقين (Top N)</label>
        <input id="driverTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-2">
        <label class="text-sm">بحث عن سائق</label>
        <input id="driverSearch" type="text" placeholder="اسم السائق" class="border rounded-lg px-3 py-2">
      </div>
      <canvas id="driverChart" height="120" class="mb-6"></canvas>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">الوزن (طن)</th>
              <th class="px-4 py-2">متوسط/رحلة (طن)</th>
              <th class="px-4 py-2">عدد المركبات</th>
              <th class="px-4 py-2">المركبات</th>
            </tr>
          </thead>
          <tbody id="driverTable"></tbody>
        </table>
      </div>
    </div>

    <div id="rawTripsBox" class="bg-white rounded-xl shadow overflow-hidden">
      <div class="p-4 border-b">
        <h3 class="font-semibold">سجل الرحلات</h3>
      </div>

      <div class="p-4 flex flex-wrap items-center gap-3">
        <label class="text-sm">عدد الصفوف في الصفحة</label>
        <select id="pageSize" class="border rounded-lg px-2 py-1">
          <option>10</option>
          <option selected>25</option>
          <option>50</option>
          <option>100</option>
        </select>

        <div class="ms-auto flex items-center gap-2">
          <button id="prevPage" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
          <span class="text-sm">صفحة <span id="pageIdx">1</span> من <span id="pageTotal">1</span></span>
          <button id="nextPage" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">الشهر</th>
              <th class="px-4 py-2">تاريخ التوزين الثاني</th>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">صافي التحميل (طن)</th>
              <th class="px-4 py-2">رقم المركبة</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="p-4 border-t flex items-center gap-2">
        <button id="prevPage2" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
        <span class="text-sm">صفحة <span id="pageIdx2">1</span> من <span id="pageTotal2">1</span></span>
        <button id="nextPage2" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
        <div class="ms-auto text-xs text-gray-500">* الترتيب الافتراضي حسب ترتيب المصدر.</div>
      </div>
    </div>
  </main>

  <script>
    /* ===== إعدادات الأعمدة ===== */
    const COL = {
      month: "الشهر",
      date: "تاريخ التوزين الثاني",
      driver: "السائق",
      weight: "صافي التحميل",
      vehicle: "رقم المركبة"
    };

    const VEH_COLS = {
      plate: "رقم المركبة",
      driver: "السائق",
      year: "سنة التصنيع",
      capacity: "السعة",
      capTon: "السعة النظرية"
    };

    const FUEL_COLS = {
      plate: "رقم المركبة",
      jan: "jan", feb: "feb", mar: "mar", apr: "apr", may: "may", jun: "jun",
      july: "july", aug: "aug", sep: "sep", oct: "oct", nov: "nov", dec: "dec"
    };

    const MAINT_COLS = {
      plate: "رقم المركبة",
      cost: "كلفة الصيانة"
    };

    /* ===== روابط الشيتات ===== */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";
    const VEH_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2001178330&single=true&output=csv";
    const FUEL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=1380959426&single=true&output=csv";
    const MAINTENANCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2095309457&single=true&output=csv";

    /* ===== متغيرات عامة ===== */
    let ALL = [];
    let VIEW = [];
    let VEHICLES = [];
    let FUEL = [];
    let MAINTENANCE = [];
    let vehicleWeightChart = null;
    let vehicleTripsChart  = null;
    let timeSeriesChart    = null;
    let driverChart        = null;
    /* تحميل/تعطيل */
    let dataLoaded = false, vehiclesLoaded = false, fuelLoaded = false, maintenanceLoaded = false;
    const controlsSelector = 'input, select, button';
    function setLoading(state) {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = state ? 'flex' : 'none';
      document.querySelectorAll(controlsSelector).forEach(el => {
        if (el.id === 'refreshBtn') return; // اسمح بالتحديث دائماً
        el.disabled = state;
      });
    }
    function maybeHideOverlay() {
      if (dataLoaded && vehiclesLoaded && fuelLoaded && maintenanceLoaded) setLoading(false);
    }

    /* أدوات مساعدة */
    function toNumber(v) {
      if (v == null) return 0;
      let s = String(v).trim();
      const arabicMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
      s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
      s = s.replace(/[^\d.]/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    function formatTonFromKg(kg) {
      const t = kg / 1000;
      return t.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function toYMD(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const d = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function toYM(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    }

    /* ===== فلترة ===== */
    function applyFilters() {
      const q = document.getElementById("q").value.trim().toLowerCase();
      const monthCheckboxes = document.querySelectorAll("#monthDropdownMenu input[type='checkbox']");
      const vehicleCheckboxes = document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']");
      const months = Array.from(monthCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
      const vehicles = Array.from(vehicleCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
      const d = document.getElementById("dateExact").value;
      VIEW = ALL.filter(r => {
        const recMonth = String(r[COL.month] || "").trim();
        const recVeh   = String(r[COL.vehicle] || "").trim();
        const byMonth   = months.length ? months.includes(recMonth) : true;
        const byVehicle = vehicles.length ? vehicles.includes(recVeh) : true;
        let byDate = true;
        if (d) {
          if (!r[COL.date]) byDate = false;
          else {
            const recordDate = new Date(r[COL.date]);
            const exactDate = new Date(d);
            byDate = recordDate.toDateString() === exactDate.toDateString();
          }
        }
        if (!byMonth || !byVehicle || !byDate) return false;
        if (!q) return true;
        const hay = [r[COL.month], r[COL.date], r[COL.driver], r[COL.weight], r[COL.vehicle]].map(x => (x==null?"":String(x))).join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    /* ===== ملخص المركبات ===== */
    function updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers) {
      const vehiclesSet = new Set([...Object.keys(byVehicleTrips), ...Object.keys(byVehicleWeight)]);
      let summary = Array.from(vehiclesSet).map(v => ({
        vehicle: v,
        drivers: Array.from(vehicleDrivers[v] || []),
        trips: byVehicleTrips[v] || 0,
        weightTon: (byVehicleWeight[v] || 0) / 1000
      }));
      const vsQuery=document.getElementById("vsSearch")?.value?.toLowerCase() || "";
      const vsSort=document.getElementById("vsSort")?.value || "weight";
      if(vsQuery){
        summary=summary.filter(r=>r.vehicle.toLowerCase().includes(vsQuery)||r.drivers.join(", ").toLowerCase().includes(vsQuery));
      }
      if(vsSort==="weight"){ summary.sort((a,b)=>b.weightTon-a.weightTon);
      }
      else if(vsSort==="trips"){ summary.sort((a,b)=>b.trips-a.trips); }

      const tbody = document.getElementById("vehicleSummary");
      if (!tbody) return;
      tbody.innerHTML = "";
      summary.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${row.vehicle}</td>
          <td class="px-4 py-2">${row.drivers.join(", ")}</td>
          <td class="px-4 py-2">${row.trips}</td>
          <td class="px-4 py-2">${row.weightTon.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    /* ===== تحليل كفاءة المركبات ===== */
    function renderVehAnalysis() {
      const byVehicleTrips = {};
      const byVehicleWeight = {};
      VIEW.forEach(r => {
        const v = String(r[COL.vehicle] || "").trim();
        const w = toNumber(r[COL.weight]);
        if (!byVehicleTrips[v]) byVehicleTrips[v] = 0;
        if (!byVehicleWeight[v]) byVehicleWeight[v] = 0;
        byVehicleTrips[v]++;
        byVehicleWeight[v] += w;
      });

      const allVehiclesMap = new Map();
      VEHICLES.forEach(v => allVehiclesMap.set(String(v[VEH_COLS.plate] || "").trim(), v));

      const vehicleData = Array.from(allVehiclesMap.keys())
        .filter(vPlate => Object.keys(byVehicleTrips).includes(vPlate))
        .map(vPlate => {
          const vData = allVehiclesMap.get(vPlate);
          const totalTrips = byVehicleTrips[vPlate] || 0;
          const totalWeight = byVehicleWeight[vPlate] || 0;
          const fuelData = FUEL.find(f => String(f[FUEL_COLS.plate] || "").trim() === vPlate);
          const maintData = MAINTENANCE.find(m => String(m[MAINT_COLS.plate] || "").trim() === vPlate);
          const totalFuelCost = Object.keys(FUEL_COLS).slice(1).reduce((sum, month) => sum + toNumber(fuelData?.[month]), 0);
          const totalMaintenanceCost = toNumber(maintData?.[MAINT_COLS.cost]);
          const capTon = toNumber(vData?.[VEH_COLS.capTon]);
          const costPerTrip = totalTrips > 0 ? (totalFuelCost + totalMaintenanceCost) / totalTrips : 0;
          const costPerTon = (totalWeight / 1000) > 0 ? (totalFuelCost + totalMaintenanceCost) / (totalWeight / 1000) : 0;
          const efficiency = (capTon > 0 && (totalWeight/1000) > 0) ? (totalWeight/1000)/capTon/totalTrips*100 : 0;
          
          return {
            plate: vPlate,
            driver: vData?.[VEH_COLS.driver],
            year: toNumber(vData?.[VEH_COLS.year]),
            capacity: toNumber(vData?.[VEH_COLS.capacity]),
            capTon: capTon,
            trips: totalTrips,
            wton: totalWeight / 1000,
            eff: efficiency,
            fuelCost: totalFuelCost,
            maintenanceCost: totalMaintenanceCost,
            costPerTrip: costPerTrip,
            costPerTon: costPerTon
          };
        });
      
      const vaSearch = document.getElementById("vaSearch").value.toLowerCase();
      const vaYear = toNumber(document.getElementById("vaYear").value);
      const vaSort = document.getElementById("vaSort").value;

      let filteredData = vehicleData.filter(d => 
        (d.plate.toLowerCase().includes(vaSearch) || d.driver?.toLowerCase().includes(vaSearch)) &&
        (vaYear === 0 || d.year >= vaYear)
      );

      filteredData.sort((a,b) => {
        if(vaSort === "eff") return b.eff - a.eff;
        if(vaSort === "fuelCost") return b.fuelCost - a.fuelCost;
        if(vaSort === "maintenanceCost") return b.maintenanceCost - a.maintenanceCost;
        if(vaSort === "costPerTrip") return b.costPerTrip - a.costPerTrip;
        if(vaSort === "costPerTon") return b.costPerTon - a.costPerTon;
        if(vaSort === "capTon") return b.capTon - a.capTon;
        if(vaSort === "trips") return b.trips - a.trips;
        if(vaSort === "wton") return b.wton - a.wton;
        if(vaSort === "year") return b.year - a.year;
        return 0;
      });

      const tbody = document.getElementById("vehAnalysisTable");
      tbody.innerHTML = "";
      filteredData.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${row.plate}</td>
          <td class="px-4 py-2">${row.driver || "-"}</td>
          <td class="px-4 py-2">${row.year || "-"}</td>
          <td class="px-4 py-2">${row.capacity || "-"}</td>
          <td class="px-4 py-2">${row.capTon ? row.capTon.toFixed(2) : "-"}</td>
          <td class="px-4 py-2">${row.trips}</td>
          <td class="px-4 py-2">${row.wton.toFixed(2)}</td>
          <td class="px-4 py-2">${row.eff.toFixed(2)}%</td>
          <td class="px-4 py-2">${row.fuelCost.toFixed(2)}</td>
          <td class="px-4 py-2">${row.maintenanceCost.toFixed(2)}</td>
          <td class="px-4 py-2">${row.costPerTrip.toFixed(2)}</td>
          <td class="px-4 py-2">${row.costPerTon.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ===== Time Series ===== */

    function computeTimeSeries(agg, metric) {
      const map = {};
      const MONTH_ORDER = ["jan","feb","mar","apr","may","jun","july","aug","sep","oct","nov","dec"];
      VIEW.forEach(r => {
        let key = null;
        if (agg === 'day') {
          if (!r[COL.date]) return;
          const dt = new Date(r[COL.date]);
          if (isNaN(dt)) return;
          key = toYMD(dt);
        } else {
          // شهري: استخدم فقط خانة الشهر
          if (!r[COL.month]) return;
          key = String(r[COL.month]).trim().toLowerCase();
          if (!MONTH_ORDER.includes(key)) return;
        }

        if (!(key in map)) map[key] = 0;
        if (metric === 'weight') map[key] += toNumber(r[COL.weight]) / 1000;
        else map[key] += 1;
      });
      let labels = Object.keys(map);
      if (labels.length === 0) return { labels: [], values: [] };
      if (agg === 'day') {
        labels.sort((a,b)=> new Date(a) - new Date(b));
      } else {
        labels.sort((a,b)=> MONTH_ORDER.indexOf(a) - MONTH_ORDER.indexOf(b));
      }

      const values = labels.map(k => +map[k].toFixed(2));
      return { labels, values };
    }

    function updateTimeSeriesChart() {
      const agg = document.getElementById('tsAgg').value;
      const metric = document.getElementById('tsMetric').value;
      const {labels, values} = computeTimeSeries(agg, metric);
      const ctx = document.getElementById('timeSeriesChart').getContext('2d');
      if (timeSeriesChart) timeSeriesChart.destroy();
      timeSeriesChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: metric === 'weight' ? 'الوزن (طن)' : 'عدد الرحلات', data: values, fill: false, borderColor: metric === 'weight' ? '#3b82f6' : '#10b981', tension: 0.2, pointRadius: 3 }]},
        options: { responsive: true, plugins: { legend: { display: false } },
          scales: { x: { title: { display: true, text: agg === 'day' ? 'اليوم' : 'الشهر' } }, y: { title: { display: true, text: metric === 'weight' ? 'طن' : 'رحلة' }, beginAtZero: true } } }
      });
    }

    /* ===== KPI + Charts ===== */
    function updateKPIs() {
      const trips = VIEW.length;
      const totalWkg = VIEW.reduce((s,r)=> s + toNumber(r[COL.weight]), 0);
      const avgWkg = trips ? (totalWkg / trips) : 0;
      const drivers = new Set(VIEW.map(r => r[COL.driver]).filter(Boolean));

      document.getElementById("k_trips").textContent  = trips.toLocaleString();
      document.getElementById("k_weight").textContent = formatTonFromKg(totalWkg) + " طن";
      document.getElementById("k_avg").textContent    = formatTonFromKg(avgWkg) + " طن";
      document.getElementById("k_drivers").textContent= drivers.size.toLocaleString();

      // إجمالي كلفة الوقود (تفاعلي حسب المركبات والشهور)
      const visibleVehicles = new Set(VIEW.map(r => String(r[COL.vehicle] || "").trim()).filter(Boolean));
      const monthCheckboxes = document.querySelectorAll("#monthDropdownMenu input[type='checkbox']");
      const selectedMonths = Array.from(monthCheckboxes).filter(cb => cb.checked).map(cb => cb.value.toLowerCase());
      let totalFuelCost = 0;
      FUEL.forEach(f => {
        const vnum = String(f[FUEL_COLS.plate] || "").trim();
        if (!vnum || !visibleVehicles.has(vnum)) return;
        const months = ["jan","feb","mar","apr","may","jun","july","aug","sep","oct","nov","dec"];
        months.forEach(m => {
          if (f[m] && (selectedMonths.length === 0 || selectedMonths.includes(m))) {
            totalFuelCost += toNumber(f[m]);
          }
        });
      });
      const fuelNode = document.getElementById("k_totalFuelCost");
      if (fuelNode) fuelNode.textContent = totalFuelCost.toFixed(2);
      // إجمالي كلفة الصيانة (تفاعلي حسب المركبات الظاهرة)
      let totalMaintenanceCost = 0;
      MAINTENANCE.forEach(m => {
        const vnum = String(m[MAINT_COLS.plate] || "").trim();
        if (!vnum || !visibleVehicles.has(vnum)) return;
        if (m[MAINT_COLS.cost]) totalMaintenanceCost += toNumber(m[MAINT_COLS.cost]);
      });
      const maintNode = document.getElementById("k_totalMaintenanceCost");
      if (maintNode) maintNode.textContent = totalMaintenanceCost.toFixed(2);

      // عدد المركبات
      const vehicleCount = visibleVehicles.size;
      const vehNode = document.getElementById("k_vehicleCount");
      if (vehNode) vehNode.textContent = vehicleCount.toLocaleString();

      const uniqueDays = new Set(VIEW.map(r => r[COL.date]).filter(Boolean));
      const daysCount = uniqueDays.size;
      const avgDailyWeight = daysCount ? (totalWkg/1000) / daysCount : 0;
      const avgDailyTrips = daysCount ? trips / daysCount : 0;
      const monthKeys = new Set();
      VIEW.forEach(r => {
        let key = null;
        if (r[COL.date]) {
          const dt = new Date(r[COL.date]);
          if (!isNaN(dt)) key = toYM(dt);
        }
        if (!key && r[COL.month]) key = String(r[COL.month]).trim();
        if (key) monthKeys.add(key);
      });
      const monthsCount = monthKeys.size;
      const avgMonthlyWeight = monthsCount ? (totalWkg/1000) / monthsCount : 0;
      const avgMonthlyTrips = monthsCount ? trips / monthsCount : 0;

      document.getElementById("k_avgDailyWeight").textContent = avgDailyWeight.toFixed(2);
      document.getElementById("k_avgDailyTrips").textContent  = avgDailyTrips.toFixed(1);
      document.getElementById("k_avgMonthlyWeight").textContent = avgMonthlyWeight.toFixed(2);
      document.getElementById("k_avgMonthlyTrips").textContent  = avgMonthlyTrips.toFixed(1);

      // per vehicle aggregates
      const byVehicleWeight = {};
      const byVehicleTrips  = {};
      const vehicleDrivers  = {};
      VIEW.forEach(r => {
        const v = String(r[COL.vehicle] || "مجهولة").trim();
        const d = String(r[COL.driver] || "بدون سائق").trim();
        byVehicleWeight[v] = (byVehicleWeight[v] || 0) + toNumber(r[COL.weight]);
        byVehicleTrips[v]  = (byVehicleTrips[v] || 0) + 1;
        if (!vehicleDrivers[v]) vehicleDrivers[v] = new Set();
        vehicleDrivers[v].add(d);
      });
      
      // tops
      let topVehicleWeight = "-";
      if (Object.keys(byVehicleWeight).length > 0) {
        topVehicleWeight = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1])[0][0];
      }
      document.getElementById("k_topVehicleWeight").textContent = topVehicleWeight;
      let topVehicleTrips = "-";
      if (Object.keys(byVehicleTrips).length > 0) {
        topVehicleTrips = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1])[0][0];
      }
      document.getElementById("k_topVehicleTrips").textContent = topVehicleTrips;
      
      // top day by weight
      const byDate = {};
      VIEW.forEach(r => {
        const d = r[COL.date];
        if (!d) return;
        byDate[d] = (byDate[d] || 0) + toNumber(r[COL.weight]);
      });
      let topDay = "-";
      if (Object.keys(byDate).length > 0) {
        topDay = Object.entries(byDate).sort((a,b)=> b[1]-a[1])[0][0];
      }
      document.getElementById("k_topDay").textContent = topDay;

      // charts data
      let weightEntries = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1]);
      let tripEntries = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1]);

      // local filters Vehicle Weight
      let vwQuery=document.getElementById("vwSearch").value.toLowerCase();
      let vwTopN=parseInt(document.getElementById("vwTopN").value||"10");
      weightEntries=weightEntries.filter(e=>e[0].toLowerCase().includes(vwQuery)).slice(0,vwTopN);
      
      // local filters Vehicle Trips
      let vtQuery=document.getElementById("vtSearch").value.toLowerCase();
      let vtTopN=parseInt(document.getElementById("vtTopN").value||"10");
      tripEntries=tripEntries.filter(e=>e[0].toLowerCase().includes(vtQuery)).slice(0,vtTopN);
      
      const labelsWeight = weightEntries.map(e=>e[0]);
      const dataWeightTon = weightEntries.map(e=> (e[1]/1000).toFixed(2));
      const labelsTrips = tripEntries.map(e=>{
        const v = e[0];
        const drivers = Array.from(vehicleDrivers[v]||[]).join(", ");
        return v + " – " + drivers;
      });
      const dataTrips = tripEntries.map(e=> e[1]);
      
      // toggle chart visibility
      document.getElementById("chartWeightBox").style.display = labelsWeight.length > 1 ? "block" : "none";
      document.getElementById("chartTripsBox").style.display = labelsTrips.length > 1 ? "block" : "none";

      // bar chart
      if (labelsWeight.length > 1) {
        if (vehicleWeightChart) vehicleWeightChart.destroy();
        const ctx1 = document.getElementById("vehicleWeightChart").getContext("2d");
        vehicleWeightChart = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: labelsWeight,
            datasets: [{
              label: "الوزن الكلي (طن)",
              data: dataWeightTon,
              backgroundColor: "rgba(59,130,246,0.7)"
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (ctx)=> ` ${ctx.parsed.y} طن` }}
            },
            scales: {
              x: { title: { display: true, text: "المركبة" } },
              y: { title: { display: true, text: "الوزن (طن)" } }
            }
          }
        });
      }

      // pie chart
      if (labelsTrips.length > 1) {
        if (vehicleTripsChart) vehicleTripsChart.destroy();
        const ctx2 = document.getElementById("vehicleTripsChart").getContext("2d");
        vehicleTripsChart = new Chart(ctx2, {
          type: 'pie',
          data: {
            labels: labelsTrips,
            datasets: [{
              label: "عدد الرحلات",
              data: dataTrips,
              backgroundColor: ["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#84cc16","#d946ef","#fb7185","#22c55e","#a78bfa"]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'right' },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                    const v = ctx.parsed;
                    const pct = total ? (v*100/total).toFixed(1) : 0;
                    return ` ${ctx.label}: ${v} رحلة (${pct}%)`;
                  }
                }
              },
              datalabels: {
                color: '#fff',
                formatter: (value, ctx) => {
                  const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percentage = sum ? (value * 100 / sum).toFixed(1) + "%" : "0%";
                  return percentage;
                }
              }
            }
          }
        });
      }
      
      // time series + drivers
      updateTimeSeriesChart();
      updateDriverViews();
    }

    /* ===== سجل الرحلات + ترقيم الصفحات ===== */
    let currentPage = 1;
    let pageSize = 25;
    function updatePaginationControls(totalPages) {
      document.getElementById("pageIdx").textContent = String(currentPage);
      document.getElementById("pageTotal").textContent = String(totalPages);
      document.getElementById("pageIdx2").textContent = String(currentPage);
      document.getElementById("pageTotal2").textContent = String(totalPages);
    }
    function updateTable() {
      const tb = document.getElementById("tbody");
      tb.innerHTML = "";
      const totalRows = VIEW.length;
      const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * pageSize;
      const end = Math.min(start + pageSize, totalRows);
      const rows = VIEW.slice(start, end);
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${r[COL.month] || "-"}</td>
          <td class="px-4 py-2">${r[COL.date] || "-"}</td>
          <td class="px-4 py-2">${r[COL.driver] || "-"}</td>
          <td class="px-4 py-2">${formatTonFromKg(toNumber(r[COL.weight]) * 1000) + " طن"}</td>
          <td class="px-4 py-2">${r[COL.vehicle] || "-"}</td>
        `;
        tb.appendChild(tr);
      });
      updatePaginationControls(totalPages);
    }
    document.getElementById("pageSize").addEventListener("change", (e) => {
      pageSize = parseInt(e.target.value);
      currentPage = 1;
      updateTable();
    });
    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        updateTable();
      }
    });
    document.getElementById("nextPage").addEventListener("click", () => {
      const totalRows = VIEW.length;
      const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
      if (currentPage < totalPages) {
        currentPage++;
        updateTable();
      }
    });
    document.getElementById("prevPage2").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        updateTable();
      }
    });
    document.getElementById("nextPage2").addEventListener("click", () => {
      const totalRows = VIEW.length;
      const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
      if (currentPage < totalPages) {
        currentPage++;
        updateTable();
      }
    });

    /* ===== Driver Analysis ===== */
    function updateDriverViews() {
      const byDriver = {};
      const byDriverVehicle = {};
      const driverAnalysisTable = document.getElementById("driverTable");
      driverAnalysisTable.innerHTML = "";
      
      VIEW.forEach(r => {
        const d = String(r[COL.driver] || "بدون سائق").trim();
        const v = String(r[COL.vehicle] || "مجهولة").trim();
        const w = toNumber(r[COL.weight]);
        if (!byDriver[d]) {
          byDriver[d] = { trips: 0, weight: 0 };
        }
        byDriver[d].trips++;
        byDriver[d].weight += w;
        if (!byDriverVehicle[d]) {
          byDriverVehicle[d] = new Set();
        }
        byDriverVehicle[d].add(v);
      });

      let driverSummary = Object.keys(byDriver).map(d => ({
        driver: d,
        trips: byDriver[d].trips,
        weightTon: byDriver[d].weight / 1000,
        avgTon: (byDriver[d].weight / 1000) / byDriver[d].trips,
        vehicles: Array.from(byDriverVehicle[d])
      }));

      const dSearch = document.getElementById("driverSearch").value.toLowerCase();
      const dSort = document.getElementById("driverSort").value;
      const dTopN = parseInt(document.getElementById("driverTopN").value) || 10;
      
      let filteredDrivers = driverSummary.filter(d => d.driver.toLowerCase().includes(dSearch));

      filteredDrivers.sort((a, b) => {
        if (dSort === "weight") return b.weightTon - a.weightTon;
        if (dSort === "trips") return b.trips - a.trips;
        if (dSort === "avg") return b.avgTon - a.avgTon;
        return 0;
      }).slice(0, dTopN);
      
      // Update chart
      const chartLabels = filteredDrivers.map(d => d.driver);
      const chartData = filteredDrivers.map(d => d[dSort === 'trips' ? 'trips' : 'weightTon'].toFixed(2));
      const chartLabel = dSort === 'trips' ? 'عدد الرحلات' : 'الوزن (طن)';
      const ctx = document.getElementById("driverChart").getContext("2d");
      if(driverChart) driverChart.destroy();
      driverChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: chartLabel,
            data: chartData,
            backgroundColor: 'rgba(255, 159, 64, 0.7)'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: "السائق" } },
            y: { title: { display: true, text: chartLabel } }
          }
        }
      });
      
      filteredDrivers.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${row.driver}</td>
          <td class="px-4 py-2">${row.trips}</td>
          <td class="px-4 py-2">${row.weightTon.toFixed(2)}</td>
          <td class="px-4 py-2">${row.avgTon.toFixed(2)}</td>
          <td class="px-4 py-2">${row.vehicles.length}</td>
          <td class="px-4 py-2">${row.vehicles.join(', ')}</td>
        `;
        driverAnalysisTable.appendChild(tr);
      });
    }

    /* ===== Download Functions ===== */
    function downloadCSV(data, filename) {
      const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + Papa.unparse(data);
      const link = document.createElement('a');
      link.href = encodeURI(csvContent);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function downloadXLSX() {
      const wsTrips = XLSX.utils.json_to_sheet(VIEW.map(r => {
        const row = {};
        Object.keys(COL).forEach(key => row[COL[key]] = r[COL[key]]);
        return row;
      }));
      const wsVehAnalysis = XLSX.utils.table_to_sheet(document.getElementById("vehAnalysisTable"));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, wsTrips, "سجل الرحلات");
      XLSX.utils.book_append_sheet(wb, wsVehAnalysis, "تحليل المركبات");
      XLSX.writeFile(wb, "تقرير_النقل.xlsx");
    }

    function downloadPDF(title, elementId) {
        const element = document.getElementById(elementId);
        html2canvas(element, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps= pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`${title}.pdf`);
        });
    }
    
    /* ===== Papaparse Logic ===== */
    function fetchDataAndRender() {
      setLoading(true);
      dataLoaded = false;
      vehiclesLoaded = false;
      fuelLoaded = false;
      maintenanceLoaded = false;
      
      const promises = [
        fetch(CSV_URL).then(res => res.text()).then(text => {
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              ALL = results.data;
              dataLoaded = true;
              maybeHideOverlay();
              render();
            }
          });
        }),
        fetch(VEH_URL).then(res => res.text()).then(text => {
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              VEHICLES = results.data;
              vehiclesLoaded = true;
              maybeHideOverlay();
            }
          });
        }),
        fetch(FUEL_URL).then(res => res.text()).then(text => {
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              FUEL = results.data;
              fuelLoaded = true;
              maybeHideOverlay();
            }
          });
        }),
        fetch(MAINTENANCE_URL).then(res => res.text()).then(text => {
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              MAINTENANCE = results.data;
              maintenanceLoaded = true;
              maybeHideOverlay();
            }
          });
        })
      ];
      
      Promise.all(promises).then(() => {
        render();
      }).catch(err => {
        console.error("Failed to fetch data", err);
        setLoading(false);
      });
    }

    /* ===== Event Listeners for Filters ===== */
    function updateDropdownButtonText(menuId, buttonId, baseText) {
      const checkedBoxes = document.querySelectorAll(`#${menuId} input[type='checkbox']:checked`);
      const button = document.getElementById(buttonId);
      if(checkedBoxes.length > 0) {
        button.textContent = `${baseText} (${checkedBoxes.length})`;
      } else {
        button.textContent = `اختر ${baseText}...`;
      }
    }

    document.getElementById("q").addEventListener("input", render);
    document.getElementById("dateExact").addEventListener("input", render);
    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("q").value = "";
      document.getElementById("dateExact").value = "";
      document.getElementById("monthDropdownMenu").innerHTML = "";
      document.getElementById("vehicleDropdownMenu").innerHTML = "";
      document.getElementById("monthDropdownBtn").textContent = "اختر الشهور...";
      document.getElementById("vehicleDropdownBtn").textContent = "اختر المركبات...";
      render();
    });
    document.getElementById("refreshBtn").addEventListener("click", fetchDataAndRender);

    // Event listeners for vehicle analysis filters
    document.getElementById("vaSearch").addEventListener("input", renderVehAnalysis);
    document.getElementById("vaYear").addEventListener("input", renderVehAnalysis);
    document.getElementById("vaSort").addEventListener("change", renderVehAnalysis);

    // Event listeners for vehicle chart filters
    document.getElementById("vwSearch").addEventListener("input", updateKPIs);
    document.getElementById("vwTopN").addEventListener("input", updateKPIs);
    document.getElementById("vtSearch").addEventListener("input", updateKPIs);
    document.getElementById("vtTopN").addEventListener("input", updateKPIs);

    // Event listeners for time series filters
    document.getElementById("tsAgg").addEventListener("change", updateTimeSeriesChart);
    document.getElementById("tsMetric").addEventListener("change", updateTimeSeriesChart);
    
    // Event listeners for driver analysis
    document.getElementById("driverSearch").addEventListener("input", updateDriverViews);
    document.getElementById("driverSort").addEventListener("change", updateDriverViews);
    document.getElementById("driverTopN").addEventListener("input", updateDriverViews);

    // Download buttons
    document.getElementById("btnCSV").addEventListener("click", () => {
      downloadCSV(VIEW, "سجل_الرحلات.csv");
    });
    document.getElementById("btnXLSX").addEventListener("click", downloadXLSX);
    document.getElementById("btnPDF").addEventListener("click", () => {
      downloadPDF('سجل_الرحلات_المصفى', 'rawTripsBox');
    });
    document.getElementById("btnDriversCSV").addEventListener("click", () => {
      const driversData = Object.keys(byDriver).map(d => ({
        "السائق": d,
        "عدد الرحلات": byDriver[d].trips,
        "الوزن (طن)": (byDriver[d].weight / 1000).toFixed(2),
        "متوسط/رحلة (طن)": ((byDriver[d].weight / 1000) / byDriver[d].trips).toFixed(2),
        "عدد المركبات": byDriverVehicle[d].size,
        "المركبات": Array.from(byDriverVehicle[d]).join(', ')
      }));
      downloadCSV(driversData, "تحليل_السائقين.csv");
    });

    /* ===== Render شامل ===== */
    function render() {
      applyFilters();
      updateKPIs();
      updateTable();
      renderVehAnalysis();
    }

    /* تسجيل بلجن الداتا ليبلز */
    if (window.ChartDataLabels) { Chart.register(ChartDataLabels); }

    /* ===== Start ===== */
    document.addEventListener("DOMContentLoaded", ()=>{
      fetchDataAndRender();
      
      const monthDropdownBtn = document.getElementById("monthDropdownBtn");
      const monthDropdownMenu = document.getElementById("monthDropdownMenu");
      monthDropdownBtn.addEventListener("click", () => {
        monthDropdownMenu.style.display = monthDropdownMenu.style.display === 'block' ? 'none' : 'block';
      });
      document.addEventListener('click', (e) => {
        if (!monthDropdownBtn.contains(e.target) && !monthDropdownMenu.contains(e.target)) {
          monthDropdownMenu.style.display = 'none';
        }
      });
      
      const vehicleDropdownBtn = document.getElementById("vehicleDropdownBtn");
      const vehicleDropdownMenu = document.getElementById("vehicleDropdownMenu");
      vehicleDropdownBtn.addEventListener("click", () => {
        vehicleDropdownMenu.style.display = vehicleDropdownMenu.style.display === 'block' ? 'none' : 'block';
      });
      document.addEventListener('click', (e) => {
        if (!vehicleDropdownBtn.contains(e.target) && !vehicleDropdownMenu.contains(e.target)) {
          vehicleDropdownMenu.style.display = 'none';
        }
      });
    });

    function createCheckboxes() {
      const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
      const monthMenu = document.getElementById("monthDropdownMenu");
      monthMenu.innerHTML = "";
      months.forEach(m => {
        const label = document.createElement("label");
        label.className = "flex items-center gap-2 px-3 py-1 hover:bg-gray-100 cursor-pointer";
        label.innerHTML = `<input type="checkbox" value="${m}" class="rounded text-blue-600 focus:ring-blue-500"> ${m}`;
        monthMenu.appendChild(label);
        label.querySelector('input').addEventListener('change', () => {
          updateDropdownButtonText('monthDropdownMenu', 'monthDropdownBtn', 'الشهور');
          render();
        });
      });
      
      const vehicles = Array.from(new Set(ALL.map(r => r[COL.vehicle]).filter(Boolean))).sort();
      const vehicleMenu = document.getElementById("vehicleDropdownMenu");
      vehicleMenu.innerHTML = "";
      vehicles.forEach(v => {
        const label = document.createElement("label");
        label.className = "flex items-center gap-2 px-3 py-1 hover:bg-gray-100 cursor-pointer";
        label.innerHTML = `<input type="checkbox" value="${v}" class="rounded text-blue-600 focus:ring-blue-500"> ${v}`;
        vehicleMenu.appendChild(label);
        label.querySelector('input').addEventListener('change', () => {
          updateDropdownButtonText('vehicleDropdownMenu', 'vehicleDropdownBtn', 'المركبات');
          render();
        });
      });
    }

    document.getElementById('monthSelectAll').addEventListener('click', () => {
      document.querySelectorAll("#monthDropdownMenu input[type='checkbox']").forEach(cb => cb.checked = true);
      updateDropdownButtonText('monthDropdownMenu', 'monthDropdownBtn', 'الشهور');
      render();
    });
    document.getElementById('monthClearAll').addEventListener('click', () => {
      document.querySelectorAll("#monthDropdownMenu input[type='checkbox']").forEach(cb => cb.checked = false);
      updateDropdownButtonText('monthDropdownMenu', 'monthDropdownBtn', 'الشهور');
      render();
    });
    document.getElementById('vehSelectAll').addEventListener('click', () => {
      document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']").forEach(cb => cb.checked = true);
      updateDropdownButtonText('vehicleDropdownMenu', 'vehicleDropdownBtn', 'المركبات');
      render();
    });
    document.getElementById('vehClearAll').addEventListener('click', () => {
      document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']").forEach(cb => cb.checked = false);
      updateDropdownButtonText('vehicleDropdownMenu', 'vehicleDropdownBtn', 'المركبات');
      render();
    });
  </script>
</body>
</html>
