<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    /* تخصيص شريط تمرير بسيط */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }

    /* أنماط الأقسام القابلة للطي */
    .collapsible-header {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-radius: 0.75rem;
      background-color: #f1f5f9; /* bg-slate-100 */
      font-weight: 600;
      color: #1e293b; /* text-slate-900 */
      transition: background-color 0.2s ease-in-out;
    }

    .collapsible-header:hover {
      background-color: #e2e8f0; /* bg-slate-200 */
    }

    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
      padding: 0 1.5rem; /* padding-x p-6 */
    }

    .collapsible-content.expanded {
      max-height: 2000px; /* قيمة كبيرة بما يكفي لاستيعاب المحتوى */
      padding: 1.5rem;
    }

    .collapsible-content.expanded.p-4 {
      padding: 1rem;
    }

    .rotate-icon {
      transition: transform 0.3s ease-in-out;
    }

    .expanded .rotate-icon {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="loadingOverlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="flex flex-col items-center gap-3">
      <div class="h-8 w-8 rounded-full border-4 border-blue-600 border-t-transparent animate-spin"></div>
      <div class="text-sm text-blue-700">جاري التحميل...</div>
    </div>
  </div>

  <header class="bg-blue-600 text-white p-6 shadow">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow p-4 mb-6 grid grid-cols-1 lg:grid-cols-7 gap-4">
      <div class="lg:col-span-2">
        <label class="block text-sm mb-1">بحث عام</label>
        <input id="q" type="text" placeholder="ابحث بتاريخ أو سائق أو رقم مركبة..." class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">الشهور </label>
          <div class="flex gap-2 text-xs">
            <button id="monthSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50">تحديد الكل</button>
            <button id="monthClearAll" class="px-2 py-1 rounded border hover:bg-gray-50">مسح</button>
          </div>
        </div>
        <div class="relative">
          <button id="monthDropdownBtn" class="w-full text-right border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">اختر الشهور...</button>
          <div id="monthDropdownMenu" class="absolute hidden top-full left-0 z-10 w-full bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
            </div>
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">أرقام المركبات </label>
          <div class="flex gap-2 text-xs">
            <button id="vehSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50">تحديد الكل</button>
            <button id="vehClearAll" class="px-2 py-1 rounded border hover:bg-gray-50">مسح</button>
          </div>
        </div>
        <div class="relative">
          <button id="vehicleDropdownBtn" class="w-full text-right border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">اختر المركبات...</button>
          <div id="vehicleDropdownMenu" class="absolute hidden top-full left-0 z-10 w-full bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
            </div>
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">تاريخ محدد</label>
        <input id="dateExact" type="date" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div class="flex items-end lg:col-span-2">
        <div class="flex flex-wrap gap-2">
          <button id="resetBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">إعادة تعيين الفلاتر</button>
          <button id="refreshBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تحديث من المصدر</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الرحلات</p><h3 id="k_trips" class="text-2xl font-bold text-blue-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الوزن</p><h3 id="k_weight" class="text-2xl font-bold text-green-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي كلفة الوقود</p><h3 id="k_totalFuelCost" class="text-2xl font-bold text-teal-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي كلفة الصيانة</p><h3 id="k_totalMaintenanceCost" class="text-2xl font-bold text-rose-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد المركبات</p><h3 id="k_vehicleCount" class="text-2xl font-bold text-yellow-600">0</h3></div>

      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">متوسط حمولة الرحلة</p><h3 id="k_avg" class="text-2xl font-bold text-purple-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد السائقين</p><h3 id="k_drivers" class="text-2xl font-bold text-orange-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (وزن)</p><h3 id="k_topVehicleWeight" class="text-xl font-bold text-red-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (رحلات)</p><h3 id="k_topVehicleTrips" class="text-xl font-bold text-indigo-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">اليوم الأعلى وزناً</p><h3 id="k_topDay" class="text-xl font-bold text-pink-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط يومي</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgDailyWeight" class="font-bold text-blue-600">0</span> طن/يوم</div>
          <div>الرحلات: <span id="k_avgDailyTrips" class="font-bold text-blue-600">0</span> رحلة/يوم</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط شهري</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgMonthlyWeight" class="font-bold text-blue-600">0</span> طن/شهر</div>
          <div>الرحلات: <span id="k_avgMonthlyTrips" class="font-bold text-blue-600">0</span> رحلة/شهر</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow mb-6">
      <div class="collapsible-header" id="tsHeader">
        <h3 class="font-semibold">السلاسل الزمنية</h3>
        <svg class="rotate-icon w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
      </div>
      <div class="collapsible-content p-6" id="tsContent">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <select id="tsAgg" class="border rounded-lg px-3 py-2">
            <option value="day">تجميع يومي</option>
            <option value="month">تجميع شهري</option>
          </select>
          <select id="tsMetric" class="border rounded-lg px-3 py-2">
            <option value="weight">الوزن (طن)</option>
            <option value="trips">الرحلات</option>
          </select>
        </div>
        <canvas id="timeSeriesChart" height="120"></canvas>
        <p class="text-xs text-gray-500 mt-2">* قد تُستثنى السجلات بلا تاريخ من الرسم اليومي.</p>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow mb-6">
      <div class="collapsible-header" id="vwHeader">
        <h3 class="font-semibold">وزن النقل حسب المركبة (بالطن)</h3>
        <svg class="rotate-icon w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
      </div>
      <div class="collapsible-content p-6" id="vwContent">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <label class="text-sm">بحث عن مركبة:</label>
          <input id="vwSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
          <label class="text-sm">Top N:</label>
          <input id="vwTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
        </div>
        <canvas id="vehicleWeightChart" height="120"></canvas>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow mb-6">
      <div class="collapsible-header" id="vtHeader">
        <h3 class="font-semibold">نسبة عدد الرحلات لكل مركبة</h3>
        <svg class="rotate-icon w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
      </div>
      <div class="collapsible-content p-6" id="vtContent">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <label class="text-sm">بحث عن مركبة:</label>
          <input id="vtSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
          <label class="text-sm">Top N:</label>
          <input id="vtTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
        </div>
        <canvas id="vehicleTripsChart" height="120"></canvas>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow mb-6">
      <div class="collapsible-header" id="vaHeader">
        <h3 class="font-semibold">تحليل كفاءة المركبات</h3>
        <svg class="rotate-icon w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
      </div>
      <div class="collapsible-content p-6" id="vaContent">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <label class="text-sm">بحث:</label>
          <input id="vaSearch" type="text" placeholder="ابحث..." class="border rounded-lg px-3 py-1">
          <label class="text-sm">من سنة تصنيع:</label>
          <input id="vaYear" type="number" placeholder="2000" class="w-24 border rounded-lg px-3 py-1">
          <label class="text-sm">ترتيب تنازلي حسب:</label>
          <select id="vaSort" class="border rounded-lg px-3 py-1">
            <option value="eff">نسبة الاستغلال</option>
            <option value="fuelCost">كلفة الوقود</option>
            <option value="maintenanceCost">كلفة الصيانة</option>
            <option value="costPerTrip">كلفة الرحلة</option>
            <option value="costPerTon">كلفة الطن</option>
            <option value="capTon">السعة النظرية</option>
            <option value="trips">عدد الرحلات</option>
            <option value="wton">الوزن المنقول</option>
            <option value="year">سنة التصنيع</option>
          </select>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-right">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2">رقم المركبة</th>
                <th class="px-4 py-2">السائق</th>
                <th class="px-4 py-2">سنة التصنيع</th>
                <th class="px-4 py-2">السعة (م³)</th>
                <th class="px-4 py-2">السعة النظرية (طن)</th>
                <th class="px-4 py-2">عدد الرحلات</th>
                <th class="px-4 py-2">الوزن المنقول (طن)</th>
                <th class="px-4 py-2">نسبة الاستغلال %</th>
                <th class="px-4 py-2">كلفة الوقود</th>
                <th class="px-4 py-2">كلفة الصيانة</th>
                <th class="px-4 py-2">كلفة الرحلة</th>
                <th class="px-4 py-2">كلفة الطن</th>
              </tr>
            </thead>
            <tbody id="vehAnalysisTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 mb-6">
      <button id="btnCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (الرحلات الحالية)</button>
      <button id="btnXLSX" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير Excel (رحلات + ملخص مركبات)</button>
      <button id="btnPDF" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">PDF (سجل الرحلات)</button>
      <button id="btnDriversCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (تحليل السائقين)</button>
    </div>

    <div class="bg-white rounded-xl shadow mb-6">
      <div class="collapsible-header" id="driversHeader">
        <h3 class="font-semibold">تحليل السائقين</h3>
        <svg class="rotate-icon w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
      </div>
      <div class="collapsible-content p-6" id="driversContent">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <label class="text-sm">الترتيب</label>
          <select id="driverSort" class="border rounded-lg px-3 py-2">
            <option value="weight">حسب الوزن</option>
            <option value="trips">حسب الرحلات</option>
            <option value="avg">متوسط حمولة/رحلة</option>
          </select>
          <label class="text-sm">عدد السائقين (Top N)</label>
          <input id="driverTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-2">
          <label class="text-sm">بحث عن سائق</label>
          <input id="driverSearch" type="text" placeholder="اسم السائق" class="border rounded-lg px-3 py-2">
        </div>
        <canvas id="driverChart" height="120" class="mb-6"></canvas>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-right">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2">السائق</th>
                <th class="px-4 py-2">عدد الرحلات</th>
                <th class="px-4 py-2">الوزن (طن)</th>
                <th class="px-4 py-2">متوسط/رحلة (طن)</th>
                <th class="px-4 py-2">عدد المركبات</th>
                <th class="px-4 py-2">المركبات</th>
              </tr>
            </thead>
            <tbody id="driverTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow mb-6">
      <div class="collapsible-header" id="rawTripsHeader">
        <h3 class="font-semibold">سجل الرحلات</h3>
        <svg class="rotate-icon w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
      </div>
      <div class="collapsible-content p-6" id="rawTripsContent">
        <div class="p-4 flex flex-wrap items-center gap-3">
          <label class="text-sm">عدد الصفوف في الصفحة</label>
          <select id="pageSize" class="border rounded-lg px-2 py-1">
            <option>10</option>
            <option selected>25</option>
            <option>50</option>
            <option>100</option>
          </select>
          <div class="ms-auto flex items-center gap-2">
            <button id="prevPage" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
            <span class="text-sm">صفحة <span id="pageIdx">1</span> من <span id="pageTotal">1</span></span>
            <button id="nextPage" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-right">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2">الشهر</th>
                <th class="px-4 py-2">تاريخ التوزين الثاني</th>
                <th class="px-4 py-2">السائق</th>
                <th class="px-4 py-2">صافي التحميل (طن)</th>
                <th class="px-4 py-2">رقم المركبة</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="p-4 border-t flex items-center gap-2">
          <button id="prevPage2" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
          <span class="text-sm">صفحة <span id="pageIdx2">1</span> من <span id="pageTotal2">1</span></span>
          <button id="nextPage2" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
          <div class="ms-auto text-xs text-gray-500">* الترتيب الافتراضي حسب ترتيب المصدر.</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    /* ===== إعدادات الأعمدة ===== */
    const COL = {
      month: "الشهر",
      date: "تاريخ التوزين الثاني",
      driver: "السائق",
      weight: "صافي التحميل",
      vehicle: "رقم المركبة"
    };
    const VEH_COLS = {
      plate: "رقم المركبة",
      driver: "السائق",
      year: "سنة التصنيع",
      capacity: "السعة",
      capTon: "السعة النظرية"
    };
    const FUEL_COLS = {
      plate: "رقم المركبة",
      jan: "jan", feb: "feb", mar: "mar", apr: "apr", may: "may", jun: "jun",
      july: "july", aug: "aug", sep: "sep", oct: "oct", nov: "nov", dec: "dec"
    };
    const MAINT_COLS = {
      plate: "رقم المركبة",
      cost: "كلفة الصيانة"
    };
    /* ===== روابط الشيتات ===== */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";
    const VEH_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2001178330&single=true&output=csv";
    const FUEL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=1380959426&single=true&output=csv";
    const MAINTENANCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2095309457&single=true&output=csv";

    /* ===== متغيرات عامة ===== */
    let ALL = [];
    let VIEW = [];
    let VEHICLES = [];
    let FUEL = [];
    let MAINTENANCE = [];
    let vehicleWeightChart = null;
    let vehicleTripsChart  = null;
    let timeSeriesChart    = null;
    let driverChart        = null;
    /* تحميل/تعطيل */
    let dataLoaded = false, vehiclesLoaded = false, fuelLoaded = false, maintenanceLoaded = false;
    const controlsSelector = 'input, select, button';
    function setLoading(state) {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = state ? 'flex' : 'none';
      document.querySelectorAll(controlsSelector).forEach(el => {
        if (el.id === 'refreshBtn') return; // اسمح بالتحديث دائماً
        el.disabled = state;
      });
    }
    function maybeHideOverlay() {
      if (dataLoaded && vehiclesLoaded && fuelLoaded && maintenanceLoaded) setLoading(false);
    }

    /* أدوات مساعدة */
    function toNumber(v) {
      if (v == null) return 0;
      let s = String(v).trim();
      const arabicMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
      s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
      s = s.replace(/[^\d.]/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    function formatTonFromKg(kg) {
      const t = kg / 1000;
      return t.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function toYMD(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const d = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function toYM(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    }

    /* ===== فلترة ===== */
    function applyFilters() {
      const q = document.getElementById("q").value.trim().toLowerCase();
      const monthCheckboxes = document.querySelectorAll("#monthDropdownMenu input[type='checkbox']");
      const vehicleCheckboxes = document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']");
      const months = Array.from(monthCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
      const vehicles = Array.from(vehicleCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
      const d = document.getElementById("dateExact").value;
      VIEW = ALL.filter(r => {
        const recMonth = String(r[COL.month] || "").trim();
        const recVeh   = String(r[COL.vehicle] || "").trim();
        const byMonth   = months.length ? months.includes(recMonth) : true;
        const byVehicle = vehicles.length ? vehicles.includes(recVeh) : true;
        let byDate = true;
        if (d) {
          if (!r[COL.date]) byDate = false;
          else {
            const recordDate = new Date(r[COL.date]);
            const exactDate = new Date(d);
            byDate = recordDate.toDateString() === exactDate.toDateString();
          }
        }
        if (!byMonth || !byVehicle || !byDate) return false;
        if (!q) return true;
        const hay = [r[COL.month], r[COL.date], r[COL.driver], r[COL.weight], r[COL.vehicle]].map(x => (x==null?"":String(x))).join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    /* ===== ملخص المركبات ===== */
    function updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers) {
      const vehiclesSet = new Set([...Object.keys(byVehicleTrips), ...Object.keys(byVehicleWeight)]);
      let summary = Array.from(vehiclesSet).map(v => ({
        vehicle: v,
        drivers: Array.from(vehicleDrivers[v] || []),
        trips: byVehicleTrips[v] || 0,
        weightTon: (byVehicleWeight[v] || 0) / 1000
      }));
      const vsQuery=document.getElementById("vsSearch")?.value?.toLowerCase() || "";
      const vsSort=document.getElementById("vsSort")?.value || "weight";
      if(vsQuery){
        summary=summary.filter(r=>r.vehicle.toLowerCase().includes(vsQuery)||r.drivers.join(", ").toLowerCase().includes(vsQuery));
      }
      if(vsSort==="weight"){ summary.sort((a,b)=>b.weightTon-a.weightTon);
      }
      else if(vsSort==="trips"){ summary.sort((a,b)=>b.trips-a.trips);
      }

      const tbody = document.getElementById("vehicleSummary");
      if (!tbody) return;
      tbody.innerHTML = "";
      summary.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${row.vehicle}</td>
          <td class="px-4 py-2">${row.drivers.join(", ")}</td>
          <td class="px-4 py-2">${row.trips}</td>
          <td class="px-4 py-2">${row.weightTon.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    /* ===== تحليل كفاءة المركبات ===== */
    function renderVehAnalysis() {
      const byVehicleTrips = {};
      const byVehicleWeight = {};
      VIEW.forEach(r => {
        const v = String(r[COL.vehicle] || "").trim();
        const w = toNumber(r[COL.weight]);
        if (!byVehicleTrips[v]) byVehicleTrips[v] = 0;
        if (!byVehicleWeight[v]) byVehicleWeight[v] = 0;
        byVehicleTrips[v]++;
        byVehicleWeight[v] += w;
      });
      const allVehiclesMap = new Map();
      VEHICLES.forEach(v => allVehiclesMap.set(String(v[VEH_COLS.plate] || "").trim(), v));
      const vehicleData = Array.from(allVehiclesMap.keys())
        .filter(vPlate => Object.keys(byVehicleTrips).includes(vPlate))
        .map(vPlate => {
          const vData = allVehiclesMap.get(vPlate);
          const totalTrips = byVehicleTrips[vPlate] || 0;
          const totalWeight = byVehicleWeight[vPlate] || 0;
          const fuelData = FUEL.find(f => String(f[FUEL_COLS.plate] || "").trim() === vPlate);
          const maintData = MAINTENANCE.find(m => String(m[MAINT_COLS.plate] || "").trim() === vPlate);
          const totalFuelCost = Object.keys(FUEL_COLS).slice(1).reduce((sum, month) => sum + toNumber(fuelData?.[month]), 0);
          const totalMaintenanceCost = toNumber(maintData?.[MAINT_COLS.cost]);
          const capTon = toNumber(vData?.[VEH_COLS.capTon]);
          const costPerTrip = totalTrips > 0 ? (totalFuelCost + totalMaintenanceCost) / totalTrips : 0;
          const costPerTon = (totalWeight / 1000) > 0 ? (totalFuelCost + totalMaintenanceCost) / (totalWeight / 1000) : 0;
          const efficiency = (capTon > 0 && (totalWeight/1000) > 0) ? (totalWeight/1000)/capTon/totalTrips*100 : 0;
          return {
            plate: vPlate,
            driver: vData?.[VEH_COLS.driver],
            year: toNumber(vData?.[VEH_COLS.year]),
            capacity: toNumber(vData?.[VEH_COLS.capacity]),
            capTon: capTon,
            trips: totalTrips,
            wton: totalWeight / 1000,
            eff: efficiency,
            fuelCost: totalFuelCost,
            maintenanceCost: totalMaintenanceCost,
            costPerTrip: costPerTrip,
            costPerTon: costPerTon
          };
        });
      
      const vaSearch = document.getElementById("vaSearch").value.toLowerCase();
      const vaYear = toNumber(document.getElementById("vaYear").value);
      const vaSort = document.getElementById("vaSort").value;
      let filteredData = vehicleData.filter(d => 
        (d.plate.toLowerCase().includes(vaSearch) || d.driver?.toLowerCase().includes(vaSearch)) &&
        (vaYear === 0 || d.year >= vaYear)
      );
      filteredData.sort((a,b) => {
        if(vaSort === "eff") return b.eff - a.eff;
        if(vaSort === "fuelCost") return b.fuelCost - a.fuelCost;
        if(vaSort === "maintenanceCost") return b.maintenanceCost - a.maintenanceCost;
        if(vaSort === "costPerTrip") return b.costPerTrip - a.costPerTrip;
        if(vaSort === "costPerTon") return b.costPerTon - a.costPerTon;
        if(vaSort === "capTon") return b.capTon - a.capTon;
        if(vaSort === "trips") return b.trips - a.trips;
        if(vaSort === "wton") return b.wton - a.wton;
        if(vaSort === "year") return b.year - a.year;
        return 0;
      });
      const tbody = document.getElementById("vehAnalysisTable");
      tbody.innerHTML = "";
      filteredData.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${row.plate}</td>
          <td class="px-4 py-2">${row.driver || "-"}</td>
          <td class="px-4 py-2">${row.year || "-"}</td>
          <td class="px-4 py-2">${row.capacity || "-"}</td>
          <td class="px-4 py-2">${row.capTon ? row.capTon.toFixed(2) : "-"}</td>
          <td class="px-4 py-2">${row.trips}</td>
          <td class="px-4 py-2">${row.wton.toFixed(2)}</td>
          <td class="px-4 py-2">${row.eff.toFixed(2)}%</td>
          <td class="px-4 py-2">${row.fuelCost.toFixed(2)}</td>
          <td class="px-4 py-2">${row.maintenanceCost.toFixed(2)}</td>
          <td class="px-4 py-2">${row.costPerTrip.toFixed(2)}</td>
          <td class="px-4 py-2">${row.costPerTon.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ===== Time Series ===== */

    function computeTimeSeries(agg, metric) {
      const map = {};
      const MONTH_ORDER = ["jan","feb","mar","apr","may","jun","july","aug","sep","oct","nov","dec"];
      VIEW.forEach(r => {
        let key = null;
        if (agg === 'day') {
          if (!r[COL.date]) return;
          const dt = new Date(r[COL.date]);
          if (isNaN(dt)) return;
          key = toYMD(dt);
        } else {
          // شهري: استخدم فقط خانة الشهر
          if (!r[COL.month]) return;
          key = String(r[COL.month]).trim().toLowerCase();
          if (!MONTH_ORDER.includes(key)) return;
        }

        if (!(key in map)) map[key] = 0;
        if (metric === 'weight') map[key] += toNumber(r[COL.weight]) / 1000;
        else map[key] += 1;
      });
      let labels = Object.keys(map);
      if (labels.length === 0) return { labels: [], values: [] };
      if (agg === 'day') {
        labels.sort((a,b)=> new Date(a) - new Date(b));
      } else {
        labels.sort((a,b)=> MONTH_ORDER.indexOf(a) - MONTH_ORDER.indexOf(b));
      }

      const values = labels.map(k => +map[k].toFixed(2));
      return { labels, values };
    }

    function updateTimeSeriesChart() {
      const agg = document.getElementById('tsAgg').value;
      const metric = document.getElementById('tsMetric').value;
      const {labels, values} = computeTimeSeries(agg, metric);
      const ctx = document.getElementById('timeSeriesChart').getContext('2d');
      if (timeSeriesChart) timeSeriesChart.destroy();
      timeSeriesChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: metric === 'weight' ? 'الوزن (طن)' : 'عدد الرحلات', data: values, fill: false, borderColor: metric === 'weight' ? '#3b82f6' : '#10b981', tension: 0.2, pointRadius: 3 }]},
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { title: { display: true, text: agg === 'day' ? 'اليوم' : 'الشهر' } }, y: { title: { display: true, text: metric === 'weight' ? 'طن' : 'رحلة' }, beginAtZero: true } } } });
    }

    /* ===== KPI + Charts ===== */
    function updateKPIs() {
      const trips = VIEW.length;
      const totalWkg = VIEW.reduce((s,r)=> s + toNumber(r[COL.weight]), 0);
      const avgWkg = trips ? (totalWkg / trips) : 0;
      const drivers = new Set(VIEW.map(r => r[COL.driver]).filter(Boolean));
      document.getElementById("k_trips").textContent = trips.toLocaleString();
      document.getElementById("k_weight").textContent = formatTonFromKg(totalWkg) + " طن";
      document.getElementById("k_avg").textContent = formatTonFromKg(avgWkg) + " طن";
      document.getElementById("k_drivers").textContent= drivers.size.toLocaleString();
      // إجمالي كلفة الوقود (تفاعلي حسب المركبات والشهور)
      const visibleVehicles = new Set(VIEW.map(r => String(r[COL.vehicle] || "").trim()).filter(Boolean));
      const monthCheckboxes = document.querySelectorAll("#monthDropdownMenu input[type='checkbox']");
      const selectedMonths = Array.from(monthCheckboxes).filter(cb => cb.checked).map(cb => cb.value.toLowerCase());
      let totalFuelCost = 0;
      FUEL.forEach(f => {
        const vnum = String(f[FUEL_COLS.plate] || "").trim();
        if (!vnum || !visibleVehicles.has(vnum)) return;
        const months = ["jan","feb","mar","apr","may","jun","july","aug","sep","oct","nov","dec"];
        months.forEach(m => {
          if (f[m] && (selectedMonths.length === 0 || selectedMonths.includes(m))) {
            totalFuelCost += toNumber(f[m]);
          }
        });
      });
      const fuelNode = document.getElementById("k_totalFuelCost");
      if (fuelNode) fuelNode.textContent = totalFuelCost.toFixed(2);
      // إجمالي كلفة الصيانة (تفاعلي حسب المركبات الظاهرة)
      let totalMaintenanceCost = 0;
      MAINTENANCE.forEach(m => {
        const vnum = String(m[MAINT_COLS.plate] || "").trim();
        if (!vnum || !visibleVehicles.has(vnum)) return;
        if (m[MAINT_COLS.cost]) totalMaintenanceCost += toNumber(m[MAINT_COLS.cost]);
      });
      const maintNode = document.getElementById("k_totalMaintenanceCost");
      if (maintNode) maintNode.textContent = totalMaintenanceCost.toFixed(2);
      // عدد المركبات
      const vehicleCount = visibleVehicles.size;
      const vehNode = document.getElementById("k_vehicleCount");
      if (vehNode) vehNode.textContent = vehicleCount.toLocaleString();
      const uniqueDays = new Set(VIEW.map(r => r[COL.date]).filter(Boolean));
      const daysCount = uniqueDays.size;
      const avgDailyWeight = daysCount ? (totalWkg/1000) / daysCount : 0;
      const avgDailyTrips = daysCount ? trips / daysCount : 0;
      const monthKeys = new Set();
      VIEW.forEach(r => {
        let key = null;
        if (r[COL.date]) {
          const dt = new Date(r[COL.date]);
          if (!isNaN(dt)) key = toYM(dt);
        }
        if (!key && r[COL.month]) key = String(r[COL.month]).trim();
        if (key) monthKeys.add(key);
      });
      const monthsCount = monthKeys.size;
      const avgMonthlyWeight = monthsCount ? (totalWkg/1000) / monthsCount : 0;
      const avgMonthlyTrips = monthsCount ?
      trips / monthsCount : 0;
      document.getElementById("k_avgDailyWeight").textContent = avgDailyWeight.toFixed(2);
      document.getElementById("k_avgDailyTrips").textContent = avgDailyTrips.toFixed(1);
      document.getElementById("k_avgMonthlyWeight").textContent = avgMonthlyWeight.toFixed(2);
      document.getElementById("k_avgMonthlyTrips").textContent = avgMonthlyTrips.toFixed(1);
      // per vehicle aggregates
      const byVehicleWeight = {};
      const byVehicleTrips = {};
      const vehicleDrivers = {};
      VIEW.forEach(r => {
        const v = String(r[COL.vehicle] || "مجهولة").trim();
        const d = String(r[COL.driver] || "بدون سائق").trim();
        byVehicleWeight[v] = (byVehicleWeight[v] || 0) + toNumber(r[COL.weight]);
        byVehicleTrips[v] = (byVehicleTrips[v] || 0) + 1;
        if (!vehicleDrivers[v]) vehicleDrivers[v] = new Set();
        vehicleDrivers[v].add(d);
      });
      // tops
      let topVehicleWeight = "-";
      if (Object.keys(byVehicleWeight).length > 0) {
        topVehicleWeight = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1])[0][0];
      }
      document.getElementById("k_topVehicleWeight").textContent = topVehicleWeight;
      let topVehicleTrips = "-";
      if (Object.keys(byVehicleTrips).length > 0) {
        topVehicleTrips = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1])[0][0];
      }
      document.getElementById("k_topVehicleTrips").textContent = topVehicleTrips;
      // top day by weight
      const byDate = {};
      VIEW.forEach(r => {
        const d = r[COL.date];
        if (!d) return;
        byDate[d] = (byDate[d] || 0) + toNumber(r[COL.weight]);
      });
      let topDay = "-";
      if (Object.keys(byDate).length > 0) {
        topDay = Object.entries(byDate).sort((a,b)=> b[1]-a[1])[0][0];
      }
      document.getElementById("k_topDay").textContent = topDay;
      // charts data
      let weightEntries = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1]);
      let tripEntries = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1]);
      // local filters Vehicle Weight
      let vwQuery=document.getElementById("vwSearch").value.toLowerCase();
      let vwTopN=parseInt(document.getElementById("vwTopN").value||"10");
      weightEntries=weightEntries.filter(e=>e[0].toLowerCase().includes(vwQuery)).slice(0,vwTopN);
      // local filters Vehicle Trips
      let vtQuery=document.getElementById("vtSearch").value.toLowerCase();
      let vtTopN=parseInt(document.getElementById("vtTopN").value||"10");
      tripEntries=tripEntries.filter(e=>e[0].toLowerCase().includes(vtQuery)).slice(0,vtTopN);
      const labelsWeight = weightEntries.map(e=>e[0]);
      const dataWeightTon = weightEntries.map(e=> +(e[1]/1000).toFixed(2));
      const labelsTrips = tripEntries.map(e=>e[0]);
      const dataTrips = tripEntries.map(e=>e[1]);
      // update charts
      updateVehicleWeightChart(labelsWeight, dataWeightTon);
      updateVehicleTripsChart(labelsTrips, dataTrips);
      // driver analysis
      renderDriverAnalysis(byVehicleTrips, byVehicleWeight, vehicleDrivers);
      // veh analysis
      renderVehAnalysis();
      // raw trips
      updateRawTripsTable();
    }

    /* ===== Vehicle Weight Chart ===== */
    function updateVehicleWeightChart(labels, data) {
      const ctx = document.getElementById('vehicleWeightChart').getContext('2d');
      if (vehicleWeightChart) vehicleWeightChart.destroy();
      vehicleWeightChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'الوزن (طن)', data, backgroundColor: '#60a5fa' }] },
        options: { responsive: true, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', formatter: (v) => v.toFixed(2), color: '#444' } }, scales: { x: { reverse: true }, y: { beginAtZero: true } } }
      });
    }

    /* ===== Vehicle Trips Chart ===== */
    function updateVehicleTripsChart(labels, data) {
      const ctx = document.getElementById('vehicleTripsChart').getContext('2d');
      if (vehicleTripsChart) vehicleTripsChart.destroy();
      vehicleTripsChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'الرحلات', data, backgroundColor: '#34d399' }] },
        options: { responsive: true, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#444' } }, scales: { x: { reverse: true }, y: { beginAtZero: true } } }
      });
    }

    /* ===== Driver Analysis ===== */
    function renderDriverAnalysis(byVehicleTrips, byVehicleWeight, vehicleDrivers) {
      const byDriver = {};
      VIEW.forEach(r => {
        const d = String(r[COL.driver] || "بدون سائق").trim();
        const v = String(r[COL.vehicle] || "مجهولة").trim();
        if (!byDriver[d]) byDriver[d] = { trips: 0, weight: 0, vehicles: new Set() };
        byDriver[d].trips++;
        byDriver[d].weight += toNumber(r[COL.weight]);
        byDriver[d].vehicles.add(v);
      });

      let driverData = Object.entries(byDriver).map(([driver, data]) => ({
        driver: driver,
        trips: data.trips,
        weight: data.weight / 1000,
        avg: data.trips > 0 ? (data.weight / 1000) / data.trips : 0,
        vehicles: Array.from(data.vehicles)
      }));

      const driverSort = document.getElementById("driverSort").value;
      const driverTopN = parseInt(document.getElementById("driverTopN").value) || 10;
      const driverSearch = document.getElementById("driverSearch").value.toLowerCase();

      driverData = driverData.filter(d => d.driver.toLowerCase().includes(driverSearch));

      driverData.sort((a, b) => {
        if (driverSort === "weight") return b.weight - a.weight;
        if (driverSort === "trips") return b.trips - a.trips;
        if (driverSort === "avg") return b.avg - a.avg;
        return 0;
      });

      const topDrivers = driverData.slice(0, driverTopN);
      const labels = topDrivers.map(d => d.driver);
      const dataTrips = topDrivers.map(d => d.trips);
      const dataWeight = topDrivers.map(d => +d.weight.toFixed(2));
      const ctx = document.getElementById('driverChart').getContext('2d');

      if (driverChart) driverChart.destroy();
      driverChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'الوزن (طن)',
            data: dataWeight,
            backgroundColor: '#ef4444'
          }, {
            label: 'عدد الرحلات',
            data: dataTrips,
            backgroundColor: '#f97316'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            datalabels: {
              anchor: 'end',
              align: 'end',
              color: '#444',
              formatter: (v) => v
            }
          },
          scales: {
            x: {
              reverse: true,
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });

      const tbody = document.getElementById('driverTable');
      tbody.innerHTML = '';
      topDrivers.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-4 py-2">${row.driver}</td>
          <td class="px-4 py-2">${row.trips}</td>
          <td class="px-4 py-2">${row.weight.toFixed(2)}</td>
          <td class="px-4 py-2">${row.avg.toFixed(2)}</td>
          <td class="px-4 py-2">${row.vehicles.length}</td>
          <td class="px-4 py-2">${row.vehicles.join(", ")}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ===== سجل الرحلات ===== */
    const PAGINATION_STATE = {
      pageSize: 25,
      pageIndex: 1,
    }

    function renderRawTripsTable() {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      const start = (PAGINATION_STATE.pageIndex - 1) * PAGINATION_STATE.pageSize;
      const end = start + PAGINATION_STATE.pageSize;
      const paginatedData = VIEW.slice(start, end);

      paginatedData.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-4 py-2">${r[COL.month] || "-"}</td>
          <td class="px-4 py-2">${r[COL.date] || "-"}</td>
          <td class="px-4 py-2">${r[COL.driver] || "-"}</td>
          <td class="px-4 py-2">${formatTonFromKg(toNumber(r[COL.weight]))}</td>
          <td class="px-4 py-2">${r[COL.vehicle] || "-"}</td>
        `;
        tbody.appendChild(tr);
      });

      const totalPages = Math.ceil(VIEW.length / PAGINATION_STATE.pageSize);
      document.getElementById("pageIdx").textContent = PAGINATION_STATE.pageIndex;
      document.getElementById("pageTotal").textContent = totalPages;
      document.getElementById("pageIdx2").textContent = PAGINATION_STATE.pageIndex;
      document.getElementById("pageTotal2").textContent = totalPages;
      document.getElementById("prevPage").disabled = PAGINATION_STATE.pageIndex === 1;
      document.getElementById("prevPage2").disabled = PAGINATION_STATE.pageIndex === 1;
      document.getElementById("nextPage").disabled = PAGINATION_STATE.pageIndex === totalPages;
      document.getElementById("nextPage2").disabled = PAGINATION_STATE.pageIndex === totalPages;
    }

    function updateRawTripsTable() {
      PAGINATION_STATE.pageIndex = 1;
      renderRawTripsTable();
    }

    /* ===== Fetching ===== */
    async function fetchData(url) {
      const response = await fetch(url);
      const text = await response.text();
      return Papa.parse(text, { header: true, skipEmptyLines: true }).data;
    }
    
    async function loadData() {
      setLoading(true);
      try {
        ALL = await fetchData(CSV_URL);
        dataLoaded = true;
      } catch(e) { console.error("Error loading main data:", e); dataLoaded = true; }
      try {
        VEHICLES = await fetchData(VEH_URL);
        vehiclesLoaded = true;
      } catch(e) { console.error("Error loading vehicle data:", e); vehiclesLoaded = true; }
      try {
        FUEL = await fetchData(FUEL_URL);
        fuelLoaded = true;
      } catch(e) { console.error("Error loading fuel data:", e); fuelLoaded = true; }
      try {
        MAINTENANCE = await fetchData(MAINTENANCE_URL);
        maintenanceLoaded = true;
      } catch(e) { console.error("Error loading maintenance data:", e); maintenanceLoaded = true; }
      
      maybeHideOverlay();
      render();
    }

    /* ===== Render/Update All ===== */
    function render() {
      applyFilters();
      updateKPIs();
      updateTimeSeriesChart();
      // vehicle charts are handled inside updateKPIs
      // driver analysis is handled inside updateKPIs
      // veh analysis is handled inside updateKPIs
      // raw trips table is handled inside updateKPIs
    }

    /* ===== Events ===== */
    document.getElementById("q").addEventListener("input", render);
    document.getElementById("dateExact").addEventListener("change", render);
    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("q").value = "";
      document.getElementById("dateExact").value = "";
      document.getElementById("monthClearAll").click();
      document.getElementById("vehClearAll").click();
    });
    document.getElementById("refreshBtn").addEventListener("click", loadData);

    // Dynamic filtering inputs
    document.getElementById("vwSearch").addEventListener("input", render);
    document.getElementById("vwTopN").addEventListener("input", render);
    document.getElementById("vtSearch").addEventListener("input", render);
    document.getElementById("vtTopN").addEventListener("input", render);
    document.getElementById("vaSearch").addEventListener("input", renderVehAnalysis);
    document.getElementById("vaYear").addEventListener("input", renderVehAnalysis);
    document.getElementById("vaSort").addEventListener("change", renderVehAnalysis);
    document.getElementById("driverSort").addEventListener("change", render);
    document.getElementById("driverTopN").addEventListener("input", render);
    document.getElementById("driverSearch").addEventListener("input", render);
    document.getElementById("pageSize").addEventListener("change", (e) => {
      PAGINATION_STATE.pageSize = parseInt(e.target.value);
      updateRawTripsTable();
    });
    document.getElementById("prevPage").addEventListener("click", () => {
      if (PAGINATION_STATE.pageIndex > 1) {
        PAGINATION_STATE.pageIndex--;
        renderRawTripsTable();
      }
    });
    document.getElementById("nextPage").addEventListener("click", () => {
      const totalPages = Math.ceil(VIEW.length / PAGINATION_STATE.pageSize);
      if (PAGINATION_STATE.pageIndex < totalPages) {
        PAGINATION_STATE.pageIndex++;
        renderRawTripsTable();
      }
    });
    document.getElementById("prevPage2").addEventListener("click", () => document.getElementById("prevPage").click());
    document.getElementById("nextPage2").addEventListener("click", () => document.getElementById("nextPage").click());
    
    // Time series
    document.getElementById('tsAgg').addEventListener('change', updateTimeSeriesChart);
    document.getElementById('tsMetric').addEventListener('change', updateTimeSeriesChart);

    // Dropdown logic for months and vehicles
    function setupDropdowns() {
      const monthDropdownBtn = document.getElementById('monthDropdownBtn');
      const monthDropdownMenu = document.getElementById('monthDropdownMenu');
      const vehicleDropdownBtn = document.getElementById('vehicleDropdownBtn');
      const vehicleDropdownMenu = document.getElementById('vehicleDropdownMenu');

      monthDropdownBtn.addEventListener('click', () => monthDropdownMenu.classList.toggle('hidden'));
      vehicleDropdownBtn.addEventListener('click', () => vehicleDropdownMenu.classList.toggle('hidden'));
    
      document.addEventListener('click', (e) => {
        if (!monthDropdownBtn.contains(e.target) && !monthDropdownMenu.contains(e.target)) {
          monthDropdownMenu.classList.add('hidden');
        }
        if (!vehicleDropdownBtn.contains(e.target) && !vehicleDropdownMenu.contains(e.target)) {
          vehicleDropdownMenu.classList.add('hidden');
        }
      });
    }

    function populateMonthDropdown() {
      const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
      const monthsEn = ["jan", "feb", "mar", "apr", "may", "jun", "july", "aug", "sep", "oct", "nov", "dec"];
      const monthDropdownMenu = document.getElementById('monthDropdownMenu');
      monthDropdownMenu.innerHTML = '';
      months.forEach((month, idx) => {
        const label = document.createElement('label');
        label.className = "flex items-center gap-2 p-2 hover:bg-gray-100 cursor-pointer text-gray-700";
        label.innerHTML = `<input type="checkbox" value="${monthsEn[idx]}" class="form-checkbox"> ${month}`;
        monthDropdownMenu.appendChild(label);
        label.querySelector('input').addEventListener('change', () => {
          updateDropdownButtonText('monthDropdownMenu', 'monthDropdownBtn', 'الشهور');
          render();
        });
      });
    }

    function populateVehicleDropdown() {
      const vehicles = Array.from(new Set(ALL.map(r => r[COL.vehicle]).filter(Boolean))).sort();
      const vehicleDropdownMenu = document.getElementById('vehicleDropdownMenu');
      vehicleDropdownMenu.innerHTML = '';
      vehicles.forEach(vehicle => {
        const label = document.createElement('label');
        label.className = "flex items-center gap-2 p-2 hover:bg-gray-100 cursor-pointer text-gray-700";
        label.innerHTML = `<input type="checkbox" value="${vehicle}" class="form-checkbox"> ${vehicle}`;
        vehicleDropdownMenu.appendChild(label);
        label.querySelector('input').addEventListener('change', () => {
          updateDropdownButtonText('vehicleDropdownMenu', 'vehicleDropdownBtn', 'المركبات');
          render();
        });
      });
    }

    function updateDropdownButtonText(menuId, buttonId, defaultText) {
      const checkboxes = document.querySelectorAll(`#${menuId} input[type='checkbox']`);
      const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
      const button = document.getElementById(buttonId);
      if (selected.length === 0) {
        button.textContent = `اختر ${defaultText}...`;
      } else if (selected.length === checkboxes.length) {
        button.textContent = `كل ${defaultText} محددة`;
      } else {
        button.textContent = `${selected.length} ${defaultText} محددة`;
      }
    }

    /* ===== PDF Export ===== */
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4', true);
      const table = document.getElementById('rawTripsBox').querySelector('table');
      const tableRows = table.querySelectorAll('tr');

      const header = Array.from(tableRows[0].querySelectorAll('th')).map(th => th.innerText);
      const data = Array.from(tableRows).slice(1).map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.innerText));
      
      doc.addFileToVFS('Amiri-Regular.ttf', `
      AAEAAAASAQA...
      `);
      doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
      doc.setFont('Amiri');

      doc.autoTable({
        head: [header],
        body: data,
        startY: 20,
        theme: 'striped',
        styles: { font: 'Amiri', fontStyle: 'normal', halign: 'right' },
        columnStyles: { 0: { cellWidth: 'auto' }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 'auto' }, 3: { cellWidth: 'auto' }, 4: { cellWidth: 'auto' } },
        didDrawPage: function (data) {
          doc.setFont('Amiri', 'normal');
          doc.text("سجل الرحلات", data.settings.margin.left, 10);
        }
      });
      doc.save("سجل-الرحلات.pdf");
    }
    document.getElementById("btnPDF").addEventListener("click", exportPDF);

    /* ===== Excel Export ===== */
    function exportXLSX() {
      // Data
      const tripsData = VIEW.map(r => ({
        "الشهر": r[COL.month] || "",
        "تاريخ التوزين الثاني": r[COL.date] || "",
        "السائق": r[COL.driver] || "",
        "صافي التحميل (طن)": toNumber(r[COL.weight]) / 1000,
        "رقم المركبة": r[COL.vehicle] || ""
      }));
      const vehAnalysisData = Array.from(document.getElementById("vehAnalysisTable").rows).map(row => {
        const cells = Array.from(row.cells);
        return {
          "رقم المركبة": cells[0]?.innerText || "",
          "السائق": cells[1]?.innerText || "",
          "سنة التصنيع": cells[2]?.innerText || "",
          "السعة (م³)" : cells[3]?.innerText || "",
          "السعة النظرية (طن)" : cells[4]?.innerText || "",
          "عدد الرحلات": cells[5]?.innerText || "",
          "الوزن المنقول (طن)": cells[6]?.innerText || "",
          "نسبة الاستغلال %": cells[7]?.innerText || "",
          "كلفة الوقود": cells[8]?.innerText || "",
          "كلفة الصيانة": cells[9]?.innerText || "",
          "كلفة الرحلة": cells[10]?.innerText || "",
          "كلفة الطن": cells[11]?.innerText || ""
        };
      });

      // Create workbooks
      const wb = XLSX.utils.book_new();
      
      // Trips sheet
      const wsTrips = XLSX.utils.json_to_sheet(tripsData);
      XLSX.utils.book_append_sheet(wb, wsTrips, "سجل-الرحلات");

      // Vehicle Analysis sheet
      const wsVehAnalysis = XLSX.utils.json_to_sheet(vehAnalysisData);
      XLSX.utils.book_append_sheet(wb, wsVehAnalysis, "تحليل-المركبات");

      XLSX.writeFile(wb, "تقرير-النقل.xlsx");
    }
    document.getElementById("btnXLSX").addEventListener("click", exportXLSX);

    /* ===== CSV Export ===== */
    function exportCSV(filename, data) {
      const csv = Papa.unparse(data, {
        quotes: true,
        header: true,
        delimiter: ","
      });
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.click();
    }
    document.getElementById("btnCSV").addEventListener("click", () => {
      const data = VIEW.map(r => ({
        "الشهر": r[COL.month] || "",
        "تاريخ التوزين الثاني": r[COL.date] || "",
        "السائق": r[COL.driver] || "",
        "صافي التحميل (طن)": toNumber(r[COL.weight]) / 1000,
        "رقم المركبة": r[COL.vehicle] || ""
      }));
      exportCSV("سجل-الرحلات-الحالية.csv", data);
    });
    document.getElementById("btnDriversCSV").addEventListener("click", () => {
      const tbody = document.getElementById("driverTable");
      const data = Array.from(tbody.rows).map(row => {
        const cells = Array.from(row.cells);
        return {
          "السائق": cells[0]?.innerText || "",
          "عدد الرحلات": cells[1]?.innerText || "",
          "الوزن (طن)": cells[2]?.innerText || "",
          "متوسط/رحلة (طن)": cells[3]?.innerText || "",
          "عدد المركبات": cells[4]?.innerText || "",
          "المركبات": cells[5]?.innerText || ""
        };
      });
      exportCSV("تحليل-السائقين.csv", data);
    });

    /* ===== Collapsible Logic ===== */
    function setupCollapsible() {
      const headers = document.querySelectorAll('.collapsible-header');
      headers.forEach(header => {
        const content = header.nextElementSibling;
        header.addEventListener('click', () => {
          content.classList.toggle('expanded');
          header.classList.toggle('expanded');
        });
      });
    }

    /* ===== Initialization ===== */
    document.addEventListener("DOMContentLoaded", () => {
      loadData();
      setupDropdowns();
      setupCollapsible();
    });

    // Populate dropdowns only after ALL is loaded
    document.addEventListener("DataLoaded", () => {
      populateMonthDropdown();
      populateVehicleDropdown();
    });

  </script>
</body>
</html>
