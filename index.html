<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    /* تخصيص شريط تمرير بسيط */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="loadingOverlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="flex flex-col items-center gap-3">
      <div class="h-8 w-8 rounded-full border-4 border-blue-600 border-t-transparent animate-spin"></div>
      <div class="text-sm text-blue-700">جاري التحميل...</div>
    </div>
  </div>

  <header class="bg-blue-600 text-white p-6 shadow">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow p-4 mb-6 grid grid-cols-1 lg:grid-cols-7 gap-4">
      <div class="lg:col-span-2">
        <label class="block text-sm mb-1">بحث عام</label>
        <input id="q" type="text" placeholder="ابحث بتاريخ أو سائق أو رقم مركبة..." class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">الشهور (اختيار متعدد)</label>
          <div class="flex gap-2 text-xs">
            <button id="monthSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50">تحديد الكل</button>
            <button id="monthClearAll" class="px-2 py-1 rounded border hover:bg-gray-50">مسح</button>
          </div>
        </div>
        <select id="monthSelect" multiple size="6" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300"></select>
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">أرقام المركبات (اختيار متعدد)</label>
          <div class="flex gap-2 text-xs">
            <button id="vehSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50">تحديد الكل</button>
            <button id="vehClearAll" class="px-2 py-1 rounded border hover:bg-gray-50">مسح</button>
          </div>
        </div>
        <select id="vehicleSelect" multiple size="6" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300"></select>
      </div>

      <div>
        <label class="block text-sm mb-1">تاريخ محدد</label>
        <input id="dateExact" type="date" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div class="flex items-end lg:col-span-2">
        <div class="flex flex-wrap gap-2">
          <button id="resetBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">إعادة تعيين الفلاتر</button>
          <button id="refreshBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تحديث من المصدر</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-9 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الرحلات</p><h3 id="k_trips" class="text-2xl font-bold text-blue-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الوزن</p><h3 id="k_weight" class="text-2xl font-bold text-green-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">متوسط حمولة الرحلة</p><h3 id="k_avg" class="text-2xl font-bold text-purple-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد السائقين</p><h3 id="k_drivers" class="text-2xl font-bold text-orange-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (وزن)</p><h3 id="k_topVehicleWeight" class="text-xl font-bold text-red-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (رحلات)</p><h3 id="k_topVehicleTrips" class="text-xl font-bold text-indigo-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">اليوم الأعلى وزناً</p><h3 id="k_topDay" class="text-xl font-bold text-pink-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط يومي</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgDailyWeight" class="font-bold text-blue-600">0</span> طن/يوم</div>
          <div>الرحلات: <span id="k_avgDailyTrips" class="font-bold text-blue-600">0</span> رحلة/يوم</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط شهري</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgMonthlyWeight" class="font-bold text-blue-600">0</span> طن/شهر</div>
          <div>الرحلات: <span id="k_avgMonthlyTrips" class="font-bold text-blue-600">0</span> رحلة/شهر</div>
        </div>
      </div>
    </div>

    <div id="timeSeriesBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <h3 class="font-semibold">السلاسل الزمنية</h3>
        <select id="tsAgg" class="border rounded-lg px-3 py-2">
          <option value="day">تجميع يومي</option>
          <option value="month">تجميع شهري</option>
        </select>
        <select id="tsMetric" class="border rounded-lg px-3 py-2">
          <option value="weight">الوزن (طن)</option>
          <option value="trips">الرحلات</option>
        </select>
      </div>
      <canvas id="timeSeriesChart" height="120"></canvas>
      <p class="text-xs text-gray-500 mt-2">* قد تُستثنى السجلات بلا تاريخ من الرسم اليومي.</p>
    </div>

    <div id="chartWeightBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <h3 class="mb-2 font-semibold">وزن النقل حسب المركبة (بالطن)</h3>
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <label class="text-sm">بحث عن مركبة:</label>
        <input id="vwSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
        <label class="text-sm">Top N:</label>
        <input id="vwTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
      </div>
      <canvas id="vehicleWeightChart" height="120"></canvas>
    </div>

    <div id="chartTripsBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <h3 class="mb-2 font-semibold">نسبة عدد الرحلات لكل مركبة</h3>
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <label class="text-sm">بحث عن مركبة:</label>
        <input id="vtSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
        <label class="text-sm">Top N:</label>
        <input id="vtTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
      </div>
      <canvas id="vehicleTripsChart" height="120"></canvas>
    </div>

    <div id="vehAnalysisBox" class="bg-white rounded-xl shadow overflow-hidden mt-6 mb-6">
      <div class="p-4 border-b">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <label class="text-sm">بحث:</label>
          <input id="vaSearch" type="text" placeholder="ابحث..." class="border rounded-lg px-3 py-1">
          <label class="text-sm">من سنة تصنيع:</label>
          <input id="vaYear" type="number" placeholder="2000" class="w-24 border rounded-lg px-3 py-1">
          <label class="text-sm">ترتيب تنازلي حسب:</label>
          <select id="vaSort" class="border rounded-lg px-3 py-1">
            <option value="eff">نسبة الاستغلال</option>
            <option value="year">سنة التصنيع</option>
            <option value="capTon">السعة النظرية</option>
            <option value="costTrip">تكلفة الرحلة</option>
            <option value="costTon">تكلفة الطن</option>
          </select>
        </div>
        <h3 class="font-semibold">تحليل كفاءة المركبات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">رقم المركبة</th>
              <th class="px-4 py-2">سنة التصنيع</th>
              <th class="px-4 py-2">السعة (م³)</th>
              <th class="px-4 py-2">السعة النظرية (طن)</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">الوزن المنقول (طن)</th>
              <th class="px-4 py-2">نسبة الاستغلال %</th>
              <th class="px-4 py-2">تكلفة الرحلة</th>
              <th class="px-4 py-2">تكلفة الطن</th>
            </tr>
          </thead>
          <tbody id="vehAnalysisTable"></tbody>
        </table>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 mb-6">
      <button id="btnCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (الرحلات الحالية)</button>
      <button id="btnXLSX" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير Excel (رحلات + ملخص مركبات)</button>
      <button id="btnPDF" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">PDF (سجل الرحلات)</button>
      <button id="btnDriversCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (تحليل السائقين)</button>
    </div>

    <div id="driversBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <h3 class="font-semibold">تحليل السائقين</h3>
        <label class="text-sm">الترتيب</label>
        <select id="driverSort" class="border rounded-lg px-3 py-2">
          <option value="weight">حسب الوزن</option>
          <option value="trips">حسب الرحلات</option>
          <option value="avg">متوسط حمولة/رحلة</option>
        </select>
        <label class="text-sm">عدد السائقين (Top N)</label>
        <input id="driverTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-2">
        <label class="text-sm">بحث عن سائق</label>
        <input id="driverSearch" type="text" placeholder="اسم السائق" class="border rounded-lg px-3 py-2">
      </div>
      <canvas id="driverChart" height="120" class="mb-6"></canvas>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">الوزن (طن)</th>
              <th class="px-4 py-2">متوسط/رحلة (طن)</th>
              <th class="px-4 py-2">عدد المركبات</th>
              <th class="px-4 py-2">المركبات</th>
            </tr>
          </thead>
          <tbody id="driverTable"></tbody>
        </table>
      </div>
    </div>

    <div id="rawTripsBox" class="bg-white rounded-xl shadow overflow-hidden">
      <div class="p-4 border-b">
        <h3 class="font-semibold">سجل الرحلات</h3>
      </div>

      <div class="p-4 flex flex-wrap items-center gap-3">
        <label class="text-sm">عدد الصفوف في الصفحة</label>
        <select id="pageSize" class="border rounded-lg px-2 py-1">
          <option>10</option>
          <option selected>25</option>
          <option>50</option>
          <option>100</option>
        </select>

        <div class="ms-auto flex items-center gap-2">
          <button id="prevPage" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
          <span class="text-sm">صفحة <span id="pageIdx">1</span> من <span id="pageTotal">1</span></span>
          <button id="nextPage" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">الشهر</th>
              <th class="px-4 py-2">تاريخ التوزين الثاني</th>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">صافي التحميل (طن)</th>
              <th class="px-4 py-2">رقم المركبة</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="p-4 border-t flex items-center gap-2">
        <button id="prevPage2" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
        <span class="text-sm">صفحة <span id="pageIdx2">1</span> من <span id="pageTotal2">1</span></span>
        <button id="nextPage2" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
        <div class="ms-auto text-xs text-gray-500">* الترتيب الافتراضي حسب ترتيب المصدر.</div>
      </div>
    </div>
  </main>

<script>
/* ===== إعدادات الأعمدة ===== */
const COL = {
  month: "الشهر",
  date: "تاريخ التوزين الثاني",
  driver: "السائق",
  weight: "صافي التحميل",
  vehicle: "رقم المركبة"
};
/* ===== روابط الشيتات ===== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";
const VEH_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2001178330&single=true&output=csv";
/* ===== متغيرات عامة ===== */
let ALL = [];
let VIEW = [];
let VEHICLES = [];
let vehicleWeightChart = null;
let vehicleTripsChart  = null;
let timeSeriesChart    = null;
let driverChart        = null;

/* تحميل/تعطيل */
let dataLoaded = false, vehiclesLoaded = false;
const controlsSelector = 'input, select, button';
function setLoading(state) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = state ? 'flex' : 'none';
  document.querySelectorAll(controlsSelector).forEach(el => {
    if (el.id === 'refreshBtn') return; // اسمح بالتحديث دائماً
    el.disabled = state;
  });
}
function maybeHideOverlay() {
  if (dataLoaded && vehiclesLoaded) setLoading(false);
}

/* أدوات مساعدة */
function toNumber(v) {
  if (v == null) return 0;
  let s = String(v).trim();
  const arabicMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
  s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
  s = s.replace(/[^\d.]/g, "");
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}
function formatTonFromKg(kg) {
  const t = kg / 1000;
  return t.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function toYMD(dt) {
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const d = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function toYM(dt) {
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  return `${y}-${m}`;
}
function getMultiValues(sel) {
  return Array.from(sel.selectedOptions || []).map(o => String(o.value).trim()).filter(Boolean);
}

/* ===== فلترة ===== */
function applyFilters() {
  const q = document.getElementById("q").value.trim().toLowerCase();

  const mSel = document.getElementById("monthSelect");
  const vSel = document.getElementById("vehicleSelect");
  const months = getMultiValues(mSel);
  const vehicles = getMultiValues(vSel);

  const d = document.getElementById("dateExact").value;
  VIEW = ALL.filter(r => {
    const recMonth = String(r[COL.month] || "").trim();
    const recVeh   = String(r[COL.vehicle] || "").trim();
    const byMonth   = months.length ? months.includes(recMonth) : true;
    const byVehicle = vehicles.length ? vehicles.includes(recVeh) : true;

    let byDate = true;
    if (d) {
      if (!r[COL.date]) byDate = false;
      else {
        const recordDate = new Date(r[COL.date]);
        const exactDate = new Date(d);
        byDate = recordDate.toDateString() === exactDate.toDateString();
      }
    }

    if (!byMonth || !byVehicle || !byDate) return false;
    if (!q) return true;

    const hay = [r[COL.month], r[COL.date], r[COL.driver], r[COL.weight], r[COL.vehicle]]
      .map(x => (x==null?"":String(x))).join(" ").toLowerCase();
    return hay.includes(q);
  });
}

/* ===== ملخص المركبات ===== */
function updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers) {
  const vehiclesSet = new Set([...Object.keys(byVehicleTrips), ...Object.keys(byVehicleWeight)]);
  let summary = Array.from(vehiclesSet).map(v => ({
    vehicle: v,
    drivers: Array.from(vehicleDrivers[v] || []),
    trips: byVehicleTrips[v] || 0,
    weightTon: (byVehicleWeight[v] || 0) / 1000
  }));
  const vsQuery=document.getElementById("vsSearch")?.value?.toLowerCase() || "";
  const vsSort=document.getElementById("vsSort")?.value || "weight";
  if(vsQuery){
    summary=summary.filter(r=>r.vehicle.toLowerCase().includes(vsQuery)||r.drivers.join(", ").toLowerCase().includes(vsQuery));
  }
  if(vsSort==="weight"){ summary.sort((a,b)=>b.weightTon-a.weightTon);
  }
  else if(vsSort==="trips"){ summary.sort((a,b)=>b.trips-a.trips); }

  const tbody = document.getElementById("vehicleSummary");
  if (!tbody) return;
  tbody.innerHTML = "";
  summary.forEach(row => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-4 py-2">${row.vehicle}</td>
      <td class="px-4 py-2">${row.drivers.join(", ")}</td>
      <td class="px-4 py-2">${row.trips}</td>
      <td class="px-4 py-2">${row.weightTon.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===== Time Series ===== */

function computeTimeSeries(agg, metric) {
  const map = {};
  const MONTH_ORDER = ["jan","feb","mar","apr","may","jun","july","aug","sep","oct","nov","dec"];
  VIEW.forEach(r => {
    let key = null;
    if (agg === 'day') {
      if (!r[COL.date]) return;
      const dt = new Date(r[COL.date]);
      if (isNaN(dt)) return;
      key = toYMD(dt);
    } else {
      // شهري: استخدم فقط خانة الشهر
      if (!r[COL.month]) return;
      key = String(r[COL.month]).trim().toLowerCase();
      if (!MONTH_ORDER.includes(key)) return;
    }

    if (!(key in map)) map[key] = 0;
    if (metric === 'weight') map[key] += toNumber(r[COL.weight]) / 1000;
    else map[key] += 1;
  });
  let labels = Object.keys(map);
  if (labels.length === 0) return { labels: [], values: [] };
  if (agg === 'day') {
    labels.sort((a,b)=> new Date(a) - new Date(b));
  } else {
    labels.sort((a,b)=> MONTH_ORDER.indexOf(a) - MONTH_ORDER.indexOf(b));
  }

  const values = labels.map(k => +map[k].toFixed(2));
  return { labels, values };
}

function updateTimeSeriesChart() {
  const agg = document.getElementById('tsAgg').value;
  const metric = document.getElementById('tsMetric').value;
  const {labels, values} = computeTimeSeries(agg, metric);
  const ctx = document.getElementById('timeSeriesChart').getContext('2d');
  if (timeSeriesChart) timeSeriesChart.destroy();
  timeSeriesChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: metric === 'weight' ? 'الوزن (طن)' : 'عدد الرحلات', data: values, fill: false, borderColor: metric === 'weight' ? '#3b82f6' : '#10b981', tension: 0.2, pointRadius: 3 }]},
    options: { responsive: true, plugins: { legend: { display: false } },
      scales: { x: { title: { display: true, text: agg === 'day' ? 'اليوم' : 'الشهر' } }, y: { title: { display: true, text: metric === 'weight' ? 'طن' : 'رحلة' }, beginAtZero: true } } }
  });
}

/* ===== KPI + Charts ===== */
function updateKPIs() {
  const trips = VIEW.length;
  const totalWkg = VIEW.reduce((s,r)=> s + toNumber(r[COL.weight]), 0);
  const avgWkg = trips ? (totalWkg / trips) : 0;
  const drivers = new Set(VIEW.map(r => r[COL.driver]).filter(Boolean));

  document.getElementById("k_trips").textContent  = trips.toLocaleString();
  document.getElementById("k_weight").textContent = formatTonFromKg(totalWkg) + " طن";
  document.getElementById("k_avg").textContent    = formatTonFromKg(avgWkg) + " طن";
  document.getElementById("k_drivers").textContent= drivers.size.toLocaleString();

  const uniqueDays = new Set(VIEW.map(r => r[COL.date]).filter(Boolean));
  const daysCount = uniqueDays.size;
  const avgDailyWeight = daysCount ? (totalWkg/1000) / daysCount : 0;
  const avgDailyTrips = daysCount ? trips / daysCount : 0;

  const monthKeys = new Set();
  VIEW.forEach(r => {
    let key = null;
    if (r[COL.date]) {
      const dt = new Date(r[COL.date]);
      if (!isNaN(dt)) key = toYM(dt);
    }
    if (!key && r[COL.month]) key = String(r[COL.month]).trim();
    if (key) monthKeys.add(key);
  });
  const monthsCount = monthKeys.size;
  const avgMonthlyWeight = monthsCount ? (totalWkg/1000) / monthsCount : 0;
  const avgMonthlyTrips = monthsCount ? trips / monthsCount : 0;

  document.getElementById("k_avgDailyWeight").textContent = avgDailyWeight.toFixed(2);
  document.getElementById("k_avgDailyTrips").textContent  = avgDailyTrips.toFixed(1);
  document.getElementById("k_avgMonthlyWeight").textContent = avgMonthlyWeight.toFixed(2);
  document.getElementById("k_avgMonthlyTrips").textContent  = avgMonthlyTrips.toFixed(1);
  // per vehicle aggregates
  const byVehicleWeight = {};
  const byVehicleTrips  = {};
  const vehicleDrivers  = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle] || "مجهولة";
    const d = r[COL.driver] || "بدون سائق";
    byVehicleWeight[v] = (byVehicleWeight[v] || 0) + toNumber(r[COL.weight]);
    byVehicleTrips[v]  = (byVehicleTrips[v]  || 0) + 1;
    if (!vehicleDrivers[v]) vehicleDrivers[v] = new Set();
    vehicleDrivers[v].add(d);
  });
  // vehicle summary table (if present in DOM)
  updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers);

  // tops
  let topVehicleWeight = "-";
  if (Object.keys(byVehicleWeight).length > 0) {
    topVehicleWeight = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topVehicleWeight").textContent = topVehicleWeight;
  let topVehicleTrips = "-";
  if (Object.keys(byVehicleTrips).length > 0) {
    topVehicleTrips = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topVehicleTrips").textContent = topVehicleTrips;

  // top day by weight
  const byDate = {};
  VIEW.forEach(r => {
    const d = r[COL.date];
    if (!d) return;
    byDate[d] = (byDate[d] || 0) + toNumber(r[COL.weight]);
  });
  let topDay = "-";
  if (Object.keys(byDate).length > 0) {
    topDay = Object.entries(byDate).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topDay").textContent = topDay;

  // charts data
  let weightEntries = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1]);
  let tripEntries   = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1]);

  // local filters Vehicle Weight
  let vwQuery=document.getElementById("vwSearch").value.toLowerCase();
  let vwTopN=parseInt(document.getElementById("vwTopN").value||"10");
  weightEntries=weightEntries.filter(e=>e[0].toLowerCase().includes(vwQuery)).slice(0,vwTopN);
  // local filters Vehicle Trips
  let vtQuery=document.getElementById("vtSearch").value.toLowerCase();
  let vtTopN=parseInt(document.getElementById("vtTopN").value||"10");
  tripEntries=tripEntries.filter(e=>e[0].toLowerCase().includes(vtQuery)).slice(0,vtTopN);

  const labelsWeight = weightEntries.map(e=>e[0]);
  const dataWeightTon = weightEntries.map(e=> (e[1]/1000).toFixed(2));
  const labelsTrips = tripEntries.map(e=>{
    const v = e[0];
    const drivers = Array.from(vehicleDrivers[v]||[]).join(", ");
    return v + " – " + drivers;
  });
  const dataTrips = tripEntries.map(e=> e[1]);

  // toggle chart visibility
  document.getElementById("chartWeightBox").style.display = labelsWeight.length > 1 ? "block" : "none";
  document.getElementById("chartTripsBox").style.display  = labelsTrips.length  > 1 ? "block" : "none";
  // bar chart
  if (labelsWeight.length > 1) {
    if (vehicleWeightChart) vehicleWeightChart.destroy();
    const ctx1 = document.getElementById("vehicleWeightChart").getContext("2d");
    vehicleWeightChart = new Chart(ctx1, {
      type: 'bar',
      data: { labels: labelsWeight, datasets: [{ label: "الوزن الكلي (طن)", data: dataWeightTon, backgroundColor: "rgba(59,130,246,0.7)" }]},
      options: { responsive: true, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx)=> ` ${ctx.parsed.y} طن` }}}, scales: { x: { title: { display: true, text: "المركبة" } }, y: { title: { display: true, text: "الوزن (طن)" } } } }
    });
  }

  // pie chart
  if (labelsTrips.length > 1) {
    if (vehicleTripsChart) vehicleTripsChart.destroy();
    const ctx2 = document.getElementById("vehicleTripsChart").getContext("2d");
    vehicleTripsChart = new Chart(ctx2, {
      type: 'pie',
      data: { labels: labelsTrips, datasets: [{ label: "عدد الرحلات", data: dataTrips, backgroundColor: ["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#84cc16","#d946ef","#fb7185","#22c55e","#a78bfa"] }]},
      options: { responsive: true, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: (ctx) => {
        const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
        const v = ctx.parsed;
        const pct = total ? (v*100/total).toFixed(1) : 0;
        return ` ${ctx.label}: ${v} رحلة (${pct}%)`;
      }}}, datalabels: { color: '#fff', formatter: (value, ctx) => {
        const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
        const percentage = sum ? (value * 100 / sum).toFixed(1) + "%" : "0%";
        return percentage;
      }}}}
    });
  }

  // time series + drivers
  updateTimeSeriesChart();
  updateDriverViews();
}

/* ===== سجل الرحلات + ترقيم الصفحات ===== */
let currentPage = 1;
let pageSize = 25;
function updatePaginationControls(totalPages) {
  document.getElementById("pageIdx").textContent = String(currentPage);
  document.getElementById("pageTotal").textContent = String(totalPages);
  document.getElementById("pageIdx2").textContent = String(currentPage);
  document.getElementById("pageTotal2").textContent = String(totalPages);
}
function updateTable() {
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";
  const totalRows = VIEW.length;
  const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * pageSize;
  const end = Math.min(start + pageSize, totalRows);
  const rows = VIEW.slice(start, end);
  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-4 py-2">${r[COL.month] || ""}</td>
      <td class="px-4 py-2">${r[COL.date] || ""}</td>
      <td class="px-4 py-2">${r[COL.driver] || ""}</td>
      <td class="px-4 py-2">${formatTonFromKg(toNumber(r[COL.weight]))}</td>
      <td class="px-4 py-2">${r[COL.vehicle] || ""}</td>
    `;
    tb.appendChild(tr);
  });
  updatePaginationControls(totalPages);
}
/* ===== تحليل السائقين ===== */
function getDriverAggregates() {
  const map = {};
  // driver -> { trips, weightTon, vehicles: Set }
  VIEW.forEach(r => {
    const d = r[COL.driver] || 'بدون سائق';
    const v = r[COL.vehicle] || 'مجهولة';
    const w = toNumber(r[COL.weight]) / 1000;
    if (!map[d]) map[d] = { trips: 0, weightTon: 0, vehicles: new Set() };
    map[d].trips += 1;
    map[d].weightTon += w;
    map[d].vehicles.add(v);
  });
  let rows = Object.entries(map).map(([driver, obj]) => ({ driver, trips: obj.trips, weightTon: +obj.weightTon.toFixed(2), avgTon: obj.trips ? +(obj.weightTon / obj.trips).toFixed(2) : 0, vehCount: obj.vehicles.size, vehList: Array.from(obj.vehicles).join(', ') }));
  const q = document.getElementById('driverSearch').value.toLowerCase();
  if (q) rows = rows.filter(r => r.driver.toLowerCase().includes(q));
  const sortBy = document.getElementById('driverSort').value;
  if (sortBy === 'weight') rows.sort((a,b)=> b.weightTon - a.weightTon);
  else if (sortBy === 'trips') rows.sort((a,b)=> b.trips - a.trips);
  else rows.sort((a,b)=> b.avgTon - a.avgTon);
  const topN = Math.max(1, parseInt(document.getElementById('driverTopN').value || '10', 10));
  return rows.slice(0, topN);
}
function updateDriverChart() {
  const rows = getDriverAggregates();
  const labels = rows.map(r => r.driver);
  const dataTrips = rows.map(r => r.trips);
  const dataWeight = rows.map(r => r.weightTon);
  const ctx = document.getElementById('driverChart').getContext('2d');
  if (driverChart) driverChart.destroy();
  driverChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [ { label: 'رحلات', data: dataTrips, backgroundColor: '#f59e0b', yAxisID: 'y' }, { label: 'وزن (طن)', data: dataWeight, backgroundColor: '#3b82f6', yAxisID: 'y1' } ] },
    options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { position: 'left', title: {display:true, text:'رحلات'}, beginAtZero: true }, y1: { position: 'right', title: {display:true, text:'طن'}, beginAtZero: true, grid: { drawOnChartArea: false } } } }
  });
}
function updateDriverTable() {
  const rows = getDriverAggregates();
  const tb = document.getElementById('driverTable');
  tb.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.className = 'border-b hover:bg-gray-50';
    tr.innerHTML = `
      <td class="px-4 py-2">${r.driver}</td>
      <td class="px-4 py-2">${r.trips}</td>
      <td class="px-4 py-2">${r.weightTon.toFixed(2)}</td>
      <td class="px-4 py-2">${r.avgTon.toFixed(2)}</td>
      <td class="px-4 py-2">${r.vehCount}</td>
      <td class="px-4 py-2">${r.vehList}</td>
    `;
    tb.appendChild(tr);
  });
}
function updateDriverViews() {
  updateDriverChart();
  updateDriverTable();
}
/* ===== تحميل الشيتات ===== */
async function loadVehSheet(){
  try{
    const result=await new Promise((resolve,reject)=>{
      Papa.parse(VEH_URL,{download:true,header:true,skipEmptyLines:true,complete:resolve,error:reject});
    });
    VEHICLES=result.data;
    vehiclesLoaded = true;
    maybeHideOverlay();
    renderVehAnalysis();
  }catch(e){
    console.error("خطأ تحميل شيت المركبات:",e);
    vehiclesLoaded = true; // لا توقف الواجهة
    maybeHideOverlay();
  }
}
async function loadData() {
  try {
    const result = await new Promise((resolve, reject) => {
      Papa.parse(CSV_URL, { download: true, header: true, skipEmptyLines: true, complete: resolve, error: reject });
    });
    ALL = result.data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => {
        const kk = (k || "").trim();
        obj[kk] = (row[k] == null ? "" : String(row[k]).trim());
      });
      return obj;
    });
    dataLoaded = true;
    maybeHideOverlay();
    fillMonthSelect();
    fillVehicleSelect();
    currentPage = 1; // reset pagination
    render();
  } catch (e) {
    console.error("خطأ في جلب/قراءة الشيت:", e);
    dataLoaded = true;
    maybeHideOverlay();
    alert("تعذر تحميل البيانات من الشيت.");
  }
}
/* ===== تعبئة القوائم المتعددة ===== */
function fillMonthSelect() {
  const sel = document.getElementById("monthSelect");
  sel.innerHTML = "";
  const months = Array.from(new Set(ALL.map(r => r[COL.month]).filter(Boolean)));
  months.forEach(m => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = m;
    sel.appendChild(opt);
  });
}
function fillVehicleSelect() {
  const sel = document.getElementById("vehicleSelect");
  sel.innerHTML = "";
  const vehicles = Array.from(new Set(ALL.map(r => r[COL.vehicle]).filter(Boolean)));
  vehicles.forEach(v => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = v;
    sel.appendChild(opt);
  });
}
/* ===== تحليل كفاءة المركبات (من شيت المركبات) ===== */
function renderVehAnalysis(){
  const tb=document.getElementById("vehAnalysisTable");
  if(!tb) return;
  tb.innerHTML="";
  
  const vaSort=document.getElementById("vaSort")?.value || "eff";
  const vaYear=parseInt(document.getElementById("vaYear")?.value || "0");
  const vaSearch=document.getElementById("vaSearch")?.value?.toLowerCase() || "";

  // Group trips by vehicle from VIEW data
  const vehicleAggregates = {};
  VIEW.forEach(t => {
    const vehId = t[COL.vehicle];
    if (vehId) {
      if (!vehicleAggregates[vehId]) {
        vehicleAggregates[vehId] = { trips: 0, weightTon: 0 };
      }
      vehicleAggregates[vehId].trips += 1;
      vehicleAggregates[vehId].weightTon += toNumber(t[COL.weight]) / 1000;
    }
  });

  // Calculate costs (assumptions from previous steps)
  const fuelPricePerLiter = 0.94; // دينار أردني
  const maintenanceCostPerKm = 0.15; // دينار أردني
  
  // This is a placeholder; needs to be a real value from data
  // Let's assume a fixed average distance per trip for now, as we don't have it
  // Assume a fixed average distance for the purpose of the cost calculation.
  const averageKmPerTrip = 10;
  const fuelConsumptionLitersPer100Km = 30; // 30 لتر لكل 100 كم
  const vehicleDistance = (vehicleId) => (vehicleAggregates[vehicleId]?.trips || 0) * averageKmPerTrip;

  let analysis = VEHICLES.map(v => {
    const trips = vehicleAggregates[v['رقم المركبة']]?.trips || 0;
    const weightTon = vehicleAggregates[v['رقم المركبة']]?.weightTon || 0;
    const eff = v['السعة النظرية'] ? (weightTon / toNumber(v['السعة النظرية']) / trips) * 100 : 0;
    const dist = vehicleDistance(v['رقم المركبة']);
    const fuelCost = (dist / 100) * fuelConsumptionLitersPer100Km * fuelPricePerLiter;
    const maintenanceCost = dist * maintenanceCostPerKm;
    const totalCost = fuelCost + maintenanceCost;
    const costPerTrip = trips ? totalCost / trips : 0;
    const costPerTon = weightTon ? totalCost / weightTon : 0;
    
    return {
      vehicle: v['رقم المركبة'],
      year: toNumber(v['سنة الصنع']),
      capacityM3: toNumber(v['السعة (م³)']),
      capacityTon: toNumber(v['السعة النظرية']),
      trips: trips,
      weightTon: weightTon,
      efficiency: eff,
      costPerTrip: costPerTrip,
      costPerTon: costPerTon
    };
  });
  
  // Filter and sort
  if(vaYear>0){ analysis=analysis.filter(r=>r.year>=vaYear); }
  if(vaSearch){
    analysis=analysis.filter(r=>r.vehicle.toLowerCase().includes(vaSearch));
  }
  if(vaSort==="eff"){ analysis.sort((a,b)=>b.efficiency - a.efficiency); }
  else if(vaSort==="year"){ analysis.sort((a,b)=>b.year - a.year); }
  else if(vaSort==="capTon"){ analysis.sort((a,b)=>b.capacityTon - a.capacityTon); }
  else if(vaSort==="costTrip"){ analysis.sort((a,b)=>b.costPerTrip - a.costPerTrip); }
  else if(vaSort==="costTon"){ analysis.sort((a,b)=>b.costPerTon - a.costPerTon); }
  
  analysis.forEach(row => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-4 py-2">${row.vehicle}</td>
      <td class="px-4 py-2">${row.year}</td>
      <td class="px-4 py-2">${row.capacityM3}</td>
      <td class="px-4 py-2">${row.capacityTon}</td>
      <td class="px-4 py-2">${row.trips}</td>
      <td class="px-4 py-2">${row.weightTon.toFixed(2)}</td>
      <td class="px-4 py-2">${row.efficiency.toFixed(2)}</td>
      <td class="px-4 py-2">${row.costPerTrip.toFixed(2)}</td>
      <td class="px-4 py-2">${row.costPerTon.toFixed(2)}</td>
    `;
    tb.appendChild(tr);
  });
}
/* ===== تصدير CSV (تحليل المركبات) ===== */
function exportVehAnalysisToCSV(){
  let analysis = VEHICLES.map(v => {
    const trips = vehicleAggregates[v['رقم المركبة']]?.trips || 0;
    const weightTon = vehicleAggregates[v['رقم المركبة']]?.weightTon || 0;
    const eff = v['السعة النظرية'] ? (weightTon / toNumber(v['السعة النظرية']) / trips) * 100 : 0;
    return {
      'رقم المركبة': v['رقم المركبة'],
      'سنة التصنيع': toNumber(v['سنة الصنع']),
      'السعة (م³)' : toNumber(v['السعة (م³)']),
      'السعة النظرية (طن)': toNumber(v['السعة النظرية']),
      'عدد الرحلات': trips,
      'الوزن المنقول (طن)': weightTon,
      'نسبة الاستغلال %': eff.toFixed(2),
      'تكلفة الرحلة': (trips ? totalCost / trips : 0).toFixed(2),
      'تكلفة الطن': (weightTon ? totalCost / weightTon : 0).toFixed(2),
    };
  });
  const headers = Object.keys(analysis[0]).join(',');
  const csv = [
    headers,
    ...analysis.map(row => Object.values(row).map(v=>`"${v}"`).join(','))
  ].join('\n');
  const blob = new Blob(["\uFEFF"+csv], {type: "text/csv;charset=utf-8"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "تحليل_المركبات.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
/* ===== تصدير CSV (سجل الرحلات) ===== */
function exportAllToCSV(){
  const headers = Object.keys(ALL[0]).join(',');
  const csv = [
    headers,
    ...ALL.map(row => Object.values(row).map(v=>`"${v}"`).join(','))
  ].join('\n');
  const blob = new Blob(["\uFEFF"+csv], {type: "text/csv;charset=utf-8"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "سجل_الرحلات.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
/* ===== تصدير Excel ===== */
function exportToXLSX() {
  const ws1 = XLSX.utils.json_to_sheet(ALL);
  const vehData = VEHICLES.map(v => {
    const trips = vehicleAggregates[v['رقم المركبة']]?.trips || 0;
    const weightTon = vehicleAggregates[v['رقم المركبة']]?.weightTon || 0;
    const eff = v['السعة النظرية'] ? (weightTon / toNumber(v['السعة النظرية']) / trips) * 100 : 0;
    return {
      'رقم المركبة': v['رقم المركبة'],
      'سنة التصنيع': toNumber(v['سنة الصنع']),
      'السعة (م³)' : toNumber(v['السعة (م³)']),
      'السعة النظرية (طن)': toNumber(v['السعة النظرية']),
      'عدد الرحلات': trips,
      'الوزن المنقول (طن)': weightTon,
      'نسبة الاستغلال %': eff.toFixed(2)
    };
  });
  const ws2 = XLSX.utils.json_to_sheet(vehData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws1, "سجل الرحلات");
  XLSX.utils.book_append_sheet(wb, ws2, "ملخص المركبات");
  XLSX.writeFile(wb, "تقرير_بيانات_النقل.xlsx");
}

/* ===== تصدير PDF ===== */
async function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ format: 'a4', unit: 'pt', orientation: 'landscape' });
  const margin = 20;
  const element = document.getElementById('rawTripsBox');
  doc.html(element, {
    callback: function (doc) {
      doc.save('سجل_الرحلات.pdf');
    },
    x: margin,
    y: margin,
    width: 842 - (margin * 2), // A4 landscape width - margins
    windowWidth: element.scrollWidth,
  });
}

/* ===== تصدير CSV (تحليل السائقين) ===== */
function exportDriverAnalysisToCSV() {
  const rows = getDriverAggregates();
  const headers = ['السائق', 'عدد الرحلات', 'الوزن (طن)', 'متوسط/رحلة (طن)', 'عدد المركبات', 'المركبات'].join(',');
  const csv = [
    headers,
    ...rows.map(r => `${r.driver},${r.trips},${r.weightTon.toFixed(2)},${r.avgTon.toFixed(2)},${r.vehCount},"${r.vehList}"`).join('\n')
  ].join('\n');
  const blob = new Blob(["\uFEFF"+csv], {type: "text/csv;charset=utf-8"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "تحليل_السائقين.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
/* ===== ربط الأحداث ===== */
document.getElementById('q').addEventListener('input', render);
document.getElementById('monthSelect').addEventListener('change', render);
document.getElementById('vehSelect').addEventListener('change', render);
document.getElementById('dateExact').addEventListener('change', render);
document.getElementById('resetBtn').addEventListener('click', () => {
  document.getElementById('q').value = '';
  document.getElementById('dateExact').value = '';
  document.getElementById('monthSelect').selectedIndex = -1;
  document.getElementById('vehicleSelect').selectedIndex = -1;
  render();
});
document.getElementById('refreshBtn').addEventListener('click', () => {
  setLoading(true);
  loadData();
  loadVehSheet();
});

document.getElementById('monthSelectAll').addEventListener('click', ()=>{
  document.querySelectorAll('#monthSelect option').forEach(opt=>opt.selected=true);
  render();
});
document.getElementById('monthClearAll').addEventListener('click', ()=>{
  document.querySelectorAll('#monthSelect option').forEach(opt=>opt.selected=false);
  render();
});
document.getElementById('vehSelectAll').addEventListener('click', ()=>{
  document.querySelectorAll('#vehicleSelect option').forEach(opt=>opt.selected=true);
  render();
});
document.getElementById('vehClearAll').addEventListener('click', ()=>{
  document.querySelectorAll('#vehicleSelect option').forEach(opt=>opt.selected=false);
  render();
});

// veh analysis
document.getElementById('vaSearch').addEventListener('input', renderVehAnalysis);
document.getElementById('vaYear').addEventListener('input', renderVehAnalysis);
document.getElementById('vaSort').addEventListener('change', renderVehAnalysis);
// charts
document.getElementById('vwSearch').addEventListener('input', updateKPIs);
document.getElementById('vwTopN').addEventListener('input', updateKPIs);
document.getElementById('vtSearch').addEventListener('input', updateKPIs);
document.getElementById('vtTopN').addEventListener('input', updateKPIs);
document.getElementById('tsAgg').addEventListener('change', updateTimeSeriesChart);
document.getElementById('tsMetric').addEventListener('change', updateTimeSeriesChart);
// export
document.getElementById('btnCSV').addEventListener('click', exportAllToCSV);
document.getElementById('btnXLSX').addEventListener('click', exportToXLSX);
document.getElementById('btnPDF').addEventListener('click', exportToPDF);
document.getElementById('btnDriversCSV').addEventListener('click', exportDriverAnalysisToCSV);
// تحليل السائقين
document.getElementById('driverSort').addEventListener('change', updateDriverViews);
document.getElementById('driverTopN').addEventListener('input', updateDriverViews);
document.getElementById('driverSearch').addEventListener('input', updateDriverViews);
// ترقيم الصفحات
document.getElementById('prevPage').addEventListener('click', ()=>{ if (currentPage>1){ currentPage--; updateTable(); } });
document.getElementById('nextPage').addEventListener('click', ()=>{ const totalPages=Math.max(1, Math.ceil(VIEW.length / pageSize)); if (currentPage<totalPages){ currentPage++; updateTable(); } });
document.getElementById('prevPage2').addEventListener('click', ()=>{ if (currentPage>1){ currentPage--; updateTable(); } });
document.getElementById('nextPage2').addEventListener('click', ()=>{ const totalPages=Math.max(1, Math.ceil(VIEW.length / pageSize)); if (currentPage<totalPages){ currentPage++; updateTable(); } });
document.getElementById('pageSize').addEventListener('change', (e)=>{ pageSize=parseInt(e.target.value||'25',10); currentPage=1; updateTable(); });

/* ===== Render شامل ===== */
function render() {
  applyFilters();
  updateKPIs();
  updateTable();
  renderVehAnalysis();
}

/* تسجيل بلجن الداتا ليبلز */
if (window.ChartDataLabels) { Chart.register(ChartDataLabels); }

/* ===== Start ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  setLoading(true);
  loadData();
  loadVehSheet();
});
</script>
</body>
</html>
