<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ููุญุฉ ุจูุงูุงุช ุงูููู</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- DataLabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-blue-600 text-white p-6 shadow">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">ูุธุงู ุฅุฏุงุฑุฉ ุจูุงูุงุช ุงูููู</h1>
      <p class="text-blue-100">ุจูุฏูุฉ ูุคุชุฉ ูุงููุฒุงุฑ</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <!-- Filters -->
    <div class="bg-white rounded-xl shadow p-4 mb-6 grid grid-cols-1 md:grid-cols-5 gap-4">
      <div>
        <label class="block text-sm mb-1">ุจุญุซ ุนุงู</label>
        <input id="q" type="text" placeholder="ุงุจุญุซ ุจุชุงุฑูุฎ ุฃู ุณุงุฆู ุฃู ุฑูู ูุฑูุจุฉ..."
               class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>
      <div>
        <label class="block text-sm mb-1">ุงูุดูุฑ</label>
        <select id="monthSelect" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <option value="">ุงููู</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">ุฑูู ุงููุฑูุจุฉ</label>
        <select id="vehicleSelect" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <option value="">ุงููู</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">ุงูุชุงุฑูุฎ</label>
        <input id="dateExact" type="date"
               class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>
      <div class="flex items-end">
        <button id="resetBtn" class="w-full md:w-auto bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">
          ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุชุฑ
        </button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-7 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">ุฅุฌูุงูู ุงูุฑุญูุงุช</p>
        <h3 id="k_trips" class="text-2xl font-bold text-blue-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">ุฅุฌูุงูู ุงููุฒู</p>
        <h3 id="k_weight" class="text-2xl font-bold text-green-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">ูุชูุณุท ุญูููุฉ ุงูุฑุญูุฉ</p>
        <h3 id="k_avg" class="text-2xl font-bold text-purple-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">ุนุฏุฏ ุงูุณุงุฆููู</p>
        <h3 id="k_drivers" class="text-2xl font-bold text-orange-600">0</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">ุฃูุซุฑ ูุฑูุจุฉ (ูุฒู)</p>
        <h3 id="k_topVehicleWeight" class="text-xl font-bold text-red-600">-</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">ุฃูุซุฑ ูุฑูุจุฉ (ุฑุญูุงุช)</p>
        <h3 id="k_topVehicleTrips" class="text-xl font-bold text-indigo-600">-</h3>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">ุงูููู ุงูุฃุนูู ูุฒูุงู</p>
        <h3 id="k_topDay" class="text-xl font-bold text-pink-600">-</h3>
      </div>
    </div>

    <!-- Chart: ุงููุฒู -->
    <div id="chartWeightBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <h3 class="mb-4 font-semibold">ูุฒู ุงูููู ุญุณุจ ุงููุฑูุจุฉ (ุจุงูุทู)</h3>
      <canvas id="vehicleWeightChart" height="120"></canvas>
    </div>

    <!-- Chart: ุงูุฑุญูุงุช -->
    <div id="chartTripsBox" class="bg-white rounded-xl shadow p-6 mb-6">
      <h3 class="mb-4 font-semibold">ูุณุจุฉ ุนุฏุฏ ุงูุฑุญูุงุช ููู ูุฑูุจุฉ</h3>
      <canvas id="vehicleTripsChart" height="120"></canvas>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-xl shadow overflow-hidden">
      <div class="p-4 border-b">
        <h3 class="font-semibold">ุณุฌู ุงูุฑุญูุงุช</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">ุงูุดูุฑ</th>
              <th class="px-4 py-2">ุชุงุฑูุฎ ุงูุชูุฒูู ุงูุซุงูู</th>
              <th class="px-4 py-2">ุงูุณุงุฆู</th>
              <th class="px-4 py-2">ุตุงูู ุงูุชุญููู (ุทู)</th>
              <th class="px-4 py-2">ุฑูู ุงููุฑูุจุฉ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="emptyState" class="p-6 text-center text-gray-500 hidden">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุทุงุจูุฉ.</div>
    </div>
  </main>

<script>
const COL = {
  month: "ุงูุดูุฑ",
  date: "ุชุงุฑูุฎ ุงูุชูุฒูู ุงูุซุงูู",
  driver: "ุงูุณุงุฆู",
  weight: "ุตุงูู ุงูุชุญููู",
  vehicle: "ุฑูู ุงููุฑูุจุฉ"
};

const CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";

let ALL = [];
let VIEW = [];
let vehicleWeightChart = null;
let vehicleTripsChart = null;

function toNumber(v) {
  if (v == null) return 0;
  let s = String(v).trim();
  const arabicMap = {'ู':'0','ูก':'1','ูข':'2','ูฃ':'3','ูค':'4','ูฅ':'5','ูฆ':'6','ูง':'7','ูจ':'8','ูฉ':'9'};
  s = s.replace(/[ู-ูฉ]/g, d => arabicMap[d] || d);
  s = s.replace(/[^\d.]/g, "");
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

function applyFilters() {
  const q = document.getElementById("q").value.trim();
  const m = document.getElementById("monthSelect").value;
  const v = document.getElementById("vehicleSelect").value;
  const d = document.getElementById("dateExact").value;

  VIEW = ALL.filter(r => {
    const byMonth   = m ? (String(r[COL.month] || "").trim() === m) : true;
    const byVehicle = v ? (String(r[COL.vehicle] || "").trim() === v) : true;

    let byDate = true;
    if (d) {
      if (!r[COL.date]) {
        byDate = false;
      } else {
        const recordDate = new Date(r[COL.date]);
        const exactDate  = new Date(d);
        byDate = recordDate.toDateString() === exactDate.toDateString();
      }
    }

    if (!byMonth || !byVehicle || !byDate) return false;

    if (!q) return true;
    const hay = [r[COL.month], r[COL.date], r[COL.driver], r[COL.weight], r[COL.vehicle]]
      .map(x => (x==null?"":String(x))).join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  });
}

function updateKPIs() {
  const trips = VIEW.length;
  const totalW = VIEW.reduce((s,r)=> s + toNumber(r[COL.weight]), 0);
  const avgW = trips ? Math.round(totalW / trips) : 0;
  const drivers = new Set(VIEW.map(r => r[COL.driver]).filter(Boolean));

  document.getElementById("k_trips").textContent  = trips.toLocaleString();
  document.getElementById("k_weight").textContent = (totalW/1000).toFixed(2).toLocaleString() + " ุทู";
  document.getElementById("k_avg").textContent    = (avgW/1000).toFixed(2).toLocaleString() + " ุทู";
  document.getElementById("k_drivers").textContent= drivers.size.toLocaleString();

  // ๐น ุฃูุซุฑ ูุฑูุจุฉ ูุฒู
  const byVehicleWeight = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle];
    if (!v) return;
    byVehicleWeight[v] = (byVehicleWeight[v] || 0) + toNumber(r[COL.weight]);
  });

  let topVehicleWeight = "-";
  if (Object.keys(byVehicleWeight).length > 0) {
    topVehicleWeight = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topVehicleWeight").textContent = topVehicleWeight;

  // ๐น ุฃูุซุฑ ูุฑูุจุฉ ุฑุญูุงุช
  const byVehicleTrips = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle];
    if (!v) return;
    byVehicleTrips[v] = (byVehicleTrips[v] || 0) + 1;
  });

  let topVehicleTrips = "-";
  if (Object.keys(byVehicleTrips).length > 0) {
    topVehicleTrips = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topVehicleTrips").textContent = topVehicleTrips;

  // ๐น ุงูููู ุงูุฃุนูู ูุฒูุงู
  const byDate = {};
  VIEW.forEach(r => {
    const d = r[COL.date];
    if (!d) return;
    byDate[d] = (byDate[d] || 0) + toNumber(r[COL.weight]);
  });

  let topDay = "-";
  if (Object.keys(byDate).length > 0) {
    topDay = Object.entries(byDate).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topDay").textContent = topDay;

  // ๐น ุจูุงูุงุช ุงูุดุงุฑุชุงุช
  const labelsWeight = Object.keys(byVehicleWeight);
  const dataWeight = Object.values(byVehicleWeight).map(v => (v/1000).toFixed(2));

  const labelsTrips = Object.keys(byVehicleTrips);
  const dataTrips = Object.values(byVehicleTrips);

  // ุฅุธูุงุฑ/ุฅุฎูุงุก ุงูุดุงุฑุชุงุช
  document.getElementById("chartWeightBox").style.display = labelsWeight.length > 1 ? "block" : "none";
  document.getElementById("chartTripsBox").style.display = labelsTrips.length > 1 ? "block" : "none";

  // ๐น Bar Chart (ูุฒู)
  if (labelsWeight.length > 1) {
    if (vehicleWeightChart) vehicleWeightChart.destroy();
    const ctx1 = document.getElementById("vehicleWeightChart").getContext("2d");
    vehicleWeightChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: labelsWeight,
        datasets: [{
          label: "ุงููุฒู ุงูููู (ุทู)",
          data: dataWeight,
          backgroundColor: "rgba(59,130,246,0.7)"
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { title: { display: true, text: "ุงููุฑูุจุฉ" } },
          y: { title: { display: true, text: "ุงููุฒู (ุทู)" } }
        }
      }
    });
  }

  // ๐น Pie Chart (ุฑุญูุงุช ูุน ูุณุจ ูุฆููุฉ)
  if (labelsTrips.length > 1) {
    if (vehicleTripsChart) vehicleTripsChart.destroy();
    const ctx2 = document.getElementById("vehicleTripsChart").getContext("2d");
    vehicleTripsChart = new Chart(ctx2, {
      type: 'pie',
      data: {
        labels: labelsTrips,
        datasets: [{
          label: "ุนุฏุฏ ุงูุฑุญูุงุช",
          data: dataTrips,
          backgroundColor: [
            "#3b82f6","#10b981","#f59e0b","#ef4444",
            "#8b5cf6","#06b6d4","#84cc16","#d946ef"
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'right' },
          datalabels: {
            color: '#fff',
            formatter: (value, ctx) => {
              let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              let percentage = (value * 100 / sum).toFixed(1) + "%";
              return percentage;
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }
}

function updateTable() {
  const tb = document.getElementById("tbody");
  const empty = document.getElementById("emptyState");
  tb.innerHTML = "";
  if (VIEW.length === 0) {
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");
  VIEW.forEach(r => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-4 py-2">${r[COL.month] || ""}</td>
      <td class="px-4 py-2">${r[COL.date] || ""}</td>
      <td class="px-4 py-2">${r[COL.driver] || ""}</td>
      <td class="px-4 py-2">${(toNumber(r[COL.weight])/1000).toFixed(2)}</td>
      <td class="px-4 py-2">${r[COL.vehicle] || ""}</td>
    `;
    tb.appendChild(tr);
  });
}

function fillMonthSelect() {
  const sel = document.getElementById("monthSelect");
  const months = Array.from(new Set(ALL.map(r => r[COL.month]).filter(Boolean)));
  months.forEach(m => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = m;
    sel.appendChild(opt);
  });
}

function fillVehicleSelect() {
  const sel = document.getElementById("vehicleSelect");
  const vehicles = Array.from(new Set(ALL.map(r => r[COL.vehicle]).filter(Boolean)));
  vehicles.forEach(v => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = v;
    sel.appendChild(opt);
  });
}

function render() {
  applyFilters();
  updateKPIs();
  updateTable();
}

async function loadData() {
  try {
    const result = await new Promise((resolve, reject) => {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: resolve,
        error: reject
      });
    });
    ALL = result.data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => {
        const kk = (k || "").trim();
        obj[kk] = (row[k] == null ? "" : String(row[k]).trim());
      });
      return obj;
    });
    fillMonthSelect();
    fillVehicleSelect();
    render();
  } catch (e) {
    console.error("ุฎุทุฃ ูู ุฌูุจ/ูุฑุงุกุฉ ุงูุดูุช:", e);
    alert("ุชุนุฐุฑ ุชุญููู ุงูุจูุงูุงุช ูู ุงูุดูุช.");
  }
}

document.getElementById("q").addEventListener("input", render);
document.getElementById("monthSelect").addEventListener("change", render);
document.getElementById("vehicleSelect").addEventListener("change", render);
document.getElementById("dateExact").addEventListener("change", render);
document.getElementById("resetBtn").addEventListener("click", () => {
  document.getElementById("q").value = "";
  document.getElementById("monthSelect").value = "";
  document.getElementById("vehicleSelect").value = "";
  document.getElementById("dateExact").value = "";
  render();
});

document.addEventListener("DOMContentLoaded", loadData);
</script>
</body>
</html>
