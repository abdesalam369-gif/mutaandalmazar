<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    /* تخصيص شريط تمرير بسيط */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    
    /* Collapsible sections styles */
    .collapsible-section {
      margin-bottom: 1.5rem;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    
    .collapsible-header {
      background-color: #f8fafc;
      padding: 1rem 1.5rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
      transition: background-color 0.3s ease;
    }
    
    .collapsible-header:hover {
      background-color: #e2e8f0;
    }
    
    .collapsible-header h3 {
      margin: 0;
      font-weight: 600;
      color: #1e293b;
    }
    
    .collapsible-icon {
      transition: transform 0.3s ease;
      font-size: 1.2rem;
      color: #64748b;
    }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background-color: white;
    }
    
    .collapsible-content.expanded {
      max-height: 5000px; /* Large enough to contain all content */
    }
    
    .collapsible-content-inner {
      padding: 1.5rem;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="toast-container" class="fixed top-24 right-4 z-50"></div>
  <div id="loadingOverlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="flex flex-col items-center gap-3">
      <div class="h-8 w-8 rounded-full border-4 border-blue-600 border-t-transparent animate-spin"></div>
      <div class="text-sm text-blue-700" id="loadingMessage"></div>
    </div>
  </div>

  <header class="bg-blue-600 text-white p-6 shadow fixed top-0 w-full z-40">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 pt-24">
    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-4">الفلاتر وعناصر التحكم</h2>
      <div class="grid grid-cols-1 lg:grid-cols-7 gap-4">
      <div class="lg:col-span-2">
        <label class="block text-sm mb-1">بحث عام</label>
        <input id="q" type="text" placeholder="ابحث بتاريخ أو سائق أو رقم مركبة..." class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">الشهور </label>
          <div class="flex gap-2 text-xs">
            <button id="monthSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>تحديد الكل</button>
            <button id="monthClearAll" class="px-2 py-1 rounded border hover:bg-gray-50 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>مسح</button>
          </div>
        </div>
        <div class="relative">
          <button id="monthDropdownBtn" class="w-full text-right border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">اختر الشهور... <span id="monthCount" class="text-blue-500 text-xs mr-2"></span></button>
          <div id="monthDropdownMenu" class="absolute hidden top-full left-0 z-10 w-full bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
          </div>
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">أرقام المركبات </label>
          <div class="flex gap-2 text-xs">
            <button id="vehSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>تحديد الكل</button>
            <button id="vehClearAll" class="px-2 py-1 rounded border hover:bg-gray-50 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>مسح</button>
          </div>
        </div>
        <div class="relative">
          <button id="vehicleDropdownBtn" class="w-full text-right border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">اختر المركبات... <span id="vehicleCount" class="text-blue-500 text-xs mr-2"></span></button>
          <div id="vehicleDropdownMenu" class="absolute hidden top-full left-0 z-10 w-full bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
            </div>
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">تاريخ محدد</label>
        <input id="dateExact" type="date" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div class="flex items-end lg:col-span-2">
        <div class="flex flex-wrap gap-2">
          <button id="resetBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">إعادة تعيين الفلاتر</button>
          <button id="refreshBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تحديث من المصدر</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الرحلات</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 id="k_trips" class="text-2xl font-bold text-blue-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الوزن</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3 .895-3 2 1.343 2 3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 0v3.003V12m0 0c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 id="k_weight" class="text-2xl font-bold text-green-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي كلفة الوقود</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m3 0V4a2 2 0 012-2h2a2 2 0 012 2v12m-3 0h6m-6 0h-2M9 20h6" /></svg><h3 id="k_totalFuelCost" class="text-2xl font-bold text-teal-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي كلفة الصيانة</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /></svg><h3 id="k_totalMaintenanceCost" class="text-2xl font-bold text-rose-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد المركبات</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><h3 id="k_vehicleCount" class="text-2xl font-bold text-yellow-600">0</h3></div></div>

      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">متوسط حمولة الرحلة</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3 .895-3 2 1.343 2 3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 0v3.003V12m0 0c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 id="k_avg" class="text-2xl font-bold text-purple-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد السائقين</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.165-1.294-.478-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.165-1.294.478-1.857m0 0a5.002 5.002 0 019.044 0H17M7 13a3 3 0 016 0v2m-3-2a3 3 0 00-3 3v2m-3-2a3 3 0 013-3m0 0a3 3 0 003 3v2" /></svg><h3 id="k_drivers" class="text-2xl font-bold text-orange-600">0</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (وزن)</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg><h3 id="k_topVehicleWeight" class="text-xl font-bold text-red-600">-</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (رحلات)</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg><h3 id="k_topVehicleTrips" class="text-xl font-bold text-indigo-600">-</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">اليوم الأعلى وزناً</p><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><h3 id="k_topDay" class="text-xl font-bold text-pink-600">-</h3></div></div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط يومي</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgDailyWeight" class="font-bold text-blue-600">0</span> طن/يوم</div>
          <div>الرحلات: <span id="k_avgDailyTrips" class="font-bold text-blue-600">0</span> رحلة/يوم</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط شهري</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgMonthlyWeight" class="font-bold text-blue-600">0</span> طن/شهر</div>
          <div>الرحلات: <span id="k_avgMonthlyTrips" class="font-bold text-blue-600">0</span> رحلة/شهر</div>
        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" data-target="timeSeriesContent">
        <h3>السلاسل الزمنية</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="timeSeriesContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <select id="tsAgg" class="border rounded-lg px-3 py-2">
              <option value="day">تجميع يومي</option>
              <option value="month">تجميع شهري</option>
            </select>
            <select id="tsMetric" class="border rounded-lg px-3 py-2">
              <option value="weight">الوزن (طن)</option>
              <option value="trips">الرحلات</option>
            </select>
          </div>
          <canvas id="timeSeriesChart" height="120"></canvas>
          <p class="text-xs text-gray-500 mt-2">* قد تُستثنى السجلات بلا تاريخ من الرسم اليومي.</p>
        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" data-target="vehicleWeightContent">
        <h3>وزن النقل حسب المركبة (بالطن)</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="vehicleWeightContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <label class="text-sm">بحث عن مركبة:</label>
            <input id="vwSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
            <label class="text-sm">Top N:</label>
            <input id="vwTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
          </div>
          <canvas id="vehicleWeightChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" data-target="tripDistributionContent">
        <h3>نسبة عدد الرحلات لكل مركبة</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="tripDistributionContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <label class="text-sm">بحث عن مركبة:</label>
            <input id="vtSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
            <label class="text-sm">Top N:</label>
            <input id="vtTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
          </div>
          <canvas id="vehicleTripsChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" data-target="vehicleEfficiencyContent">
        <h3>تحليل كفاءة المركبات</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="vehicleEfficiencyContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <label class="text-sm">بحث:</label>
            <input id="vaSearch" type="text" placeholder="ابحث..." class="border rounded-lg px-3 py-1">
            <label class="text-sm">من سنة تصنيع:</label>
            <input id="vaYear" type="number" placeholder="2000" class="w-24 border rounded-lg px-3 py-1">
            <label class="text-sm">ترتيب تنازلي حسب:</label>
            <select id="vaSort" class="border rounded-lg px-3 py-1">
              <option value="eff">نسبة الاستغلال</option>
              <option value="fuelCost">كلفة الوقود</option>
              <option value="maintenanceCost">كلفة الصيانة</option>
              <option value="costPerTrip">كلفة الرحلة</option>
              <option value="costPerTon">كلفة الطن</option>
              <option value="capTon">السعة النظرية</option>
              <option value="trips">عدد الرحلات</option>
              <option value="wton">الوزن المنقول</option>
              <option value="year">سنة التصنيع</option>
            </select>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-right">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2">رقم المركبة</th>
                  <th class="px-4 py-2">السائق</th>
                  <th class="px-4 py-2">سنة التصنيع</th>
                  <th class="px-4 py-2">السعة (م³)</th>
                  <th class="px-4 py-2">السعة النظرية (طن)</th>
                  <th class="px-4 py-2">عدد الرحلات</th>
                  <th class="px-4 py-2">الوزن المنقول (طن)</th>
                  <th class="px-4 py-2">نسبة الاستغلال %</th>
                  <th class="px-4 py-2">كلفة الوقود</th>
                  <th class="px-4 py-2">كلفة الصيانة</th>
                  <th class="px-4 py-2">كلفة الرحلة</th>
                  <th class="px-4 py-2">كلفة الطن</th>
                </tr>
              </thead>
              <tbody id="vehAnalysisTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 mb-6">
      <button id="btnCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (الرحلات الحالية)</button>
      <button id="btnXLSX" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير Excel (رحلات + ملخص مركبات)</button>
      <button id="btnPDF" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">PDF (سجل الرحلات)</button>
      <button id="btnDriversCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (تحليل السائقين)</button>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" data-target="driverAnalysisContent">
        <h3>تحليل السائقين</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="driverAnalysisContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <label class="text-sm">الترتيب</label>
            <select id="driverSort" class="border rounded-lg px-3 py-2">
              <option value="weight">حسب الوزن</option>
              <option value="trips">حسب الرحلات</option>
              <option value="avg">متوسط حمولة/رحلة</option>
            </select>
            <label class="text-sm">عدد السائقين (Top N)</label>
            <input id="driverTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-2">
            <label class="text-sm">بحث عن سائق</label>
            <input id="driverSearch" type="text" placeholder="اسم السائق" class="border rounded-lg px-3 py-2">
          </div>
          <canvas id="driverChart" height="120" class="mb-6"></canvas>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-right">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2">السائق</th>
                  <th class="px-4 py-2">عدد الرحلات</th>
                  <th class="px-4 py-2">الوزن (طن)</th>
                  <th class="px-4 py-2">متوسط/رحلة (طن)</th>
                  <th class="px-4 py-2">عدد المركبات</th>
                  <th class="px-4 py-2">المركبات</th>
                </tr>
              </thead>
              <tbody id="driverTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" data-target="tripLogContent">
        <h3>سجل الرحلات</h3>
        <span class="collapsible-icon">▼</span>
      </div>
      <div id="tripLogContent" class="collapsible-content">
        <div class="collapsible-content-inner">
          <div class="p-4 flex flex-wrap items-center gap-3">
            <label class="text-sm">عدد الصفوف في الصفحة</label>
            <select id="pageSize" class="border rounded-lg px-2 py-1">
              <option>10</option>
              <option selected>25</option>
              <option>50</option>
              <option>100</option>
            </select>

            <div class="ms-auto flex items-center gap-2">
              <button id="prevPage" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
              <span class="text-sm">صفحة <span id="pageIdx">1</span> من <span id="pageTotal">1</span></span>
              <button id="nextPage" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-right">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2">الشهر</th>
                  <th class="px-4 py-2">تاريخ التوزين الثاني</th>
                  <th class="px-4 py-2">السائق</th>
                  <th class="px-4 py-2">صافي التحميل (طن)</th>
                  <th class="px-4 py-2">رقم المركبة</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="p-4 border-t flex items-center gap-2">
            <button id="prevPage2" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
            <span class="text-sm">صفحة <span id="pageIdx2">1</span> من <span id="pageTotal2">1</span></span>
            <button id="nextPage2" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
            <div class="ms-auto text-xs text-gray-500">* الترتيب الافتراضي حسب ترتيب المصدر.</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    /* ===== إعدادات الأعمدة ===== */
    const COL = {
      month: "الشهر",
      date: "تاريخ التوزين الثاني",
      driver: "السائق",
      weight: "صافي التحميل",
      vehicle: "رقم المركبة"
    };
    const VEH_COLS = {
      plate: "رقم المركبة",
      driver: "السائق",
      year: "سنة التصنيع",
      capacity: "السعة",
      capTon: "السعة النظرية"
    };
    const FUEL_COLS = {
      plate: "رقم المركبة",
      jan: "jan", feb: "feb", mar: "mar", apr: "apr", may: "may", jun: "jun",
      july: "july", aug: "aug", sep: "sep", oct: "oct", nov: "nov", dec: "dec"
    };
    const MAINT_COLS = {
      plate: "رقم المركبة",
      cost: "كلفة الصيانة"
    };

    /* ===== روابط الشيتات ===== */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";
    const VEH_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2001178330&single=true&output=csv";
    const FUEL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=1380959426&single=true&output=csv";
    const MAINTENANCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2095309457&single=true&output=csv";

    /* ===== متغيرات عامة ===== */
    let ALL = [];
    let VIEW = [];
    let VEHICLES = [];
    let FUEL = [];
    let MAINTENANCE = [];
    let vehicleWeightChart = null;
    let vehicleTripsChart  = null;
    let timeSeriesChart    = null;
    let driverChart        = null;
    let currentPage = 1;
    let pageSize = 25;
    const MONTH_NAMES = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
    
    /* تحميل/تعطيل */
    let dataLoaded = false, vehiclesLoaded = false, fuelLoaded = false, maintenanceLoaded = false;
    const controlsSelector = 'input, select, button';
    function setLoading(state, msg = '') {
      const overlay = document.getElementById('loadingOverlay');
      const message = document.getElementById('loadingMessage');
      overlay.style.display = state ? 'flex' : 'none';
      message.textContent = msg;
      document.querySelectorAll(controlsSelector).forEach(el => {
        if (el.id === 'refreshBtn') return; // اسمح بالتحديث دائماً
        el.disabled = state;
      });
    }

    function maybeHideOverlay() {
      if (dataLoaded && vehiclesLoaded && fuelLoaded && maintenanceLoaded) {
        setLoading(false);
      }
    }

    /* أدوات مساعدة */
    function toNumber(v) {
      if (v == null) return 0;
      let s = String(v).trim();
      const arabicMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
      s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
      s = s.replace(/[^\d.]/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    const KG_TO_TON_DIV = 1000;
    // Default to 1000 for kg to ton conversion
    function formatTonFromKg(kg) {
      const t = kg / KG_TO_TON_DIV;
      return t.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function parseDate(dateString) {
      if (!dateString) return null;
      let s = String(dateString).trim();
      const arabicMap = { '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9' };
      s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
      let date = new Date(s);
      if (!isNaN(date.getTime())) return date;
      // Try DD/MM/YYYY format
      const parts = s.split(/[-\/]/);
      if (parts.length === 3) {
        const [d, m, y] = parts;
        date = new Date(`${y}-${m}-${d}`);
        if (!isNaN(date.getTime())) return date;
      }
      return null;
    }

    function toYMD(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const d = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    
    function toYM(dt) {
      return MONTH_NAMES[dt.getMonth()];
    }

    function showToast(message, type = 'success', duration = 3000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `p-4 mb-2 text-sm text-white rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.textContent = message;
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.3s ease-in-out';
      container.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '1'; }, 10);
      setTimeout(() => { toast.style.opacity = '0'; }, duration);
      setTimeout(() => { toast.remove(); }, duration + 500);
    }
    
    /* ===== فلترة ===== */
    function applyFilters() {
      const q = document.getElementById("q").value.trim().toLowerCase();
      const monthCheckboxes = document.querySelectorAll("#monthDropdownMenu input[type='checkbox']");
      const vehicleCheckboxes = document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']");
      const months = Array.from(monthCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
      const vehicles = Array.from(vehicleCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
      const d = document.getElementById("dateExact").value;
      
      currentPage = 1; // Reset pagination when filters are applied
      
      VIEW = ALL.filter(r => {
        const recMonth = String(r[COL.month] || "").trim();
        const recVeh = String(r[COL.vehicle] || "").trim();
        
        const byMonth = months.length ? months.includes(recMonth) : true;
        const byVehicle = vehicles.length ? vehicles.includes(recVeh) : true;
        
        let byDate = true;
        if (d) {
          if (!r[COL.date]) byDate = false;
          else {
            const recordDate = parseDate(r[COL.date]);
            const exactDate = new Date(d);
            byDate = recordDate && recordDate.toDateString() === exactDate.toDateString();
          }
        }
        
        if (!byMonth || !byVehicle || !byDate) return false;
        
        if (!q) return true;
        const hay = [r[COL.month], r[COL.date], r[COL.driver], r[COL.weight], r[COL.vehicle]].map(x => (x==null?"":String(x))).join(" ").toLowerCase();
        return hay.includes(q);
      });
      
      renderUI();
    }
    
    /* ===== ملخص المركبات ===== */
    function updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers) {
      const vehiclesSet = new Set([...Object.keys(byVehicleTrips), ...Object.keys(byVehicleWeight)]);
      let summary = Array.from(vehiclesSet).map(v => ({
        vehicle: v,
        drivers: Array.from(vehicleDrivers[v] || []),
        trips: byVehicleTrips[v] || 0,
        weightTon: (byVehicleWeight[v] || 0) / 1000
      }));
      
      const vsQuery = document.getElementById("vaSearch")?.value?.toLowerCase() || "";
      const vsYear = toNumber(document.getElementById("vaYear")?.value) || 0;
      const vsSort = document.getElementById("vaSort")?.value || "eff";

      // دمج بيانات المركبات مع الملخص
      summary = summary.map(item => {
        const vehicleData = VEHICLES.find(v => v[VEH_COLS.plate] === item.vehicle) || {};
        return {
          ...item,
          year: toNumber(vehicleData[VEH_COLS.year]),
          capacity: toNumber(vehicleData[VEH_COLS.capacity]),
          capTon: toNumber(vehicleData[VEH_COLS.capTon]),
          fuelCost: toNumber(FUEL.find(f => f[FUEL_COLS.plate] === item.vehicle)?.jan), // مثال، يجب أن يكون ديناميكي
          maintenanceCost: toNumber(MAINTENANCE.find(m => m[MAINT_COLS.plate] === item.vehicle)?.cost)
        };
      });

      // Filter by search query
      if (vsQuery) {
        summary = summary.filter(r => r.vehicle.toLowerCase().includes(vsQuery) || r.drivers.join(", ").toLowerCase().includes(vsQuery));
      }

      // Filter by year
      if (vsYear) {
        summary = summary.filter(r => r.year >= vsYear);
      }

      // حساب الكفاءة والتكاليف
      summary = summary.map(row => {
        const costPerTrip = (row.fuelCost + row.maintenanceCost) / row.trips || 0;
        const costPerTon = (row.fuelCost + row.maintenanceCost) / row.weightTon || 0;
        const efficiency = (row.weightTon / row.capTon) * 100 || 0;
        return {
          ...row,
          costPerTrip: costPerTrip,
          costPerTon: costPerTon,
          eff: efficiency
        };
      });

      // Sort
      if (vsSort === "eff") { summary.sort((a,b)=>b.eff-a.eff); }
      else if (vsSort === "fuelCost") { summary.sort((a,b)=>b.fuelCost-a.fuelCost); }
      else if (vsSort === "maintenanceCost") { summary.sort((a,b)=>b.maintenanceCost-a.maintenanceCost); }
      else if (vsSort === "costPerTrip") { summary.sort((a,b)=>b.costPerTrip-a.costPerTrip); }
      else if (vsSort === "costPerTon") { summary.sort((a,b)=>b.costPerTon-a.costPerTon); }
      else if (vsSort === "capTon") { summary.sort((a,b)=>b.capTon-a.capTon); }
      else if (vsSort === "trips") { summary.sort((a,b)=>b.trips-a.trips); }
      else if (vsSort === "wton") { summary.sort((a,b)=>b.weightTon-a.weightTon); }
      else if (vsSort === "year") { summary.sort((a,b)=>b.year-a.year); }

      const tbody = document.getElementById("vehAnalysisTable");
      if (!tbody) return;
      tbody.innerHTML = "";
      summary.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${row.vehicle}</td>
          <td class="px-4 py-2">${row.drivers.join(", ")}</td>
          <td class="px-4 py-2">${row.year || 'N/A'}</td>
          <td class="px-4 py-2">${row.capacity || 'N/A'}</td>
          <td class="px-4 py-2">${formatTonFromKg(row.capTon * 1000)}</td>
          <td class="px-4 py-2">${row.trips}</td>
          <td class="px-4 py-2">${formatTonFromKg(row.weightTon * 1000)}</td>
          <td class="px-4 py-2">${row.eff.toFixed(2)} %</td>
          <td class="px-4 py-2">${row.fuelCost || 'N/A'}</td>
          <td class="px-4 py-2">${row.maintenanceCost || 'N/A'}</td>
          <td class="px-4 py-2">${row.costPerTrip.toFixed(2)}</td>
          <td class="px-4 py-2">${row.costPerTon.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ===== ملخص السائقين ===== */
    function updateDriverSummary(byDriverTrips, byDriverWeight, driverVehicles) {
      const driversSet = new Set([...Object.keys(byDriverTrips), ...Object.keys(byDriverWeight)]);
      let summary = Array.from(driversSet).map(d => ({
        driver: d,
        trips: byDriverTrips[d] || 0,
        weightTon: (byDriverWeight[d] || 0) / 1000,
        avgWeight: (byDriverWeight[d] || 0) / (byDriverTrips[d] || 1) / 1000,
        vehicles: Array.from(driverVehicles[d] || [])
      }));

      const dQuery = document.getElementById("driverSearch")?.value?.toLowerCase() || "";
      const dSort = document.getElementById("driverSort")?.value || "weight";
      const dTopN = toNumber(document.getElementById("driverTopN")?.value) || 10;

      if (dQuery) {
        summary = summary.filter(r => r.driver.toLowerCase().includes(dQuery));
      }

      if (dSort === "weight") { summary.sort((a, b) => b.weightTon - a.weightTon); }
      else if (dSort === "trips") { summary.sort((a, b) => b.trips - a.trips); }
      else if (dSort === "avg") { summary.sort((a, b) => b.avgWeight - a.avgWeight); }

      summary = summary.slice(0, dTopN);

      const tbody = document.getElementById("driverTable");
      if (!tbody) return;
      tbody.innerHTML = "";
      summary.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${row.driver}</td>
          <td class="px-4 py-2">${row.trips}</td>
          <td class="px-4 py-2">${formatTonFromKg(row.weightTon * 1000)}</td>
          <td class="px-4 py-2">${formatTonFromKg(row.avgWeight * 1000)}</td>
          <td class="px-4 py-2">${row.vehicles.length}</td>
          <td class="px-4 py-2">${row.vehicles.join(", ")}</td>
        `;
        tbody.appendChild(tr);
      });

      createDriverChart(summary, dSort);
    }

    /* ===== المخططات البيانية ===== */
    function createTimeSeriesChart(data) {
      const ctx = document.getElementById('timeSeriesChart').getContext('2d');
      if (timeSeriesChart) timeSeriesChart.destroy();
      timeSeriesChart = new Chart(ctx, { type: 'bar', data, options: { maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true } } } });
    }
    
    function updateTimeSeriesChart() {
      if (!timeSeriesChart) return;
      const agg = document.getElementById("tsAgg").value;
      const metric = document.getElementById("tsMetric").value;

      const aggregated = {};
      VIEW.forEach(r => {
        const date = parseDate(r[COL.date]);
        if (!date) return;
        const label = agg === 'day' ? toYMD(date) : toYM(date);
        const value = toNumber(r[COL.weight]) / (metric === 'weight' ? 1000 : 1);
        if (!aggregated[label]) { aggregated[label] = { value: 0, count: 0 }; }
        aggregated[label].value += value;
        aggregated[label].count++;
      });
      
      const labels = Object.keys(aggregated).sort();
      const data = labels.map(l => aggregated[l].value);

      timeSeriesChart.data.labels = labels;
      timeSeriesChart.data.datasets[0].data = data;
      timeSeriesChart.data.datasets[0].label = metric === 'weight' ? 'إجمالي الوزن (طن)' : 'إجمالي الرحلات';
      timeSeriesChart.update();
    }
    
    function createVehicleWeightChart(data) {
      const ctx = document.getElementById('vehicleWeightChart').getContext('2d');
      if (vehicleWeightChart) vehicleWeightChart.destroy();
      vehicleWeightChart = new Chart(ctx, { type: 'bar', data, options: { indexAxis: 'y', maintainAspectRatio: false, scales: { x: { beginAtZero: true } } } });
    }
    
    function updateVehicleWeightChart() {
      if (!vehicleWeightChart) return;
      const q = document.getElementById("vwSearch")?.value?.toLowerCase() || "";
      const topN = toNumber(document.getElementById("vwTopN")?.value) || 10;
      
      const aggregated = {};
      VIEW.forEach(r => {
        const veh = String(r[COL.vehicle] || "").trim();
        if (q && !veh.toLowerCase().includes(q)) return;
        aggregated[veh] = (aggregated[veh] || 0) + toNumber(r[COL.weight]);
      });
      
      let summary = Object.entries(aggregated).map(([veh, weight]) => ({ veh, weight }));
      summary.sort((a,b) => b.weight - a.weight);
      summary = summary.slice(0, topN);
      
      const labels = summary.map(s => s.veh);
      const data = summary.map(s => s.weight / 1000);
      
      vehicleWeightChart.data.labels = labels;
      vehicleWeightChart.data.datasets[0].data = data;
      vehicleWeightChart.update();
    }
    
    function createVehicleTripsChart(data) {
      const ctx = document.getElementById('vehicleTripsChart').getContext('2d');
      if (vehicleTripsChart) vehicleTripsChart.destroy();
      vehicleTripsChart = new Chart(ctx, { type: 'pie', data, options: { maintainAspectRatio: false, plugins: { datalabels: { formatter: (value, ctx) => { return ctx.chart.data.labels[ctx.dataIndex] + '\n' + Math.round(value) + '%'; }, color: '#fff', } } } });
    }
    
    function updateVehicleTripsChart() {
      if (!vehicleTripsChart) return;
      const q = document.getElementById("vtSearch")?.value?.toLowerCase() || "";
      const topN = toNumber(document.getElementById("vtTopN")?.value) || 10;
      
      const aggregated = {};
      VIEW.forEach(r => {
        const veh = String(r[COL.vehicle] || "").trim();
        if (q && !veh.toLowerCase().includes(q)) return;
        aggregated[veh] = (aggregated[veh] || 0) + 1;
      });
      
      const totalTrips = Object.values(aggregated).reduce((sum, count) => sum + count, 0);
      let summary = Object.entries(aggregated).map(([veh, trips]) => ({ veh, trips, percentage: (trips / totalTrips) * 100 }));
      summary.sort((a,b) => b.trips - a.trips);
      
      const others = summary.slice(topN).reduce((sum, s) => sum + s.percentage, 0);
      summary = summary.slice(0, topN);
      if (others > 0) summary.push({ veh: 'أخرى', percentage: others });
      
      const labels = summary.map(s => s.veh);
      const data = summary.map(s => s.percentage);
      
      vehicleTripsChart.data.labels = labels;
      vehicleTripsChart.data.datasets[0].data = data;
      vehicleTripsChart.update();
    }

    function createDriverChart(data, sortMetric) {
      const ctx = document.getElementById('driverChart').getContext('2d');
      if (driverChart) driverChart.destroy();
      const labels = data.map(r => r.driver);
      const values = data.map(r => sortMetric === 'trips' ? r.trips : r.weightTon);
      const label = sortMetric === 'trips' ? 'عدد الرحلات' : 'الوزن (طن)';
      driverChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label, data: values, backgroundColor: '#f97316' }] }, options: { indexAxis: 'y', maintainAspectRatio: false, scales: { x: { beginAtZero: true } } } });
    }
    
    /* ===== تحديث لوحة البيانات الرئيسية ===== */
    function updateKPIs() {
      const totalTrips = VIEW.length;
      const totalWeight = VIEW.reduce((sum, r) => sum + toNumber(r[COL.weight]), 0);
      const totalVehicles = new Set(VIEW.map(r => String(r[COL.vehicle]).trim())).size;
      const totalDrivers = new Set(VIEW.map(r => String(r[COL.driver]).trim())).size;
      const avgWeight = totalTrips > 0 ? totalWeight / totalTrips : 0;
      const uniqueDates = new Set(VIEW.filter(r => r[COL.date]).map(r => toYMD(parseDate(r[COL.date]))));
      const dailyAverageWeight = uniqueDates.size > 0 ? totalWeight / uniqueDates.size : 0;
      const dailyAverageTrips = uniqueDates.size > 0 ? totalTrips / uniqueDates.size : 0;
      const uniqueMonths = new Set(VIEW.filter(r => r[COL.month]).map(r => r[COL.month]));
      const monthlyAverageWeight = uniqueMonths.size > 0 ? totalWeight / uniqueMonths.size : 0;
      const monthlyAverageTrips = uniqueMonths.size > 0 ? totalTrips / uniqueMonths.size : 0;
      
      const byVehicleTrips = {};
      const byVehicleWeight = {};
      const byDayWeight = {};
      const vehicleDrivers = {};
      const byDriverTrips = {};
      const byDriverWeight = {};
      const driverVehicles = {};

      VIEW.forEach(r => {
        const veh = String(r[COL.vehicle] || "").trim();
        const driver = String(r[COL.driver] || "").trim();
        const date = parseDate(r[COL.date]);
        const weight = toNumber(r[COL.weight]);
        
        if(veh) {
          byVehicleTrips[veh] = (byVehicleTrips[veh] || 0) + 1;
          byVehicleWeight[veh] = (byVehicleWeight[veh] || 0) + weight;
          if(driver) {
            if(!vehicleDrivers[veh]) vehicleDrivers[veh] = new Set();
            vehicleDrivers[veh].add(driver);
          }
        }
        
        if(driver) {
          byDriverTrips[driver] = (byDriverTrips[driver] || 0) + 1;
          byDriverWeight[driver] = (byDriverWeight[driver] || 0) + weight;
          if(veh) {
            if(!driverVehicles[driver]) driverVehicles[driver] = new Set();
            driverVehicles[driver].add(veh);
          }
        }
        
        if(date) {
          const ymd = toYMD(date);
          byDayWeight[ymd] = (byDayWeight[ymd] || 0) + weight;
        }
      });

      const topVehicleTrips = Object.entries(byVehicleTrips).sort(([, a], [, b]) => b - a)[0];
      const topVehicleWeight = Object.entries(byVehicleWeight).sort(([, a], [, b]) => b - a)[0];
      const topDay = Object.entries(byDayWeight).sort(([, a], [, b]) => b - a)[0];

      document.getElementById('k_trips').textContent = totalTrips.toLocaleString();
      document.getElementById('k_weight').textContent = formatTonFromKg(totalWeight);
      document.getElementById('k_vehicleCount').textContent = totalVehicles.toLocaleString();
      document.getElementById('k_drivers').textContent = totalDrivers.toLocaleString();
      document.getElementById('k_avg').textContent = formatTonFromKg(avgWeight);
      document.getElementById('k_topVehicleTrips').textContent = topVehicleTrips ? `${topVehicleTrips[0]} (${topVehicleTrips[1]})` : '-';
      document.getElementById('k_topVehicleWeight').textContent = topVehicleWeight ? `${topVehicleWeight[0]} (${formatTonFromKg(topVehicleWeight[1])})` : '-';
      document.getElementById('k_topDay').textContent = topDay ? `${topDay[0]} (${formatTonFromKg(topDay[1])})` : '-';
      document.getElementById('k_avgDailyWeight').textContent = `${formatTonFromKg(dailyAverageWeight)}`;
      document.getElementById('k_avgDailyTrips').textContent = `${dailyAverageTrips.toFixed(2)}`;
      document.getElementById('k_avgMonthlyWeight').textContent = `${formatTonFromKg(monthlyAverageWeight)}`;
      document.getElementById('k_avgMonthlyTrips').textContent = `${monthlyAverageTrips.toFixed(2)}`;

      // Update charts and tables
      updateTimeSeriesChart();
      updateVehicleWeightChart();
      updateVehicleTripsChart();
      updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers);
      updateDriverSummary(byDriverTrips, byDriverWeight, driverVehicles);
    }
    
    function populateTripTable() {
      const tbody = document.getElementById("tbody");
      if (!tbody) return;
      tbody.innerHTML = '';
      
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const paginatedData = VIEW.slice(startIndex, endIndex);

      paginatedData.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-4 py-2">${r[COL.month] || ''}</td>
          <td class="px-4 py-2">${r[COL.date] || ''}</td>
          <td class="px-4 py-2">${r[COL.driver] || ''}</td>
          <td class="px-4 py-2">${formatTonFromKg(toNumber(r[COL.weight]))}</td>
          <td class="px-4 py-2">${r[COL.vehicle] || ''}</td>
        `;
        tbody.appendChild(tr);
      });
      
      const totalPages = Math.ceil(VIEW.length / pageSize);
      document.getElementById('pageIdx').textContent = currentPage;
      document.getElementById('pageTotal').textContent = totalPages;
      document.getElementById('pageIdx2').textContent = currentPage;
      document.getElementById('pageTotal2').textContent = totalPages;
    }
    
    function renderUI() {
      updateKPIs();
      populateTripTable();
    }
    
    /* ===== تصدير البيانات ===== */
    async function exportToCSV(data, fileName) {
      const csv = Papa.unparse(data);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.setAttribute("href", URL.createObjectURL(blob));
      link.setAttribute("download", fileName);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function exportToXLSX() {
      const tripData = VIEW;
      
      // Calculate vehicle summary for a separate sheet
      const byVehicleTrips = {};
      const byVehicleWeight = {};
      const vehicleDrivers = {};
      ALL.forEach(r => {
        const veh = String(r[COL.vehicle] || "").trim();
        const driver = String(r[COL.driver] || "").trim();
        const weight = toNumber(r[COL.weight]);
        byVehicleTrips[veh] = (byVehicleTrips[veh] || 0) + 1;
        byVehicleWeight[veh] = (byVehicleWeight[veh] || 0) + weight;
        if(!vehicleDrivers[veh]) vehicleDrivers[veh] = new Set();
        vehicleDrivers[veh].add(driver);
      });
      const vehicleSummary = Object.keys(byVehicleTrips).map(v => ({
        [VEH_COLS.plate]: v,
        "عدد الرحلات": byVehicleTrips[v],
        "الوزن (طن)": formatTonFromKg(byVehicleWeight[v]),
        "السائقون": Array.from(vehicleDrivers[v]).join(", ")
      }));
      vehicleSummary.sort((a,b) => b["عدد الرحلات"] - a["عدد الرحلات"]);

      const ws_trips = XLSX.utils.json_to_sheet(tripData);
      const ws_vehicles = XLSX.utils.json_to_sheet(vehicleSummary);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws_trips, "سجل الرحلات");
      XLSX.utils.book_append_sheet(wb, ws_vehicles, "ملخص المركبات");
      XLSX.writeFile(wb, "تقرير_النقل.xlsx");
    }

    async function exportToPDF() {
      const content = document.getElementById('tripLogContent').querySelector('table');
      const filename = `سجل_الرحلات_${new Date().toISOString().slice(0,10)}.pdf`;
      const doc = new jspdf.jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      doc.setFont('Arabic', 'normal');
      doc.html(content, {
        callback: function (doc) {
          doc.save(filename);
        },
        x: 10,
        y: 10,
        html2canvas: { scale: 0.5 }
      });
    }

    /* ===== تحميل البيانات من المصدر ===== */
    async function parseSheetData(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            if (results.errors.length) {
              console.error("Parsing errors:", results.errors);
              reject("Failed to parse data");
            } else {
              resolve(results.data);
            }
          },
          error: function(err) {
            console.error("Network error:", err);
            reject("Failed to fetch data");
          }
        });
      });
    }

    async function fetchData(url, type) {
      setLoading(true, `جاري تحميل ${type}...`);
      try {
        const data = await parseSheetData(url);
        if (type === 'الرحلات') { ALL = data; dataLoaded = true; }
        else if (type === 'المركبات') { VEHICLES = data; vehiclesLoaded = true; }
        else if (type === 'الوقود') { FUEL = data; fuelLoaded = true; }
        else if (type === 'الصيانة') { MAINTENANCE = data; maintenanceLoaded = true; }
        
        showToast(`${type} تم تحميلها بنجاح.`);
      } catch (e) {
        showToast(`فشل في تحميل ${type}.`, 'error');
        console.error(e);
      } finally {
        maybeHideOverlay();
      }
    }

    /* ===== عناصر التحكم التفاعلية ===== */
    function setupDropdown(dropdownBtnId, dropdownMenuId, selectAllId, clearAllId, countId, data, labelKey) {
      const dropdownBtn = document.getElementById(dropdownBtnId);
      const dropdownMenu = document.getElementById(dropdownMenuId);
      const selectAllBtn = document.getElementById(selectAllId);
      const clearAllBtn = document.getElementById(clearAllId);
      const countSpan = document.getElementById(countId);

      const uniqueItems = [...new Set(data.map(r => String(r[labelKey] || "").trim()))].filter(Boolean).sort();
      
      dropdownMenu.innerHTML = '';
      uniqueItems.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center px-4 py-2 hover:bg-gray-100';
        div.innerHTML = `
          <input type="checkbox" id="${labelKey}-${index}" value="${item}" class="form-checkbox h-4 w-4 text-blue-600 rounded" checked>
          <label for="${labelKey}-${index}" class="ml-2 text-sm text-gray-700 w-full">${item}</label>
        `;
        dropdownMenu.appendChild(div);
      });

      function updateCount() {
        const checkedCount = dropdownMenu.querySelectorAll('input[type="checkbox"]:checked').length;
        countSpan.textContent = `(${checkedCount})`;
      }

      dropdownBtn.addEventListener('click', () => {
        dropdownMenu.classList.toggle('hidden');
      });

      selectAllBtn.addEventListener('click', () => {
        dropdownMenu.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        applyFilters();
      });

      clearAllBtn.addEventListener('click', () => {
        dropdownMenu.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        applyFilters();
      });

      dropdownMenu.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          updateCount();
          applyFilters();
        });
      });

      updateCount();
    }
    
    function setupEventListeners() {
      // Dropdown toggles
      document.querySelectorAll('.collapsible-header').forEach(header => {
        header.addEventListener('click', () => {
          const targetId = header.getAttribute('data-target');
          const targetContent = document.getElementById(targetId);
          const icon = header.querySelector('.collapsible-icon');
          targetContent.classList.toggle('expanded');
          icon.style.transform = targetContent.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
        });
      });

      // Filter and search inputs
      document.getElementById('q').addEventListener('input', applyFilters);
      document.getElementById('dateExact').addEventListener('change', applyFilters);
      
      // Filter dropdowns
      document.getElementById('monthDropdownBtn').addEventListener('click', () => document.getElementById('monthDropdownMenu').classList.toggle('hidden'));
      document.getElementById('vehicleDropdownBtn').addEventListener('click', () => document.getElementById('vehicleDropdownMenu').classList.toggle('hidden'));
      
      // Chart controls
      document.getElementById('tsAgg').addEventListener('change', updateTimeSeriesChart);
      document.getElementById('tsMetric').addEventListener('change', updateTimeSeriesChart);
      document.getElementById('vwSearch').addEventListener('input', updateVehicleWeightChart);
      document.getElementById('vwTopN').addEventListener('input', updateVehicleWeightChart);
      document.getElementById('vtSearch').addEventListener('input', updateVehicleTripsChart);
      document.getElementById('vtTopN').addEventListener('input', updateVehicleTripsChart);
      
      // Vehicle Analysis
      document.getElementById('vaSearch').addEventListener('input', applyFilters);
      document.getElementById('vaYear').addEventListener('input', applyFilters);
      document.getElementById('vaSort').addEventListener('change', applyFilters);
      
      // Driver Analysis
      document.getElementById('driverSort').addEventListener('change', applyFilters);
      document.getElementById('driverTopN').addEventListener('input', applyFilters);
      document.getElementById('driverSearch').addEventListener('input', applyFilters);

      // Pagination
      document.getElementById('pageSize').addEventListener('change', (e) => { pageSize = e.target.value; currentPage = 1; populateTripTable(); });
      document.getElementById('prevPage').addEventListener('click', () => { if (currentPage > 1) { currentPage--; populateTripTable(); } });
      document.getElementById('nextPage').addEventListener('click', () => { if (currentPage < Math.ceil(VIEW.length / pageSize)) { currentPage++; populateTripTable(); } });
      document.getElementById('prevPage2').addEventListener('click', () => { if (currentPage > 1) { currentPage--; populateTripTable(); } });
      document.getElementById('nextPage2').addEventListener('click', () => { if (currentPage < Math.ceil(VIEW.length / pageSize)) { currentPage++; populateTripTable(); } });

      // Action buttons
      document.getElementById('resetBtn').addEventListener('click', () => { location.reload(); });
      document.getElementById('refreshBtn').addEventListener('click', init);
      document.getElementById('btnCSV').addEventListener('click', () => exportToCSV(VIEW, "تقرير_الرحلات.csv"));
      document.getElementById('btnXLSX').addEventListener('click', exportToXLSX);
      document.getElementById('btnPDF').addEventListener('click', exportToPDF);
      document.getElementById('btnDriversCSV').addEventListener('click', () => {
        const driverSummary = Object.entries(byDriverTrips).map(([driver, trips]) => ({
            "السائق": driver,
            "عدد الرحلات": trips,
            "الوزن (طن)": formatTonFromKg(byDriverWeight[driver]),
            "متوسط/رحلة (طن)": formatTonFromKg(byDriverWeight[driver] / trips),
            "عدد المركبات": driverVehicles[driver]?.size || 0,
            "المركبات": Array.from(driverVehicles[driver] || []).join(", ")
        }));
        exportToCSV(driverSummary, "تحليل_السائقين.csv");
      });
    }

    async function init() {
      await Promise.all([
        fetchData(CSV_URL, 'الرحلات'),
        fetchData(VEH_URL, 'المركبات'),
        fetchData(FUEL_URL, 'الوقود'),
        fetchData(MAINTENANCE_URL, 'الصيانة')
      ]);

      if (dataLoaded && vehiclesLoaded && fuelLoaded && maintenanceLoaded) {
        VIEW = [...ALL];
        const uniqueMonths = [...new Set(ALL.map(r => String(r[COL.month] || "").trim()))].filter(Boolean);
        const uniqueVehicles = [...new Set(ALL.map(r => String(r[COL.vehicle] || "").trim()))].filter(Boolean);
        
        // Populate dropdowns
        setupDropdown('monthDropdownBtn', 'monthDropdownMenu', 'monthSelectAll', 'monthClearAll', 'monthCount', uniqueMonths.map(m => ({'month': m})), 'month');
        setupDropdown('vehicleDropdownBtn', 'vehicleDropdownMenu', 'vehSelectAll', 'vehClearAll', 'vehicleCount', uniqueVehicles.map(v => ({'vehicle': v})), 'vehicle');
        
        // Initial render
        renderUI();
        
        // Initial chart setup
        createTimeSeriesChart({ labels: [], datasets: [{ label: 'إجمالي الوزن (طن)', data: [], backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgb(59, 130, 246)', borderWidth: 1 }] });
        createVehicleWeightChart({ labels: [], datasets: [{ label: 'الوزن (طن)', data: [], backgroundColor: 'rgba(59, 130, 246, 0.7)' }] });
        createVehicleTripsChart({ labels: [], datasets: [{ data: [], backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#8b5cf6', '#ec4899', '#6b7280', '#0f766e'] }] });
        
        setupEventListeners();
        
        document.getElementById('k_totalFuelCost').textContent = FUEL.reduce((sum, r) => sum + Object.values(r).slice(1).reduce((s, v) => s + toNumber(v), 0), 0).toLocaleString();
        document.getElementById('k_totalMaintenanceCost').textContent = MAINTENANCE.reduce((sum, r) => sum + toNumber(r[MAINT_COLS.cost]), 0).toLocaleString();
      }
    }
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
