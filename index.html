<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    /* تخصيص شريط تمرير بسيط */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- ... (بقية الهيكل كما هو) ... -->
  
  <div id="vehAnalysisBox" class="bg-white rounded-xl shadow overflow-hidden mt-6 mb-6">
    <div class="p-4 border-b">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <label class="text-sm">بحث:</label>
        <input id="vaSearch" type="text" placeholder="ابحث..." class="border rounded-lg px-3 py-1">
        <label class="text-sm">من سنة تصنيع:</label>
        <input id="vaYear" type="number" placeholder="2000" class="w-24 border rounded-lg px-3 py-1">
        <label class="text-sm">ترتيب تنازلي حسب:</label>
        <select id="vaSort" class="border rounded-lg px-3 py-1">
          <option value="eff">نسبة الاستغلال</option>
          <option value="year">سنة التصنيع</option>
          <option value="capTon">السعة النظرية</option>
          <option value="costPerTrip">تكلفة الرحلة</option>
          <option value="costPerTon">تكلفة الطن</option>
        </select>
      </div>
      <h3 class="font-semibold">تحليل كفاءة المركبات</h3>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-right">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2">رقم المركبة</th>
            <th class="px-4 py-2">السائق</th>
            <th class="px-4 py-2">سنة التصنيع</th>
            <th class="px-4 py-2">السعة (م³)</th>
            <th class="px-4 py-2">السعة النظرية (طن)</th>
            <th class="px-4 py-2">عدد الرحلات</th>
            <th class="px-4 py-2">الوزن المنقول (طن)</th>
            <th class="px-4 py-2">نسبة الاستغلال %</th>
            <th class="px-4 py-2">كلفة الوقود</th>
            <th class="px-4 py-2">كلفة الصيانة</th>
            <th class="px-4 py-2">تكلفة الرحلة</th>
            <th class="px-4 py-2">تكلفة الطن</th>
          </tr>
        </thead>
        <tbody id="vehAnalysisTable"></tbody>
      </table>
    </div>
  </div>

  <!-- ... (بقية الهيكل كما هو) ... -->

<script>
/* ===== إعدادات الأعمدة ===== */
const COL = {
  month: "الشهر",
  date: "تاريخ التوزين الثاني",
  driver: "السائق",
  weight: "صافي التحميل",
  vehicle: "رقم المركبة"
};
/* ===== روابط الشيتات ===== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";
const VEH_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2001178330&single=true&output=csv";
const FUEL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=1380959426&single=true&output=csv";
const MAINTENANCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2095309457&single=true&output=csv";

/* ===== متغيرات عامة ===== */
let ALL = [];
let VIEW = [];
let VEHICLES = [];
let FUEL = [];
let MAINTENANCE = [];
let vehicleWeightChart = null;
let vehicleTripsChart  = null;
let timeSeriesChart    = null;
let driverChart        = null;

/* ... (بقية المتغيرات والوظائف كما هي) ... */

/* ===== تحليل كفاءة المركبات (من شيت المركبات) ===== */
function renderVehAnalysis(){
  const tb=document.getElementById("vehAnalysisTable");
  if(!tb) return;
  tb.innerHTML="";
  if(VEHICLES.length===0||VIEW.length===0) return;
  
  // تجميع السائقين لكل مركبة
  const vehicleDrivers  = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle] || "مجهولة";
    const d = r[COL.driver] || "بدون سائق";
    if (!vehicleDrivers[v]) vehicleDrivers[v] = new Set();
    vehicleDrivers[v].add(d);
  });

  const byVehicleWeight={};
  const byVehicleTrips={};
  VIEW.forEach(r=>{
    const v=r[COL.vehicle]||"مجهولة";
    byVehicleWeight[v]=(byVehicleWeight[v]||0)+toNumber(r[COL.weight]);
    byVehicleTrips[v]=(byVehicleTrips[v]||0)+1;
  });

  const vaQuery=document.getElementById("vaSearch").value.toLowerCase();
  const vaYearFilter=parseInt(document.getElementById("vaYear").value||"0");
  const vaSort=document.getElementById("vaSort").value;

  // تجميع كلف الوقود من الشيت
  const fuelMap = {};
  FUEL.forEach(f => {
    const vnum = String(f["رقم المركبة"] || "").trim();
    if (!vnum) return;
    let totalFuelCost = 0;
    const months = ["jan", "feb", "mar", "apr", "may", "jun", "july", "aug", "sep", "oct", "nov", "dec"];
    for (const m of months) {
      if (f[m]) {
        totalFuelCost += toNumber(f[m]);
      }
    }
    fuelMap[vnum] = totalFuelCost;
  });

  // تجميع كلف الصيانة من الشيت
  const maintenanceMap = {};
  MAINTENANCE.forEach(m => {
    const vnum = String(m["رقم المركبة"] || "").trim();
    if (vnum && m["كلفة الصيانة"]) {
      maintenanceMap[vnum] = toNumber(m["كلفة الصيانة"]);
    }
  });

  const vehicleData = [];
  VEHICLES.forEach(vh => {
    const vnum = String(vh["رقم المركبة"]||"");
    const year = parseInt(vh["سنة التصنيع"] || "0");
    const drivers = Array.from(vehicleDrivers[vnum]||[]).join(', ');

    if (vaQuery && !vnum.toLowerCase().includes(vaQuery) && !drivers.toLowerCase().includes(vaQuery)) return;
    if (vaYearFilter && year < vaYearFilter) return;

    const capM3 = toNumber(vh["سعة المركبة بالمتر المكعب"]);
    const dens = toNumber(vh["كثافة التحميل"]);
    const capTon = capM3 * dens;
    const trips = byVehicleTrips[vnum] || 0;
    const wkg = byVehicleWeight[vnum] || 0;
    const wton = wkg / 1000;
    const eff = (trips > 0 && capTon > 0) ? (wton / (trips * capTon)) * 100 : 0;
    const fuelCost = fuelMap[vnum] || 0;
    const maintenanceCost = maintenanceMap[vnum] || 0;
    
    // حساب التكاليف الجديدة
    const totalCost = fuelCost + maintenanceCost;
    const costPerTrip = trips > 0 ? totalCost / trips : 0;
    const costPerTon = wton > 0 ? totalCost / wton : 0;

    vehicleData.push({ 
      vnum, 
      drivers, 
      year, 
      capM3, 
      capTon, 
      trips, 
      wton, 
      eff, 
      fuelCost, 
      maintenanceCost,
      costPerTrip,
      costPerTon
    });
  });
  
  vehicleData.sort((a, b) => {
    if (vaSort === "year") return b.year - a.year;
    else if (vaSort === "capTon") return b.capTon - a.capTon;
    else if (vaSort === "costPerTrip") return b.costPerTrip - a.costPerTrip;
    else if (vaSort === "costPerTon") return b.costPerTon - a.costPerTon;
    else return b.eff - a.eff;
  });
  
  vehicleData.forEach(row => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-4 py-2">${row.vnum}</td>
      <td class="px-4 py-2">${row.drivers}</td>
      <td class="px-4 py-2">${row.year || "-"}</td>
      <td class="px-4 py-2">${row.capM3.toFixed(1)}</td>
      <td class="px-4 py-2">${row.capTon.toFixed(2)}</td>
      <td class="px-4 py-2">${row.trips}</td>
      <td class="px-4 py-2">${row.wton.toFixed(2)}</td>
      <td class="px-4 py-2">${row.eff.toFixed(1)}%</td>
      <td class="px-4 py-2">${row.fuelCost.toFixed(2)}</td>
      <td class="px-4 py-2">${row.maintenanceCost.toFixed(2)}</td>
      <td class="px-4 py-2">${row.costPerTrip.toFixed(2)}</td>
      <td class="px-4 py-2">${row.costPerTon.toFixed(2)}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ... (بقية الوظائف والأحداث كما هي) ... */

</script>
</body>
</html>
