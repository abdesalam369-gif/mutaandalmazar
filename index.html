<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة بيانات النقل</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    /* تخصيص شريط تمرير بسيط */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="loadingOverlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="flex flex-col items-center gap-3">
      <div class="h-8 w-8 rounded-full border-4 border-blue-600 border-t-transparent animate-spin"></div>
      <div class="text-sm text-blue-700">جاري التحميل...</div>
    </div>
  </div>

  <header class="bg-blue-600 text-white p-6 shadow">
    <div class="container mx-auto">
      <h1 class="text-2xl font-bold">نظام إدارة بيانات النقل</h1>
      <p class="text-blue-100">بلدية مؤتة والمزار</p>
      <p class="text-blue-200">2025</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow p-4 mb-6 grid grid-cols-1 lg:grid-cols-7 gap-4">
      <div class="lg:col-span-2">
        <label class="block text-sm mb-1">بحث عام</label>
        <input id="q" type="text" placeholder="ابحث بتاريخ أو سائق أو رقم مركبة..." class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">الشهور (اختيار متعدد)</label>
          <div class="flex gap-2 text-xs">
            <button id="monthSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50">تحديد الكل</button>
            <button id="monthClearAll" class="px-2 py-1 rounded border hover:bg-gray-50">مسح</button>
          </div>
        </div>
        <div class="relative">
          <button id="monthDropdownBtn" class="w-full text-right border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">اختر الشهور...</button>
          <div id="monthDropdownMenu" class="absolute hidden top-full left-0 z-10 w-full bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
            </div>
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">أرقام المركبات (اختيار متعدد)</label>
          <div class="flex gap-2 text-xs">
            <button id="vehSelectAll" class="px-2 py-1 rounded border hover:bg-gray-50">تحديد الكل</button>
            <button id="vehClearAll" class="px-2 py-1 rounded border hover:bg-gray-50">مسح</button>
          </div>
        </div>
        <div class="relative">
          <button id="vehicleDropdownBtn" class="w-full text-right border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-300">اختر المركبات...</button>
          <div id="vehicleDropdownMenu" class="absolute hidden top-full left-0 z-10 w-full bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1">
            </div>
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">تاريخ محدد</label>
        <input id="dateExact" type="date" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div class="flex items-end lg:col-span-2">
        <div class="flex flex-wrap gap-2">
          <button id="resetBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">إعادة تعيين الفلاتر</button>
          <button id="refreshBtn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تحديث من المصدر</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الرحلات</p><h3 id="k_trips" class="text-2xl font-bold text-blue-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي الوزن</p><h3 id="k_weight" class="text-2xl font-bold text-green-600">0</h3></div>
      <!-- بطاقة جديدة: إجمالي كلفة الوقود -->
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي كلفة الوقود</p><h3 id="k_totalFuelCost" class="text-2xl font-bold text-teal-600">0</h3></div>
      <!-- بطاقة جديدة: إجمالي كلفة الصيانة -->
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">إجمالي كلفة الصيانة</p><h3 id="k_totalMaintenanceCost" class="text-2xl font-bold text-rose-600">0</h3></div>
      <!-- بطاقة جديدة: عدد المركبات -->
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد المركبات</p><h3 id="k_vehicleCount" class="text-2xl font-bold text-yellow-600">0</h3></div>

      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">متوسط حمولة الرحلة</p><h3 id="k_avg" class="text-2xl font-bold text-purple-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">عدد السائقين</p><h3 id="k_drivers" class="text-2xl font-bold text-orange-600">0</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (وزن)</p><h3 id="k_topVehicleWeight" class="text-xl font-bold text-red-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">أكثر مركبة (رحلات)</p><h3 id="k_topVehicleTrips" class="text-xl font-bold text-indigo-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6"><p class="text-gray-500">اليوم الأعلى وزناً</p><h3 id="k_topDay" class="text-xl font-bold text-pink-600">-</h3></div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط يومي</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgDailyWeight" class="font-bold text-blue-600">0</span> طن/يوم</div>
          <div>الرحلات: <span id="k_avgDailyTrips" class="font-bold text-blue-600">0</span> رحلة/يوم</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-6">
        <p class="text-gray-500">متوسط شهري</p>
        <div class="mt-1 space-y-1 text-sm">
          <div>الوزن: <span id="k_avgMonthlyWeight" class="font-bold text-blue-600">0</span> طن/شهر</div>
          <div>الرحلات: <span id="k_avgMonthlyTrips" class="font-bold text-blue-600">0</span> رحلة/شهر</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow mb-4">
  <div class="flex justify-between items-center px-4 py-2 bg-gray-100"><h3 class="font-semibold">السلاسل الزمنية</h3><button onclick="toggleSection('timeSeriesBox')" id="btn-timeSeriesBox">▶</button></div>
  <div id="timeSeriesBox" class="p-6 hidden">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <h3 class="font-semibold">السلاسل الزمنية</h3>
        <select id="tsAgg" class="border rounded-lg px-3 py-2">
          <option value="day">تجميع يومي</option>
          <option value="month">تجميع شهري</option>
        </select>
        <select id="tsMetric" class="border rounded-lg px-3 py-2">
          <option value="weight">الوزن (طن)</option>
          <option value="trips">الرحلات</option>
        </select>
      </div>
</div>
      <canvas id="timeSeriesChart" height="120"></canvas>
      <p class="text-xs text-gray-500 mt-2">* قد تُستثنى السجلات بلا تاريخ من الرسم اليومي.</p>
    </div>

    <div class="bg-white rounded-xl shadow mb-4">
  <div class="flex justify-between items-center px-4 py-2 bg-gray-100"><h3 class="font-semibold">وزن النقل حسب المركبة (بالطن)</h3><button onclick="toggleSection('chartWeightBox')" id="btn-chartWeightBox">▶</button></div>
  <div id="chartWeightBox" class="p-6 hidden">
      <h3 class="mb-2 font-semibold">وزن النقل حسب المركبة (بالطن)</h3>
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <label class="text-sm">بحث عن مركبة:</label>
        <input id="vwSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
        <label class="text-sm">Top N:</label>
        <input id="vwTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
      </div>
</div>
      <canvas id="vehicleWeightChart" height="120"></canvas>
    </div>

    <div class="bg-white rounded-xl shadow mb-4">
  <div class="flex justify-between items-center px-4 py-2 bg-gray-100"><h3 class="font-semibold">نسبة عدد الرحلات لكل مركبة</h3><button onclick="toggleSection('chartTripsBox')" id="btn-chartTripsBox">▶</button></div>
  <div id="chartTripsBox" class="p-6 hidden">
      <h3 class="mb-2 font-semibold">نسبة عدد الرحلات لكل مركبة</h3>
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <label class="text-sm">بحث عن مركبة:</label>
        <input id="vtSearch" type="text" placeholder="رقم المركبة" class="border rounded-lg px-3 py-1">
        <label class="text-sm">Top N:</label>
        <input id="vtTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-1">
      </div>
</div>
      <canvas id="vehicleTripsChart" height="120"></canvas>
    </div>

    <div class="bg-white rounded-xl shadow mb-4">
  <div class="flex justify-between items-center px-4 py-2 bg-gray-100"><h3 class="font-semibold">تحليل كفاءة المركبات</h3><button onclick="toggleSection('vehAnalysisBox')" id="btn-vehAnalysisBox">▶</button></div>
  <div id="vehAnalysisBox" class="p-6 hidden">
      <div class="p-4 border-b">
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <label class="text-sm">بحث:</label>
          <input id="vaSearch" type="text" placeholder="ابحث..." class="border rounded-lg px-3 py-1">
          <label class="text-sm">من سنة تصنيع:</label>
          <input id="vaYear" type="number" placeholder="2000" class="w-24 border rounded-lg px-3 py-1">
          <label class="text-sm">ترتيب تنازلي حسب:</label>
          <select id="vaSort" class="border rounded-lg px-3 py-1">
            <option value="eff">نسبة الاستغلال</option>
            <option value="fuelCost">كلفة الوقود</option>
            <option value="maintenanceCost">كلفة الصيانة</option>
            <option value="costPerTrip">كلفة الرحلة</option>
            <option value="costPerTon">كلفة الطن</option>
            <option value="capTon">السعة النظرية</option>
            <option value="trips">عدد الرحلات</option>
            <option value="wton">الوزن المنقول</option>
            <option value="year">سنة التصنيع</option>
          </select>
        </div>
</div>
        <h3 class="font-semibold">تحليل كفاءة المركبات</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">رقم المركبة</th>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">سنة التصنيع</th>
              <th class="px-4 py-2">السعة (م³)</th>
              <th class="px-4 py-2">السعة النظرية (طن)</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">الوزن المنقول (طن)</th>
              <th class="px-4 py-2">نسبة الاستغلال %</th>
              <th class="px-4 py-2">كلفة الوقود</th>
              <th class="px-4 py-2">كلفة الصيانة</th>
              <th class="px-4 py-2">كلفة الرحلة</th>
              <th class="px-4 py-2">كلفة الطن</th>
            </tr>
          </thead>
          <tbody id="vehAnalysisTable"></tbody>
        </table>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 mb-6">
      <button id="btnCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (الرحلات الحالية)</button>
      <button id="btnXLSX" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير Excel (رحلات + ملخص مركبات)</button>
      <button id="btnPDF" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">PDF (سجل الرحلات)</button>
      <button id="btnDriversCSV" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg">تصدير CSV (تحليل السائقين)</button>
    </div>

    <div class="bg-white rounded-xl shadow mb-4">
  <div class="flex justify-between items-center px-4 py-2 bg-gray-100"><h3 class="font-semibold">تحليل السائقين</h3><button onclick="toggleSection('driversBox')" id="btn-driversBox">▶</button></div>
  <div id="driversBox" class="p-6 hidden">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <h3 class="font-semibold">تحليل السائقين</h3>
        <label class="text-sm">الترتيب</label>
        <select id="driverSort" class="border rounded-lg px-3 py-2">
          <option value="weight">حسب الوزن</option>
          <option value="trips">حسب الرحلات</option>
          <option value="avg">متوسط حمولة/رحلة</option>
        </select>
        <label class="text-sm">عدد السائقين (Top N)</label>
        <input id="driverTopN" type="number" min="1" value="10" class="w-24 border rounded-lg px-3 py-2">
        <label class="text-sm">بحث عن سائق</label>
        <input id="driverSearch" type="text" placeholder="اسم السائق" class="border rounded-lg px-3 py-2">
      </div>
</div>
      <canvas id="driverChart" height="120" class="mb-6"></canvas>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">عدد الرحلات</th>
              <th class="px-4 py-2">الوزن (طن)</th>
              <th class="px-4 py-2">متوسط/رحلة (طن)</th>
              <th class="px-4 py-2">عدد المركبات</th>
              <th class="px-4 py-2">المركبات</th>
            </tr>
          </thead>
          <tbody id="driverTable"></tbody>
        </table>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow mb-4">
  <div class="flex justify-between items-center px-4 py-2 bg-gray-100"><h3 class="font-semibold">سجل الرحلات</h3><button onclick="toggleSection('rawTripsBox')" id="btn-rawTripsBox">▶</button></div>
  <div id="rawTripsBox" class="p-6 hidden">
      <div class="p-4 border-b">
        <h3 class="font-semibold">سجل الرحلات</h3>
      </div>
</div>

      <div class="p-4 flex flex-wrap items-center gap-3">
        <label class="text-sm">عدد الصفوف في الصفحة</label>
        <select id="pageSize" class="border rounded-lg px-2 py-1">
          <option>10</option>
          <option selected>25</option>
          <option>50</option>
          <option>100</option>
        </select>

        <div class="ms-auto flex items-center gap-2">
          <button id="prevPage" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
          <span class="text-sm">صفحة <span id="pageIdx">1</span> من <span id="pageTotal">1</span></span>
          <button id="nextPage" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2">الشهر</th>
              <th class="px-4 py-2">تاريخ التوزين الثاني</th>
              <th class="px-4 py-2">السائق</th>
              <th class="px-4 py-2">صافي التحميل (طن)</th>
              <th class="px-4 py-2">رقم المركبة</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="p-4 border-t flex items-center gap-2">
        <button id="prevPage2" class="px-3 py-1 rounded border hover:bg-gray-50">السابق</button>
        <span class="text-sm">صفحة <span id="pageIdx2">1</span> من <span id="pageTotal2">1</span></span>
        <button id="nextPage2" class="px-3 py-1 rounded border hover:bg-gray-50">التالي</button>
        <div class="ms-auto text-xs text-gray-500">* الترتيب الافتراضي حسب ترتيب المصدر.</div>
      </div>
    </div>
  </main>

<script>
/* ===== إعدادات الأعمدة ===== */
const COL = {
  month: "الشهر",
  date: "تاريخ التوزين الثاني",
  driver: "السائق",
  weight: "صافي التحميل",
  vehicle: "رقم المركبة"
};
/* ===== روابط الشيتات ===== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=0&single=true&output=csv";
const VEH_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2001178330&single=true&output=csv";
const FUEL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=1380959426&single=true&output=csv";
const MAINTENANCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzqaKeM6Il-c1ubOzGHSzDWgfbW3URTWvTcF76Xx3HP-W5o_SDRozUeO_v5z-xits7UFpNxjdfC3w/pub?gid=2095309457&single=true&output=csv";

/* ===== متغيرات عامة ===== */
let ALL = [];
let VIEW = [];
let VEHICLES = [];
let FUEL = [];
let MAINTENANCE = [];
let vehicleWeightChart = null;
let vehicleTripsChart  = null;
let timeSeriesChart    = null;
let driverChart        = null;
/* تحميل/تعطيل */
let dataLoaded = false, vehiclesLoaded = false, fuelLoaded = false, maintenanceLoaded = false;
const controlsSelector = 'input, select, button';
function setLoading(state) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = state ? 'flex' : 'none';
  document.querySelectorAll(controlsSelector).forEach(el => {
    if (el.id === 'refreshBtn') return; // اسمح بالتحديث دائماً
    el.disabled = state;
  });
}
function maybeHideOverlay() {
  if (dataLoaded && vehiclesLoaded && fuelLoaded && maintenanceLoaded) setLoading(false);
}

/* أدوات مساعدة */
function toNumber(v) {
  if (v == null) return 0;
  let s = String(v).trim();
  const arabicMap = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
  s = s.replace(/[٠-٩]/g, d => arabicMap[d] || d);
  s = s.replace(/[^\d.]/g, "");
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}
function formatTonFromKg(kg) {
  const t = kg / 1000;
  return t.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function toYMD(dt) {
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const d = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function toYM(dt) {
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  return `${y}-${m}`;
}

/* ===== فلترة ===== */
function applyFilters() {
  const q = document.getElementById("q").value.trim().toLowerCase();
  const monthCheckboxes = document.querySelectorAll("#monthDropdownMenu input[type='checkbox']");
  const vehicleCheckboxes = document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']");
  const months = Array.from(monthCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
  const vehicles = Array.from(vehicleCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
  const d = document.getElementById("dateExact").value;
  VIEW = ALL.filter(r => {
    const recMonth = String(r[COL.month] || "").trim();
    const recVeh   = String(r[COL.vehicle] || "").trim();
    const byMonth   = months.length ? months.includes(recMonth) : true;
    const byVehicle = vehicles.length ? vehicles.includes(recVeh) : true;
    let byDate = true;
    if (d) {
      if (!r[COL.date]) byDate = false;
      else {
        const recordDate = new Date(r[COL.date]);
        const exactDate = new Date(d);
        byDate = recordDate.toDateString() === exactDate.toDateString();
      }
    }
    if (!byMonth || !byVehicle || !byDate) return false;
    if (!q) return true;
    const hay = [r[COL.month], r[COL.date], r[COL.driver], r[COL.weight], r[COL.vehicle]].map(x => (x==null?"":String(x))).join(" ").toLowerCase();
    return hay.includes(q);
  });
}

/* ===== ملخص المركبات ===== */
function updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers) {
  const vehiclesSet = new Set([...Object.keys(byVehicleTrips), ...Object.keys(byVehicleWeight)]);
  let summary = Array.from(vehiclesSet).map(v => ({
    vehicle: v,
    drivers: Array.from(vehicleDrivers[v] || []),
    trips: byVehicleTrips[v] || 0,
    weightTon: (byVehicleWeight[v] || 0) / 1000
  }));
  const vsQuery=document.getElementById("vsSearch")?.value?.toLowerCase() || "";
  const vsSort=document.getElementById("vsSort")?.value || "weight";
  if(vsQuery){
    summary=summary.filter(r=>r.vehicle.toLowerCase().includes(vsQuery)||r.drivers.join(", ").toLowerCase().includes(vsQuery));
  }
  if(vsSort==="weight"){ summary.sort((a,b)=>b.weightTon-a.weightTon); }
  else if(vsSort==="trips"){ summary.sort((a,b)=>b.trips-a.trips); }

  const tbody = document.getElementById("vehicleSummary");
  if (!tbody) return;
  tbody.innerHTML = "";
  summary.forEach(row => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-4 py-2">${row.vehicle}</td>
      <td class="px-4 py-2">${row.drivers.join(", ")}</td>
      <td class="px-4 py-2">${row.trips}</td>
      <td class="px-4 py-2">${row.weightTon.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===== Time Series ===== */

function computeTimeSeries(agg, metric) {
  const map = {};
  const MONTH_ORDER = ["jan","feb","mar","apr","may","jun","july","aug","sep","oct","nov","dec"];
  VIEW.forEach(r => {
    let key = null;
    if (agg === 'day') {
      if (!r[COL.date]) return;
      const dt = new Date(r[COL.date]);
      if (isNaN(dt)) return;
      key = toYMD(dt);
    } else {
      // شهري: استخدم فقط خانة الشهر
      if (!r[COL.month]) return;
      key = String(r[COL.month]).trim().toLowerCase();
      if (!MONTH_ORDER.includes(key)) return;
    }

    if (!(key in map)) map[key] = 0;
    if (metric === 'weight') map[key] += toNumber(r[COL.weight]) / 1000;
    else map[key] += 1;
  });
  let labels = Object.keys(map);
  if (labels.length === 0) return { labels: [], values: [] };
  if (agg === 'day') {
    labels.sort((a,b)=> new Date(a) - new Date(b));
  } else {
    labels.sort((a,b)=> MONTH_ORDER.indexOf(a) - MONTH_ORDER.indexOf(b));
  }

  const values = labels.map(k => +map[k].toFixed(2));
  return { labels, values };
}

function updateTimeSeriesChart() {
  const agg = document.getElementById('tsAgg').value;
  const metric = document.getElementById('tsMetric').value;
  const {labels, values} = computeTimeSeries(agg, metric);
  const ctx = document.getElementById('timeSeriesChart').getContext('2d');
  if (timeSeriesChart) timeSeriesChart.destroy();
  timeSeriesChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: metric === 'weight' ? 'الوزن (طن)' : 'عدد الرحلات', data: values, fill: false, borderColor: metric === 'weight' ? '#3b82f6' : '#10b981', tension: 0.2, pointRadius: 3 }]},
    options: { responsive: true, plugins: { legend: { display: false } },
      scales: { x: { title: { display: true, text: agg === 'day' ? 'اليوم' : 'الشهر' } }, y: { title: { display: true, text: metric === 'weight' ? 'طن' : 'رحلة' }, beginAtZero: true } } }
  });
}

/* ===== KPI + Charts ===== */
function updateKPIs() {
  const trips = VIEW.length;
  const totalWkg = VIEW.reduce((s,r)=> s + toNumber(r[COL.weight]), 0);
  const avgWkg = trips ? (totalWkg / trips) : 0;
  const drivers = new Set(VIEW.map(r => r[COL.driver]).filter(Boolean));

  document.getElementById("k_trips").textContent  = trips.toLocaleString();
  document.getElementById("k_weight").textContent = formatTonFromKg(totalWkg) + " طن";
  document.getElementById("k_avg").textContent    = formatTonFromKg(avgWkg) + " طن";
  document.getElementById("k_drivers").textContent= drivers.size.toLocaleString();

  // إجمالي كلفة الوقود (تفاعلي حسب المركبات والشهور)
  const visibleVehicles = new Set(VIEW.map(r => r[COL.vehicle]).filter(Boolean));
  const monthCheckboxes = document.querySelectorAll("#monthDropdownMenu input[type='checkbox']");
  const selectedMonths = Array.from(monthCheckboxes).filter(cb => cb.checked).map(cb => cb.value.toLowerCase());
  let totalFuelCost = 0;
  FUEL.forEach(f => {
    const vnum = String(f["رقم المركبة"] || "").trim();
    if (!vnum || !visibleVehicles.has(vnum)) return;
    const months = ["jan","feb","mar","apr","may","jun","july","aug","sep","oct","nov","dec"];
    months.forEach(m => {
      if (f[m] && (selectedMonths.length === 0 || selectedMonths.includes(m))) {
        totalFuelCost += toNumber(f[m]);
      }
    });
  });
  const fuelNode = document.getElementById("k_totalFuelCost");
  if (fuelNode) fuelNode.textContent = totalFuelCost.toFixed(2);
  // إجمالي كلفة الصيانة (تفاعلي حسب المركبات الظاهرة)
  let totalMaintenanceCost = 0;
  MAINTENANCE.forEach(m => {
    const vnum = String(m["رقم المركبة"] || "").trim();
    if (!vnum || !visibleVehicles.has(vnum)) return;
    if (m["كلفة الصيانة"]) totalMaintenanceCost += toNumber(m["كلفة الصيانة"]);
  });
  const maintNode = document.getElementById("k_totalMaintenanceCost");
  if (maintNode) maintNode.textContent = totalMaintenanceCost.toFixed(2);

  // عدد المركبات
  const vehicleCount = visibleVehicles.size;
  const vehNode = document.getElementById("k_vehicleCount");
  if (vehNode) vehNode.textContent = vehicleCount.toLocaleString();


  const uniqueDays = new Set(VIEW.map(r => r[COL.date]).filter(Boolean));
  const daysCount = uniqueDays.size;
  const avgDailyWeight = daysCount ? (totalWkg/1000) / daysCount : 0;
  const avgDailyTrips = daysCount ? trips / daysCount : 0;

  const monthKeys = new Set();
  VIEW.forEach(r => {
    let key = null;
    if (r[COL.date]) {
      const dt = new Date(r[COL.date]);
      if (!isNaN(dt)) key = toYM(dt);
    }
    if (!key && r[COL.month]) key = String(r[COL.month]).trim();
    if (key) monthKeys.add(key);
  });
  const monthsCount = monthKeys.size;
  const avgMonthlyWeight = monthsCount ? (totalWkg/1000) / monthsCount : 0;
  const avgMonthlyTrips = monthsCount ? trips / monthsCount : 0;

  document.getElementById("k_avgDailyWeight").textContent = avgDailyWeight.toFixed(2);
  document.getElementById("k_avgDailyTrips").textContent  = avgDailyTrips.toFixed(1);
  document.getElementById("k_avgMonthlyWeight").textContent = avgMonthlyWeight.toFixed(2);
  document.getElementById("k_avgMonthlyTrips").textContent  = avgMonthlyTrips.toFixed(1);
  // per vehicle aggregates
  const byVehicleWeight = {};
  const byVehicleTrips  = {};
  const vehicleDrivers  = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle] || "مجهولة";
    const d = r[COL.driver] || "بدون سائق";
    byVehicleWeight[v] = (byVehicleWeight[v] || 0) + toNumber(r[COL.weight]);
    byVehicleTrips[v]  = (byVehicleTrips[v]  || 0) + 1;
    if (!vehicleDrivers[v]) vehicleDrivers[v] = new Set();
    vehicleDrivers[v].add(d);
  });
  // vehicle summary table (if present in DOM)
  updateVehicleSummary(byVehicleTrips, byVehicleWeight, vehicleDrivers);

  // tops
  let topVehicleWeight = "-";
  if (Object.keys(byVehicleWeight).length > 0) {
    topVehicleWeight = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topVehicleWeight").textContent = topVehicleWeight;
  let topVehicleTrips = "-";
  if (Object.keys(byVehicleTrips).length > 0) {
    topVehicleTrips = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topVehicleTrips").textContent = topVehicleTrips;

  // top day by weight
  const byDate = {};
  VIEW.forEach(r => {
    const d = r[COL.date];
    if (!d) return;
    byDate[d] = (byDate[d] || 0) + toNumber(r[COL.weight]);
  });
  let topDay = "-";
  if (Object.keys(byDate).length > 0) {
    topDay = Object.entries(byDate).sort((a,b)=> b[1]-a[1])[0][0];
  }
  document.getElementById("k_topDay").textContent = topDay;

  // charts data
  let weightEntries = Object.entries(byVehicleWeight).sort((a,b)=> b[1]-a[1]);
  let tripEntries   = Object.entries(byVehicleTrips).sort((a,b)=> b[1]-a[1]);

  // local filters Vehicle Weight
  let vwQuery=document.getElementById("vwSearch").value.toLowerCase();
  let vwTopN=parseInt(document.getElementById("vwTopN").value||"10");
  weightEntries=weightEntries.filter(e=>e[0].toLowerCase().includes(vwQuery)).slice(0,vwTopN);
  // local filters Vehicle Trips
  let vtQuery=document.getElementById("vtSearch").value.toLowerCase();
  let vtTopN=parseInt(document.getElementById("vtTopN").value||"10");
  tripEntries=tripEntries.filter(e=>e[0].toLowerCase().includes(vtQuery)).slice(0,vtTopN);

  const labelsWeight = weightEntries.map(e=>e[0]);
  const dataWeightTon = weightEntries.map(e=> (e[1]/1000).toFixed(2));
  const labelsTrips = tripEntries.map(e=>{
    const v = e[0];
    const drivers = Array.from(vehicleDrivers[v]||[]).join(", ");
    return v + " – " + drivers;
  });
  const dataTrips = tripEntries.map(e=> e[1]);

  // toggle chart visibility
  document.getElementById("chartWeightBox").style.display = labelsWeight.length > 1 ? "block" : "none";
  document.getElementById("chartTripsBox").style.display  = labelsTrips.length  > 1 ? "block" : "none";
  // bar chart
  if (labelsWeight.length > 1) {
    if (vehicleWeightChart) vehicleWeightChart.destroy();
    const ctx1 = document.getElementById("vehicleWeightChart").getContext("2d");
    vehicleWeightChart = new Chart(ctx1, {
      type: 'bar',
      data: { labels: labelsWeight, datasets: [{ label: "الوزن الكلي (طن)", data: dataWeightTon, backgroundColor: "rgba(59,130,246,0.7)" }]},
      options: { responsive: true, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx)=> ` ${ctx.parsed.y} طن` }}}, scales: { x: { title: { display: true, text: "المركبة" } }, y: { title: { display: true, text: "الوزن (طن)" } } } }
    });
  }

  // pie chart
  if (labelsTrips.length > 1) {
    if (vehicleTripsChart) vehicleTripsChart.destroy();
    const ctx2 = document.getElementById("vehicleTripsChart").getContext("2d");
    vehicleTripsChart = new Chart(ctx2, {
      type: 'pie',
      data: { labels: labelsTrips, datasets: [{ label: "عدد الرحلات", data: dataTrips, backgroundColor: ["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#84cc16","#d946ef","#fb7185","#22c55e","#a78bfa"] }]},
      options: { responsive: true, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: (ctx) => {
        const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
        const v = ctx.parsed;
        const pct = total ? (v*100/total).toFixed(1) : 0;
        return ` ${ctx.label}: ${v} رحلة (${pct}%)`;
      }}}, datalabels: { color: '#fff', formatter: (value, ctx) => {
        const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
        const percentage = sum ? (value * 100 / sum).toFixed(1) + "%" : "0%";
        return percentage;
      }}}}
    });
  }

  // time series + drivers
  updateTimeSeriesChart();
  updateDriverViews();
}

/* ===== سجل الرحلات + ترقيم الصفحات ===== */
let currentPage = 1;
let pageSize = 25;
function updatePaginationControls(totalPages) {
  document.getElementById("pageIdx").textContent = String(currentPage);
  document.getElementById("pageTotal").textContent = String(totalPages);
  document.getElementById("pageIdx2").textContent = String(currentPage);
  document.getElementById("pageTotal2").textContent = String(totalPages);
}
function updateTable() {
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";
  const totalRows = VIEW.length;
  const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * pageSize;
  const end   = Math.min(start + pageSize, totalRows);
  const rows = VIEW.slice(start, end);
  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-4 py-2">${r[COL.month] || ""}</td>
      <td class="px-4 py-2">${r[COL.date] || ""}</td>
      <td class="px-4 py-2">${r[COL.driver] || ""}</td>
      <td class="px-4 py-2">${formatTonFromKg(toNumber(r[COL.weight]))}</td>
      <td class="px-4 py-2">${r[COL.vehicle] || ""}</td>
    `;
    tb.appendChild(tr);
  });
  updatePaginationControls(totalPages);
}

/* ===== تحليل السائقين ===== */
function getDriverAggregates() {
  const map = {};
  // driver -> { trips, weightTon, vehicles: Set }
  VIEW.forEach(r => {
    const d = r[COL.driver] || 'بدون سائق';
    const v = r[COL.vehicle] || 'مجهولة';
    const w = toNumber(r[COL.weight]) / 1000;
    if (!map[d]) map[d] = { trips: 0, weightTon: 0, vehicles: new Set() };
    map[d].trips += 1;
    map[d].weightTon += w;
    map[d].vehicles.add(v);
  });
  let rows = Object.entries(map).map(([driver, obj]) => ({
    driver,
    trips: obj.trips,
    weightTon: +obj.weightTon.toFixed(2),
    avgTon: obj.trips ? +(obj.weightTon / obj.trips).toFixed(2) : 0,
    vehCount: obj.vehicles.size,
    vehList: Array.from(obj.vehicles).join(', ')
  }));
  const q = document.getElementById('driverSearch').value.toLowerCase();
  if (q) rows = rows.filter(r => r.driver.toLowerCase().includes(q));
  const sortBy = document.getElementById('driverSort').value;
  if (sortBy === 'weight') rows.sort((a,b)=> b.weightTon - a.weightTon);
  else if (sortBy === 'trips') rows.sort((a,b)=> b.trips - a.trips);
  else rows.sort((a,b)=> b.avgTon - a.avgTon);

  const topN = Math.max(1, parseInt(document.getElementById('driverTopN').value || '10', 10));
  return rows.slice(0, topN);
}
function updateDriverChart() {
  const rows = getDriverAggregates();
  const labels = rows.map(r => r.driver);
  const dataTrips = rows.map(r => r.trips);
  const dataWeight = rows.map(r => r.weightTon);
  const ctx = document.getElementById('driverChart').getContext('2d');
  if (driverChart) driverChart.destroy();
  driverChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'رحلات', data: dataTrips, backgroundColor: '#f59e0b', yAxisID: 'y' },
        { label: 'وزن (طن)', data: dataWeight, backgroundColor: '#3b82f6', yAxisID: 'y1' }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } },
      scales: {
        y:  { position: 'left', title: {display:true, text:'رحلات'}, beginAtZero: true },
        y1: { position: 'right', title: {display:true, text:'طن'}, beginAtZero: true, grid: { drawOnChartArea: false } }
      }
    }
  });
}
function updateDriverTable() {
  const rows = getDriverAggregates();
  const tb = document.getElementById('driverTable');
  tb.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.className = 'border-b hover:bg-gray-50';
    tr.innerHTML = `
      <td class="px-4 py-2">${r.driver}</td>
      <td class="px-4 py-2">${r.trips}</td>
      <td class="px-4 py-2">${r.weightTon.toFixed(2)}</td>
      <td class="px-4 py-2">${r.avgTon.toFixed(2)}</td>
      <td class="px-4 py-2">${r.vehCount}</td>
      <td class="px-4 py-2">${r.vehList}</td>
    `;
    tb.appendChild(tr);
  });
}
function updateDriverViews() {
  updateDriverChart();
  updateDriverTable();
}

/* ===== تحميل الشيتات ===== */
async function loadVehSheet(){
  try{
    const result=await new Promise((resolve,reject)=>{
      Papa.parse(VEH_URL,{download:true,header:true,skipEmptyLines:true,complete:resolve,error:reject});
    });
    VEHICLES=result.data;
    vehiclesLoaded = true;
    maybeHideOverlay();
    renderVehAnalysis();
  }catch(e){
    console.error("خطأ تحميل شيت المركبات:",e);
    vehiclesLoaded = true;
    maybeHideOverlay();
  }
}
async function loadFuelSheet(){
  try{
    const result=await new Promise((resolve,reject)=>{
      Papa.parse(FUEL_URL,{download:true,header:true,skipEmptyLines:true,complete:resolve,error:reject});
    });
    FUEL=result.data;
    fuelLoaded = true;
    maybeHideOverlay();
    renderVehAnalysis();
    // تحديث KPIs فور توفر بيانات الوقود
    updateKPIs();
  }catch(e){
    console.error("خطأ تحميل شيت الوقود:",e);
    fuelLoaded = true;
    maybeHideOverlay();
  }
}
async function loadMaintenanceSheet(){
  try{
    const result=await new Promise((resolve,reject)=>{
      Papa.parse(MAINTENANCE_URL,{download:true,header:true,skipEmptyLines:true,complete:resolve,error:reject});
    });
    MAINTENANCE=result.data;
    maintenanceLoaded = true;
    maybeHideOverlay();
    renderVehAnalysis();
  }catch(e){
    console.error("خطأ تحميل شيت الصيانة:",e);
    maintenanceLoaded = true;
    maybeHideOverlay();
  }
}
async function loadData() {
  try {
    const result = await new Promise((resolve, reject) => {
      Papa.parse(CSV_URL, { download: true, header: true, skipEmptyLines: true, complete: resolve, error: reject });
    });
    ALL = result.data.map(row => {
      const obj = {};
      Object.keys(row).forEach(k => {
        const kk = (k || "").trim();
        obj[kk] = (row[k] == null ? "" : String(row[k]).trim());
      });
      return obj;
    });
    dataLoaded = true;
    maybeHideOverlay();
    fillMonthSelect();
    fillVehicleSelect();
    currentPage = 1; // reset pagination
    render();
  } catch (e) {
    console.error("خطأ في جلب/قراءة الشيت:", e);
    dataLoaded = true;
    maybeHideOverlay();
    alert("تعذر تحميل البيانات من الشيت.");
  }
}

/* ===== تعبئة القوائم المتعددة ===== */
function fillMonthSelect() {
  const menu = document.getElementById("monthDropdownMenu");
  menu.innerHTML = "";
  const months = Array.from(new Set(ALL.map(r => r[COL.month]).filter(Boolean)));
  months.forEach(m => {
    const div = document.createElement("div");
    div.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-2";
    div.innerHTML = `
      <input type="checkbox" id="month-${m}" value="${m}" class="form-checkbox h-4 w-4 text-blue-600 rounded">
      <label for="month-${m}" class="text-sm cursor-pointer w-full">${m}</label>
    `;
    menu.appendChild(div);
  });
}
function fillVehicleSelect() {
  const menu = document.getElementById("vehicleDropdownMenu");
  menu.innerHTML = "";
  const vehicles = Array.from(new Set(ALL.map(r => r[COL.vehicle]).filter(Boolean)));
  vehicles.forEach(v => {
    const div = document.createElement("div");
    div.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-2";
    div.innerHTML = `
      <input type="checkbox" id="vehicle-${v}" value="${v}" class="form-checkbox h-4 w-4 text-blue-600 rounded">
      <label for="vehicle-${v}" class="text-sm cursor-pointer w-full">${v}</label>
    `;
    menu.appendChild(div);
  });
}

/* ===== تحليل كفاءة المركبات (من شيت المركبات) ===== */
function renderVehAnalysis(){
  const tb=document.getElementById("vehAnalysisTable");
  if(!tb) return;
  tb.innerHTML="";
  if(VEHICLES.length===0||VIEW.length===0) return;
  // تجميع السائقين لكل مركبة
  const vehicleDrivers  = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle] || "مجهولة";
    const d = r[COL.driver] || "بدون سائق";
    if (!vehicleDrivers[v]) vehicleDrivers[v] = new Set();
    vehicleDrivers[v].add(d);
  });
  const byVehicleWeight={};
  const byVehicleTrips={};
  VIEW.forEach(r=>{
    const v=r[COL.vehicle]||"مجهولة";
    byVehicleWeight[v]=(byVehicleWeight[v]||0)+toNumber(r[COL.weight]);
    byVehicleTrips[v]=(byVehicleTrips[v]||0)+1;
  });
  const vaQuery=document.getElementById("vaSearch").value.toLowerCase();
  const vaYearFilter=parseInt(document.getElementById("vaYear").value||"0");
  const vaSort=document.getElementById("vaSort").value;

  // تجميع كلف الوقود من الشيت
  const fuelMap = {};
  FUEL.forEach(f => {
    const vnum = String(f["رقم المركبة"] || "").trim();
    if (!vnum) return;
    let totalFuelCost = 0;
    const months = ["jan", "feb", "mar", "apr", "may", "jun", "july", "aug", "sep", "oct", "nov", "dec"];
    for (const m of months) {
      if (f[m]) {
        totalFuelCost += toNumber(f[m]);
      }
    }
    fuelMap[vnum] = totalFuelCost;
  });
  // تجميع كلف الصيانة من الشيت
  const maintenanceMap = {};
  MAINTENANCE.forEach(m => {
    const vnum = String(m["رقم المركبة"] || "").trim();
    if (vnum && m["كلفة الصيانة"]) {
      maintenanceMap[vnum] = toNumber(m["كلفة الصيانة"]);
    }
  });
  const vehicleData = [];
  VEHICLES.forEach(vh => {
    const vnum = String(vh["رقم المركبة"]||"");
    const year = parseInt(vh["سنة التصنيع"] || "0");
    const drivers = Array.from(vehicleDrivers[vnum]||[]).join(', ');

    if (vaQuery && !vnum.toLowerCase().includes(vaQuery) && !drivers.toLowerCase().includes(vaQuery)) return;
    if (vaYearFilter && year < vaYearFilter) return;

    const capM3 = toNumber(vh["سعة المركبة بالمتر المكعب"]);
    const dens = toNumber(vh["كثافة التحميل"]);
    const capTon = capM3 * dens;
    const trips = byVehicleTrips[vnum] || 0;
    const wkg = byVehicleWeight[vnum] || 0;
    const wton = wkg / 1000;
    const eff = (trips > 0 && capTon > 0) ? (wton / (trips * capTon)) * 100 : 0;
    const fuelCost = fuelMap[vnum] || 0;
    const maintenanceCost = maintenanceMap[vnum] || 0;
    const totalCost = fuelCost + maintenanceCost;
    const costPerTrip = trips ? totalCost / trips : 0;
    const costPerTon = wton ? totalCost / wton : 0;

    vehicleData.push({ vnum, drivers, year, capM3, capTon, trips, wton, eff, fuelCost, maintenanceCost, costPerTrip, costPerTon });
  });
  vehicleData.sort((a, b) => {
    if (vaSort === "year") return b.year - a.year;
    else if (vaSort === "capTon") return b.capTon - a.capTon;
    else if (vaSort === "fuelCost") return b.fuelCost - a.fuelCost;
    else if (vaSort === "maintenanceCost") return b.maintenanceCost - a.maintenanceCost;
    else if (vaSort === "costPerTrip") return b.costPerTrip - a.costPerTrip;
    else if (vaSort === "costPerTon") return b.costPerTon - a.costPerTon;
    else if (vaSort === "trips") return b.trips - a.trips;
    else if (vaSort === "wton") return b.wton - a.wton;
    else return b.eff - a.eff;
  });
  vehicleData.forEach(row => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-4 py-2">${row.vnum}</td>
      <td class="px-4 py-2">${row.drivers}</td>
      <td class="px-4 py-2">${row.year || "-"}</td>
      <td class="px-4 py-2">${row.capM3.toFixed(1)}</td>
      <td class="px-4 py-2">${row.capTon.toFixed(2)}</td>
      <td class="px-4 py-2">${row.trips}</td>
      <td class="px-4 py-2">${row.wton.toFixed(2)}</td>
      <td class="px-4 py-2">${row.eff.toFixed(1)}%</td>
      <td class="px-4 py-2">${row.fuelCost.toFixed(2)}</td>
      <td class="px-4 py-2">${row.maintenanceCost.toFixed(2)}</td>
      <td class="px-4 py-2">${row.costPerTrip.toFixed(2)}</td>
      <td class="px-4 py-2">${row.costPerTon.toFixed(2)}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== Export Helpers ===== */
function exportCSV() {
  const headers = ['الشهر','تاريخ التوزين الثاني','السائق','صافي التحميل (طن)','رقم المركبة'];
  const rows = VIEW.map(r => [
    r[COL.month] || '',
    r[COL.date] || '',
    r[COL.driver] || '',
    (toNumber(r[COL.weight])/1000).toFixed(2),
    r[COL.vehicle] || ''
  ]);
  const csv = [headers.join(','), ...rows.map(a=>a.join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'trips.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function buildVehicleSummaryArray() {
  const byVehicleWeight = {};
  const byVehicleTrips  = {};
  const vehicleDrivers  = {};
  VIEW.forEach(r => {
    const v = r[COL.vehicle] || 'مجهولة';
    const d = r[COL.driver] || 'بدون سائق';
    byVehicleWeight[v] = (byVehicleWeight[v] || 0) + toNumber(r[COL.weight]);
    byVehicleTrips[v]  = (byVehicleTrips[v]  || 0) + 1;
    if (!vehicleDrivers[v]) vehicleDrivers[v] = new Set();
    vehicleDrivers[v].add(d);
  });
  const vehiclesSet = new Set([...Object.keys(byVehicleTrips), ...Object.keys(byVehicleWeight)]);
  const summary = Array.from(vehiclesSet).map(v => ({
    'رقم المركبة': v,
    'السائقين': Array.from(vehicleDrivers[v] || []).join(', '),
    'عدد الرحلات': byVehicleTrips[v] || 0,
    'إجمالي الوزن (طن)': ((byVehicleWeight[v] || 0)/1000).toFixed(2)
  }));
  return summary;
}
function exportXLSX() {
  const trips = VIEW.map(r => ({
    'الشهر': r[COL.month] || '',
    'تاريخ التوزين الثاني': r[COL.date] || '',
    'السائق': r[COL.driver] || '',
    'صافي التحميل (طن)': (toNumber(r[COL.weight])/1000).toFixed(2),
    'رقم المركبة': r[COL.vehicle] || ''
  }));
  const wb = XLSX.utils.book_new();
  const ws1 = XLSX.utils.json_to_sheet(trips);
  XLSX.utils.book_append_sheet(wb, ws1, 'سجل الرحلات');
  const ws2 = XLSX.utils.json_to_sheet(buildVehicleSummaryArray());
  XLSX.utils.book_append_sheet(wb, ws2, 'ملخص المركبات');
  XLSX.writeFile(wb, 'transport_dashboard.xlsx');
}
async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'pt', 'a4');
  const node = document.getElementById('rawTripsBox');
  const canvas = await html2canvas(node, {scale: 2});
  const imgData = canvas.toDataURL('image/png');
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const imgWidth = pageWidth - 40;
  const imgHeight = canvas.height * (imgWidth / canvas.width);
  if (imgHeight < pageHeight - 40) {
    doc.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
  } else {
    let remaining = imgHeight;
    const pageHeightPx = canvas.height * ((pageHeight - 40) / imgHeight);
    while (remaining > 0) {
      const sectionCanvas = document.createElement('canvas');
      sectionCanvas.width = canvas.width;
      sectionCanvas.height = Math.min(pageHeightPx, remaining);
      const ctx = sectionCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, canvas.height - remaining, canvas.width, sectionCanvas.height, 0, 0, sectionCanvas.width, sectionCanvas.height);
      const sectionImg = sectionCanvas.toDataURL('image/png');
      doc.addImage(sectionImg, 'PNG', 20, 20, imgWidth, (sectionCanvas.height * (imgWidth / sectionCanvas.width)));
      remaining -= pageHeightPx;
      if (remaining > 0) doc.addPage();
    }
  }
  doc.save('trips.pdf');
}

/* ===== أحداث ===== */
// فلاتر عامة
document.getElementById("q").addEventListener("input", ()=>{ currentPage=1; render(); });
document.getElementById("dateExact").addEventListener("change", ()=>{ currentPage=1; render(); });
document.getElementById("resetBtn").addEventListener("click", () => {
  document.getElementById("q").value = "";
  document.getElementById("dateExact").value = "";
  document.querySelectorAll("#monthDropdownMenu input[type='checkbox']").forEach(o=>o.checked=false);
  document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']").forEach(o=>o.checked=false);
  updateDropdownButtonText('monthDropdownMenu', 'monthDropdownBtn', 'الشهور');
  updateDropdownButtonText('vehicleDropdownMenu', 'vehicleDropdownBtn', 'المركبات');
  currentPage = 1;
  render();
});
document.getElementById("refreshBtn").addEventListener("click", () => { setLoading(true); dataLoaded=false; vehiclesLoaded=false; fuelLoaded=false; maintenanceLoaded=false; loadData(); loadVehSheet(); loadFuelSheet(); loadMaintenanceSheet(); });

// سلاسل زمنية
document.getElementById('tsAgg').addEventListener('change', updateTimeSeriesChart);
document.getElementById('tsMetric').addEventListener('change', updateTimeSeriesChart);
// أزرار تصدير
document.getElementById('btnCSV').addEventListener('click', exportCSV);
document.getElementById('btnXLSX').addEventListener('click', exportXLSX);
document.getElementById('btnPDF').addEventListener('click', exportPDF);
document.getElementById('btnDriversCSV').addEventListener('click', ()=>{
  const rows = getDriverAggregates();
  const headers = ['السائق','عدد الرحلات','الوزن (طن)','متوسط/رحلة (طن)','عدد المركبات','المركبات'];
  const csv = [headers.join(','), ...rows.map(r=>[r.driver,r.trips,r.weightTon,r.avgTon,r.vehCount,`"${r.vehList.replace(/"/g,'""')}"`].join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'drivers_analysis.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// تحليل المركبات
document.getElementById('vaSearch').addEventListener('input',()=>{ renderVehAnalysis(); });
document.getElementById('vaYear').addEventListener('input',()=>{ renderVehAnalysis(); });
document.getElementById('vaSort').addEventListener('change', ()=>{ renderVehAnalysis(); });

// تحليل السائقين
document.getElementById('driverSort').addEventListener('change', updateDriverViews);
document.getElementById('driverTopN').addEventListener('input', updateDriverViews);
document.getElementById('driverSearch').addEventListener('input', updateDriverViews);

// ترقيم الصفحات
document.getElementById('prevPage').addEventListener('click', ()=>{ if (currentPage>1){ currentPage--; updateTable(); } });
document.getElementById('nextPage').addEventListener('click', ()=>{ const totalPages=Math.max(1, Math.ceil(VIEW.length / pageSize)); if (currentPage<totalPages){ currentPage++; updateTable(); } });
document.getElementById('prevPage2').addEventListener('click', ()=>{ if (currentPage>1){ currentPage--; updateTable(); } });
document.getElementById('nextPage2').addEventListener('click', ()=>{ const totalPages=Math.max(1, Math.ceil(VIEW.length / pageSize)); if (currentPage<totalPages){ currentPage++; updateTable(); } });
document.getElementById('pageSize').addEventListener('change', (e)=>{ pageSize=parseInt(e.target.value||'25',10); currentPage=1; updateTable(); });

/* ===== قوائم منسدلة جديدة ===== */
function updateDropdownButtonText(menuId, buttonId, labelText) {
  const menu = document.getElementById(menuId);
  const button = document.getElementById(buttonId);
  const selectedCheckboxes = Array.from(menu.querySelectorAll("input[type='checkbox']:checked"));
  if (selectedCheckboxes.length === 0) {
    button.textContent = `اختر ${labelText}...`;
  } else if (selectedCheckboxes.length === menu.querySelectorAll("input[type='checkbox']").length) {
    button.textContent = `كل ${labelText}`;
  } else {
    button.textContent = `${selectedCheckboxes.length} ${labelText} مختار`;
  }
}

document.getElementById('monthDropdownBtn').addEventListener('click', (e) => {
  e.stopPropagation();
  const menu = document.getElementById('monthDropdownMenu');
  menu.classList.toggle('hidden');
});
document.getElementById('vehicleDropdownBtn').addEventListener('click', (e) => {
  e.stopPropagation();
  const menu = document.getElementById('vehicleDropdownMenu');
  menu.classList.toggle('hidden');
});
// إخفاء القوائم عند النقر خارجها
window.addEventListener('click', (e) => {
  if (!document.getElementById('monthDropdownBtn').contains(e.target)) {
    document.getElementById('monthDropdownMenu').classList.add('hidden');
  }
  if (!document.getElementById('vehicleDropdownBtn').contains(e.target)) {
    document.getElementById('vehicleDropdownMenu').classList.add('hidden');
  }
});
// تحديث نص الأزرار عند تغيير الاختيار
document.getElementById('monthDropdownMenu').addEventListener('change', () => {
  updateDropdownButtonText('monthDropdownMenu', 'monthDropdownBtn', 'الشهور');
  render();
});
document.getElementById('vehicleDropdownMenu').addEventListener('change', () => {
  updateDropdownButtonText('vehicleDropdownMenu', 'vehicleDropdownBtn', 'المركبات');
  render();
});
// تعديل وظائف تحديد الكل ومسح الكل
document.getElementById('monthSelectAll').addEventListener('click', () => {
  document.querySelectorAll("#monthDropdownMenu input[type='checkbox']").forEach(cb => cb.checked = true);
  updateDropdownButtonText('monthDropdownMenu', 'monthDropdownBtn', 'الشهور');
  render();
});
document.getElementById('monthClearAll').addEventListener('click', () => {
  document.querySelectorAll("#monthDropdownMenu input[type='checkbox']").forEach(cb => cb.checked = false);
  updateDropdownButtonText('monthDropdownMenu', 'monthDropdownBtn', 'الشهور');
  render();
});
document.getElementById('vehSelectAll').addEventListener('click', () => {
  document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']").forEach(cb => cb.checked = true);
  updateDropdownButtonText('vehicleDropdownMenu', 'vehicleDropdownBtn', 'المركبات');
  render();
});
document.getElementById('vehClearAll').addEventListener('click', () => {
  document.querySelectorAll("#vehicleDropdownMenu input[type='checkbox']").forEach(cb => cb.checked = false);
  updateDropdownButtonText('vehicleDropdownMenu', 'vehicleDropdownBtn', 'المركبات');
  render();
});
/* ===== Render شامل ===== */
function render() {
  applyFilters();
  updateKPIs();
  updateTable();
  renderVehAnalysis();
}

/* تسجيل بلجن الداتا ليبلز */
if (window.ChartDataLabels) { Chart.register(ChartDataLabels); }


function toggleSection(id) {
  const el = document.getElementById(id);
  const btn = document.getElementById("btn-" + id);
  const isHidden = el.classList.contains("hidden");
  el.classList.toggle("hidden");
  if (btn) btn.textContent = isHidden ? "▼" : "▶";
}

/* ===== Start ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  setLoading(true);
  loadData();
  loadVehSheet();
  loadFuelSheet();
  loadMaintenanceSheet();
});
</script>
</body>
</html>
